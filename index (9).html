<!DOCTYPE html>
<!-- Energy Desk v3.5 — Build 2026-02-25 — Clock/Market/OTC/Chat/Feed -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ARM Energy — Energy Trading Terminal</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icon.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* =====================================================================
   RESET & THEME SYSTEM
   ===================================================================== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e14;--surface:#0f1520;--surface2:#141e2e;--border:#1e2d3d;--border2:#243547;
  --text:#e2e8f0;--text-dim:#94a3b8;--text-muted:#475569;
  --accent:#22d3ee;--accent2:#06b6d4;--green:#10b981;--red:#ef4444;--amber:#f59e0b;
  --font-mono:'IBM Plex Mono',monospace;--font-sans:'IBM Plex Sans',sans-serif;
  --radius:8px;--transition:0.2s ease;
}
[data-theme="medium"]{
  --bg:#1a1f2e;--surface:#242938;--surface2:#2d3344;--border:#3d4455;--border2:#4d5566;
  --text:#e2e8f0;--text-dim:#a0aec0;--text-muted:#718096;
}
[data-theme="light"]{
  --bg:#f1f5f9;--surface:#ffffff;--surface2:#f8fafc;--border:#e2e8f0;--border2:#cbd5e1;
  --text:#1e293b;--text-dim:#475569;--text-muted:#94a3b8;
}
html{scrollbar-color:var(--border) var(--bg)}
body{font-family:var(--font-sans);background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;overflow-x:hidden}

/* =====================================================================
   HEADER
   ===================================================================== */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:200;
}
.header-left{display:flex;align-items:center;gap:12px}
.logo{font-family:var(--font-mono);font-size:20px;font-weight:700;letter-spacing:-0.5px}
.logo-energy{color:var(--accent)}.logo-desk{color:var(--text-dim)}
.sim-badge{background:rgba(245,158,11,0.15);color:var(--amber);font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:1px}
.conn-badge{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:4px;background:var(--surface2);border:1px solid var(--border)}
.conn-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.conn-dot.online{background:var(--green)}.conn-dot.reconnecting{background:var(--amber);animation:pulse 1s infinite}.conn-dot.offline{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.header-right{display:flex;align-items:center;gap:8px}
.hdr-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:6px 12px;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all var(--transition);display:flex;align-items:center;gap:6px}
.hdr-btn:hover{border-color:var(--accent);color:var(--text)}
.hdr-btn svg{width:16px;height:16px}
.profile-chip{display:flex;align-items:center;gap:8px;padding:4px 12px 4px 4px;border:1px solid var(--border);border-radius:20px;cursor:pointer;background:transparent;color:var(--text);font-family:inherit;font-size:13px;transition:all var(--transition);white-space:nowrap}
.profile-chip:hover{border-color:var(--accent);background:var(--surface2)}
.profile-chip .chip-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;background:var(--accent);overflow:hidden;flex-shrink:0}
.profile-chip .chip-avatar img{width:100%;height:100%;object-fit:cover}
.profile-chip .chip-name{font-weight:600}
.profile-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;align-items:center;justify-content:center}
.profile-modal-overlay.active{display:flex}
.profile-modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:380px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.profile-modal-header{display:flex;align-items:center;gap:16px;padding:24px 24px 16px}
.profile-modal-avatar{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0}
.profile-modal-avatar img{width:100%;height:100%;object-fit:cover}
.profile-modal-name{font-size:18px;font-weight:700;color:var(--text)}
.profile-modal-firm{font-size:13px;color:var(--text-muted);margin-top:2px}
.profile-modal-badge{display:inline-block;font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;margin-top:6px}
.profile-modal-stats{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);margin:0 24px 16px;border-radius:8px;overflow:hidden}
.profile-stat{background:var(--surface);padding:14px;text-align:center}
.profile-stat-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.profile-stat-value{font-size:18px;font-weight:700;margin-top:4px;font-family:var(--font-mono)}
.profile-modal-close{position:absolute;top:16px;right:16px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:20px;padding:4px 8px;border-radius:4px}
.profile-modal-close:hover{color:var(--text);background:var(--surface2)}
.profile-modal-rank-badge{font-size:13px;color:var(--text-muted);margin-top:2px}
.lb-clickable{cursor:pointer;transition:background 0.15s}
.lb-clickable:hover{background:var(--surface2)}
.toggle-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text-dim);transition:all 0.15s;user-select:none}
.toggle-chip.active{background:var(--surface2);color:var(--text);border-color:var(--text-muted)}
.toggle-chip .chip-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.toggle-chip.inactive .chip-dot{opacity:0.3}
/* Clock & Market Status */
.clock-wrap{display:flex;align-items:center;gap:8px;margin-right:8px;font-family:'IBM Plex Mono',monospace}
.clock-time{font-size:13px;font-weight:600;color:var(--text);line-height:1.1}
.clock-label{font-size:9px;color:var(--text-muted);text-transform:uppercase}
.mkt-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;letter-spacing:0.5px;cursor:pointer}
.mkt-open{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)}
.mkt-closed{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
/* Chat Panel */
.chat-tab{position:fixed;right:0;top:50%;transform:translateY(-50%);writing-mode:vertical-rl;padding:12px 6px;background:var(--surface2);border:1px solid var(--border);border-right:none;border-radius:8px 0 0 8px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text-dim);z-index:200;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.chat-tab:hover{background:var(--accent);color:#fff}
.chat-tab .unread-dot{width:8px;height:8px;border-radius:50%;background:#ef4444;display:none;writing-mode:horizontal-tb}
.chat-panel{position:fixed;right:-360px;top:0;bottom:0;width:350px;background:var(--surface);border-left:1px solid var(--border);z-index:300;display:flex;flex-direction:column;transition:right 0.3s ease;box-shadow:-4px 0 24px rgba(0,0,0,0.3)}
.chat-panel.open{right:0}
.chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.chat-header h3{margin:0;font-size:15px;font-weight:700}
.chat-convos{flex:1;overflow-y:auto;padding:8px}
.chat-convo-item{padding:10px 12px;border-radius:8px;cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:10px;margin-bottom:2px}
.chat-convo-item:hover{background:var(--surface2)}
.chat-convo-item.active{background:var(--surface2);border-left:2px solid var(--accent)}
.chat-convo-item.unread .convo-name{font-weight:700}
.convo-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.convo-info{flex:1;min-width:0}
.convo-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.convo-preview{font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.convo-meta{font-size:10px;color:var(--text-muted);display:flex;flex-direction:column;align-items:flex-end;gap:2px;flex-shrink:0}
.convo-unread{background:#ef4444;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
.chat-messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:6px}
.chat-msg{max-width:85%}
.chat-msg.me{align-self:flex-end}
.chat-msg.me .msg-bubble{background:var(--accent);color:#fff;border-radius:12px 12px 4px 12px}
.chat-msg.other{align-self:flex-start}
.chat-msg.other .msg-bubble{background:var(--surface2);color:var(--text);border-radius:12px 12px 12px 4px}
.msg-sender{font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:2px;display:flex;align-items:center;gap:4px}
.msg-bubble{padding:8px 12px;font-size:13px;line-height:1.4;word-break:break-word}
.msg-time{font-size:9px;color:var(--text-muted);margin-top:2px}
.chat-input-wrap{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
.chat-input-wrap input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:8px 14px;color:var(--text);font-size:13px;outline:none}
.chat-input-wrap input:focus{border-color:var(--accent)}
.chat-input-wrap button{background:var(--accent);color:#fff;border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.chat-back-btn{background:none;border:none;color:var(--text-dim);cursor:pointer;padding:4px;display:flex}
.chat-new-btn{background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;font-weight:600}
/* Trade Feed Ticker */
.trade-feed-bar{background:var(--bg);border-bottom:1px solid var(--border);padding:4px 16px;font-size:11px;color:var(--text-muted);overflow:hidden;white-space:nowrap;display:flex;align-items:center;gap:8px}
.feed-label{font-weight:700;color:var(--accent);flex-shrink:0}
.feed-scroll{overflow:hidden;flex:1}
.feed-scroll-inner{display:inline-block;animation:feedScroll 30s linear infinite}
@keyframes feedScroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.feed-item{display:inline;margin-right:24px}
/* Calendar Modal */
.cal-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:none;align-items:center;justify-content:center}
.cal-modal.show{display:flex}
.cal-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;width:340px;max-width:90vw}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-nav button{background:none;border:none;color:var(--text);cursor:pointer;font-size:18px;padding:4px 8px}
.cal-nav span{font-weight:700;font-size:15px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
.cal-grid .cal-day-hdr{font-size:10px;color:var(--text-muted);padding:4px 0;font-weight:700}
.cal-grid .cal-day{padding:6px 4px;border-radius:6px;font-size:12px;cursor:default}
.cal-grid .cal-day.today{background:var(--accent);color:#fff;font-weight:700}
.cal-grid .cal-day.holiday{background:rgba(239,68,68,0.2);color:#ef4444;font-weight:600}
.cal-grid .cal-day.weekend{color:var(--text-muted)}
.cal-legend{margin-top:12px;display:flex;gap:16px;font-size:11px;color:var(--text-muted)}
.cal-legend span{display:flex;align-items:center;gap:4px}
.cal-legend .dot{width:8px;height:8px;border-radius:50%}
/* OTC controls */
.otc-toggle{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border-radius:8px;margin-bottom:8px}
.otc-toggle label{font-size:12px;font-weight:600;color:var(--text-dim)}
.otc-switch{position:relative;width:36px;height:20px;cursor:pointer}
.otc-switch input{opacity:0;width:0;height:0}
.otc-switch .slider{position:absolute;inset:0;background:var(--border);border-radius:20px;transition:0.2s}
.otc-switch .slider:before{content:'';position:absolute;left:2px;bottom:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:0.2s}
.otc-switch input:checked+.slider{background:var(--green)}
.otc-switch input:checked+.slider:before{transform:translateX(16px)}

/* =====================================================================
   TAB NAVIGATION
   ===================================================================== */
.tab-nav{
  display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.tab-btn{
  padding:12px 20px;font-family:inherit;font-size:13px;font-weight:500;
  color:var(--text-muted);background:none;border:none;border-bottom:2px solid transparent;
  cursor:pointer;transition:all var(--transition);white-space:nowrap;
}
.tab-btn:hover{color:var(--text-dim)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}

/* =====================================================================
   MAIN CONTENT AREA
   ===================================================================== */
.page-container{padding:20px;max-width:1600px;margin:0 auto}
.page{display:none}.page.active{display:block}

/* =====================================================================
   CARDS, GRIDS, WIDGETS
   ===================================================================== */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden}
.card-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:14px;font-weight:600}
.card-body{padding:16px}

/* Benchmark Grid */
.bench-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;margin-bottom:16px}
.bench-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px;cursor:pointer;transition:all var(--transition);position:relative;overflow:hidden;
}
.bench-card:hover{border-color:var(--border2);transform:translateY(-1px)}
.bench-card.selected{border-color:var(--accent);box-shadow:0 0 12px rgba(34,211,238,0.15)}
.bench-card .hub-name{font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bench-card .hub-price{font-size:20px;font-weight:700;font-family:var(--font-mono)}
.bench-card .hub-change{font-size:12px;font-family:var(--font-mono);margin-top:2px}
.bench-card .hub-change.up{color:var(--green)}.bench-card .hub-change.down{color:var(--red)}
.bench-card .sparkline{margin-top:6px;height:24px}

/* Hub Toggle Bar */
.hub-toggle-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.hub-toggle{
  font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer;
  background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);
  font-family:inherit;transition:all var(--transition);
}
.hub-toggle.on{background:var(--accent);color:#000;border-color:var(--accent)}

/* Chart Container */
.chart-container{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden}
.chart-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.chart-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.chart-range-btns{display:flex;gap:4px}
.range-btn{
  font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer;
  background:transparent;border:1px solid var(--border);color:var(--text-dim);
  font-family:inherit;transition:all var(--transition);
}
.range-btn:hover{border-color:var(--text-dim)}.range-btn.active{background:var(--accent);color:#000;border-color:var(--accent)}
.chart-canvas-wrap{position:relative;padding:8px}
.chart-canvas-wrap canvas{width:100%;height:300px;display:block}
.info-btn{
  background:transparent;border:1px solid var(--border);color:var(--text-dim);
  width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;transition:all var(--transition);
}
.info-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Tables */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 12px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:8px 12px;border-bottom:1px solid var(--border)}
tr:hover td{background:var(--surface2)}
.mono{font-family:var(--font-mono)}
.green{color:var(--green)}.red{color:var(--red)}.amber{color:var(--amber)}

/* News Grid */
.news-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:16px}
.news-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px;cursor:pointer;transition:all var(--transition);
}
.news-card:hover{border-color:var(--border2)}
.news-source{font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.news-headline{font-size:13px;font-weight:600;margin-bottom:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.news-desc{font-size:12px;color:var(--text-dim);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.news-time{font-size:11px;color:var(--text-muted);margin-top:6px}

/* EIA Widget */
.eia-widget{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.eia-title{font-size:14px;font-weight:600;margin-bottom:12px}
.eia-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.eia-item .eia-label{font-size:11px;color:var(--text-muted);text-transform:uppercase}
.eia-item .eia-value{font-size:18px;font-weight:700;font-family:var(--font-mono)}

/* Calendar */
.calendar-list{display:flex;flex-direction:column;gap:8px}
.cal-item{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.cal-date{font-size:12px;color:var(--text-dim);min-width:70px;font-family:var(--font-mono)}
.cal-name{font-size:13px;flex:1}
.cal-impact{font-size:10px;font-weight:700;padding:2px 8px;border-radius:3px;letter-spacing:0.5px}
.cal-impact.high{background:rgba(239,68,68,0.15);color:var(--red)}
.cal-impact.medium{background:rgba(245,158,11,0.15);color:var(--amber)}
.cal-impact.low{background:rgba(34,211,238,0.15);color:var(--accent)}
.cal-days{font-size:11px;color:var(--text-muted);min-width:50px;text-align:right}

/* Section Headers */
.section-header{font-size:16px;font-weight:700;margin:20px 0 12px;display:flex;align-items:center;gap:8px}

/* =====================================================================
   BUTTONS & FORMS
   ===================================================================== */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:6px;font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;transition:all var(--transition);white-space:nowrap}
.btn-primary{background:var(--accent);color:#000}.btn-primary:hover{background:var(--accent2)}
.btn-success{background:var(--green);color:#fff}.btn-danger{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim)}.btn-ghost:hover{border-color:var(--text-dim);color:var(--text)}
.btn-sm{padding:4px 10px;font-size:12px}
input,select,textarea{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:border-color var(--transition)}
input:focus,select:focus{border-color:var(--accent)}

/* =====================================================================
   SLIDE PANELS (Settings, Help, Hub Info)
   ===================================================================== */
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:none;opacity:0;transition:opacity 0.3s}
.panel-overlay.active{display:block;opacity:1}
.slide-panel{
  position:fixed;top:0;bottom:0;width:420px;max-width:90vw;
  background:var(--surface);border-left:1px solid var(--border);
  z-index:501;transform:translateX(100%);transition:transform 0.3s ease;
  display:flex;flex-direction:column;overflow-y:auto;
}
.slide-panel.left{left:0;right:auto;border-left:none;border-right:1px solid var(--border);transform:translateX(-100%)}
.slide-panel.active{transform:translateX(0)}
.slide-panel.right{right:0}
.panel-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.panel-header h2{font-size:18px;font-weight:700}
.panel-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.panel-close:hover{color:var(--text);background:var(--surface2)}
.panel-body{padding:20px;flex:1;overflow-y:auto}
.panel-section{margin-bottom:24px}
.panel-section h3{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--accent)}
.panel-section p{font-size:13px;color:var(--text-dim);line-height:1.6;margin-bottom:8px}
.form-group{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.form-group label{font-size:12px;color:var(--text-dim);font-weight:500}

/* =====================================================================
   REGISTRATION OVERLAY
   ===================================================================== */
.reg-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
.reg-overlay.hidden{display:none}
.reg-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:40px;width:90%;max-width:440px}
.reg-box .logo{font-size:28px;text-align:center;margin-bottom:8px}
.reg-box .subtitle{color:var(--text-dim);font-size:14px;text-align:center;margin-bottom:24px}
.reg-box .btn{width:100%;justify-content:center;padding:12px;font-size:15px;margin-top:8px}
.reg-error{color:var(--red);font-size:13px;text-align:center;margin-top:8px;display:none}

/* =====================================================================
   MODAL
   ===================================================================== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:90%;max-width:500px;padding:24px}
.modal h3{font-size:18px;margin-bottom:8px}
.modal p{color:var(--text-dim);font-size:14px;margin-bottom:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}

/* =====================================================================
   TOAST
   ===================================================================== */
.toast-container{position:fixed;top:16px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 16px;font-size:13px;display:flex;align-items:center;gap:8px;
  animation:toastIn 0.3s ease;max-width:360px;pointer-events:auto;
}
.toast.success{border-left:3px solid var(--green)}.toast.error{border-left:3px solid var(--red)}.toast.info{border-left:3px solid var(--accent)}
@keyframes toastIn{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}

/* Session timeout banner */
.timeout-banner{
  display:none;position:fixed;top:0;left:0;right:0;z-index:300;
  background:var(--amber);color:#000;text-align:center;padding:8px;
  font-size:13px;font-weight:500;cursor:pointer;
}
.timeout-banner.active{display:block}

/* =====================================================================
   PIPELINE MAP
   ===================================================================== */
.map-section{margin-bottom:12px}
.map-toggle-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text-dim);font-family:inherit;font-size:13px;cursor:pointer;transition:all 0.2s ease}
.map-toggle-btn:hover{border-color:var(--accent);color:var(--text)}
.map-toggle-btn svg{flex-shrink:0}
.map-container{margin-top:10px}
.pipeline-map-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.pipeline-map-card .card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:14px;font-weight:600}
.pipeline-map-wrap{padding:12px;overflow:hidden;position:relative;cursor:grab}
.pipeline-map-wrap.dragging{cursor:grabbing}
.pipeline-map-wrap svg{display:block;margin:0 auto}
.map-zoom-controls{display:flex;gap:4px;margin-right:8px}
.map-zoom-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
.map-zoom-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.map-zoom-level{font-size:11px;color:var(--text-muted);display:flex;align-items:center;padding:0 4px;font-family:var(--font-mono)}
.pipeline-map-wrap svg .land{fill:var(--surface2);stroke:var(--border);stroke-width:1}
.pipeline-map-wrap svg .water{fill:var(--bg)}
.pipeline-map-wrap svg .pipe{fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;opacity:0.5}
.pipeline-map-wrap svg .pipe:hover{opacity:1;stroke-width:3.5}
.pipeline-map-wrap svg .pipe-label{font-size:7px;font-family:var(--font-sans);fill:var(--text-muted);pointer-events:none}
.pipeline-map-wrap svg .hub-dot{cursor:pointer;transition:r 0.15s ease}
.pipeline-map-wrap svg .hub-dot:hover{r:7}
.pipeline-map-wrap svg .hub-label{font-size:7.5px;font-family:var(--font-mono);fill:var(--text-dim);pointer-events:none}
.pipeline-map-wrap svg .hub-price-label{font-size:7px;font-family:var(--font-mono);fill:var(--text);pointer-events:none;font-weight:600}
.map-legend{display:flex;flex-wrap:wrap;gap:12px;padding:10px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim)}
.map-legend-item{display:flex;align-items:center;gap:5px}
.map-legend-line{width:20px;height:3px;border-radius:2px}

/* =====================================================================
   RESPONSIVE
   ===================================================================== */
/* Info popovers */
.info-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:11px;font-weight:700;cursor:pointer;margin-left:8px;font-family:var(--font-sans);transition:all 0.15s;vertical-align:middle;line-height:1}
.info-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.info-popover{display:none;position:fixed;z-index:9999;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;width:400px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,0.5);font-size:12px;line-height:1.6;color:var(--text)}
.info-popover.active{display:block}
.info-popover h4{font-size:13px;font-weight:700;margin:0 0 8px;color:var(--text)}
.info-popover .info-row{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
.info-popover .info-row:last-child{border-bottom:none}
.info-popover .info-label{font-weight:700;color:var(--accent);min-width:90px;flex-shrink:0}
.info-popover .info-desc{color:var(--text-dim)}
.info-popover code{background:var(--bg);padding:1px 4px;border-radius:3px;font-family:var(--font-mono);font-size:11px}
@media(max-width:900px){
  .bench-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .news-grid{grid-template-columns:1fr}
  .eia-grid{grid-template-columns:repeat(2,1fr)}
  .header{padding:10px 12px}
  .tab-nav{padding:0 10px}
  .tab-btn{padding:10px 14px;font-size:12px}
  .page-container{padding:12px}
  .risk-positions-grid{grid-template-columns:1fr!important}
}
@media(max-width:600px){
  .bench-grid{grid-template-columns:repeat(2,1fr)}
  .header-left .conn-badge span.conn-label{display:none}
  .slide-panel{width:100%;max-width:100%}
  .mobile-fab{display:flex!important}
  .profile-chip .chip-name{display:none}
  .profile-chip{padding:4px}
  .clock-wrap .clock-label{display:none}
  .clock-wrap{margin-right:4px}
  .mkt-badge{font-size:8px;padding:2px 4px}
  .chat-panel{width:100%;right:-100%}
  .trade-feed-bar{font-size:10px;padding:3px 8px}
}
/* Percentile bars */
.pct-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.pct-label{width:100px;font-size:12px;color:var(--text-dim);flex-shrink:0}
.pct-value{width:70px;font-family:var(--font-mono);font-size:13px;font-weight:600;flex-shrink:0}
.pct-bar-wrap{flex:1;height:20px;background:var(--surface2);border-radius:4px;overflow:hidden;position:relative}
.pct-bar{height:100%;background:var(--accent);border-radius:4px;transition:width 0.5s ease}
.pct-rank{width:70px;font-size:12px;color:var(--accent);font-weight:600;text-align:right;flex-shrink:0}
/* Leaderboard avatars */
.lb-avatar{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden;vertical-align:middle}
.lb-avatar img{width:100%;height:100%;object-fit:cover}
.lb-team-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;flex-shrink:0}
.lb-highlight td{border-left:3px solid var(--accent)}
/* Mobile FAB */
.mobile-fab{display:none;position:fixed;bottom:20px;right:20px;z-index:350;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#000;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);align-items:center;justify-content:center;font-size:24px}
/* Logo image */
.logo-img{height:36px;display:block}
.logo-img-sm{height:28px;display:block}
[data-theme="medium"] .logo-img,[data-theme="medium"] .logo-img-sm{filter:drop-shadow(0 0 1px rgba(255,255,255,0.6))}
:root .logo-img,:root .logo-img-sm{filter:drop-shadow(0 0 1px rgba(255,255,255,0.6))}
[data-theme="light"] .logo-img,[data-theme="light"] .logo-img-sm{filter:none}
</style>
</head>
<body>

<!-- SESSION TIMEOUT BANNER -->
<div class="timeout-banner" id="timeoutBanner" onclick="dismissTimeout()">Session idle for 30+ minutes — prices may be stale. Click to refresh.</div>

<!-- =====================================================================
     REGISTRATION OVERLAY
     ===================================================================== -->
<div class="reg-overlay" id="regOverlay">
  <div class="reg-box">
    <div style="text-align:center;margin-bottom:8px"><img class="logo-img" id="regLogo" alt="ARM Energy" src="data:image/png;base64,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" style="margin:0 auto;height:60px"></div>
    <div class="subtitle">Energy Trading Terminal</div>
    <div class="form-group"><label>Your Name</label><input id="regName" placeholder="As given by your admin"></div>
    <div class="form-group"><label>4-Digit PIN</label><input id="regPin" maxlength="4" placeholder="From your admin" style="letter-spacing:6px;text-align:center;font-family:var(--font-mono)"></div>
    <button class="btn btn-primary" onclick="doLogin()">Log In</button>
    <div class="reg-error" id="regError"></div>
  </div>
</div>

<!-- =====================================================================
     HEADER
     ===================================================================== -->
<header class="header">
  <div class="header-left">
    <img class="logo-img" id="headerLogo" alt="ARM Energy" src="data:image/png;base64,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">
    <span class="sim-badge">SIMULATED</span>
    <div class="conn-badge" id="connBadge">
      <span class="conn-dot offline" id="connDot"></span>
      <span id="connText" class="conn-label">OFFLINE</span>
    </div>
  </div>
  <div class="header-right">
    <div class="clock-wrap" id="clockWrap" style="display:none">
      <div>
        <div class="clock-time" id="clockTime">--:--:--</div>
        <div class="clock-label">CT</div>
      </div>
      <span class="mkt-badge mkt-closed" id="mktBadge" onclick="openCalendar()" title="Click for trading calendar">CLOSED</span>
    </div>
    <button class="profile-chip" id="headerProfile" onclick="showMyProfile()" style="display:none">
      <div class="chip-avatar" id="headerAvatar"></div>
      <span class="chip-name" id="headerName"></span>
    </button>
    <button class="hdr-btn" onclick="openPanel('help')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Help
    </button>
    <button class="hdr-btn" onclick="openPanel('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
  </div>
</header>

<!-- TRADE FEED TICKER -->
<div class="trade-feed-bar" id="tradeFeedBar" style="display:none">
  <span class="feed-label">FEED</span>
  <div class="feed-scroll"><div class="feed-scroll-inner" id="feedScrollInner">Loading activity...</div></div>
</div>

<!-- =====================================================================
     TAB NAVIGATION
     ===================================================================== -->
<nav class="tab-nav" id="tabNav">
  <button class="tab-btn active" data-page="ng" onclick="switchPage('ng')">Natural Gas</button>
  <button class="tab-btn" data-page="crude" onclick="switchPage('crude')">Crude Oil</button>
  <button class="tab-btn" data-page="power" onclick="switchPage('power')">Power</button>
  <button class="tab-btn" data-page="freight" onclick="switchPage('freight')">Freight</button>
  <button class="tab-btn" data-page="blotter" onclick="switchPage('blotter')">Trade Blotter</button>
  <button class="tab-btn" data-page="risk" onclick="switchPage('risk')">Risk Analytics</button>
  <button class="tab-btn" data-page="leaderboard" onclick="switchPage('leaderboard')">Leaderboard</button>
</nav>

<!-- =====================================================================
     MAIN CONTENT
     ===================================================================== -->
<div class="page-container">

  <!-- ===== NATURAL GAS PAGE ===== -->
  <div class="page active" id="page-ng">
    <div class="hub-toggle-bar" id="ngToggles"></div>
    <div class="map-section">
      <button class="map-toggle-btn" onclick="toggleMap('ng')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/><path d="M8 2v16"/><path d="M16 6v16"/></svg> <span id="ngMapLabel">Show Pipeline Map</span></button>
      <div class="map-container" id="ngMapContainer" style="display:none"></div>
    </div>
    <div class="bench-grid" id="ngBenchGrid"></div>
    <div class="chart-container" id="ngChartContainer">
      <div class="chart-header">
        <div class="chart-title"><span id="ngChartTitle">Henry Hub</span><button class="info-btn" onclick="openHubInfo(getSelectedHub('ng'))">&#9432;</button></div>
        <div class="chart-range-btns">
          <button class="range-btn" data-range="7" onclick="setRange('ng',7,this)">1W</button>
          <button class="range-btn active" data-range="30" onclick="setRange('ng',30,this)">1M</button>
          <button class="range-btn" data-range="90" onclick="setRange('ng',90,this)">3M</button>
          <button class="range-btn" data-range="180" onclick="setRange('ng',180,this)">6M</button>
        </div>
      </div>
      <div class="chart-canvas-wrap"><canvas id="ngChart"></canvas></div>
    </div>

    <div class="section-header">Basis Spreads vs Henry Hub</div>
    <div class="card"><div class="table-wrap">
      <table id="ngBasisTable">
        <thead><tr><th>Hub</th><th>Price</th><th>Basis</th><th>Change</th><th>30d Avg</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">Forward Curve — <span id="ngFwdTitle">Henry Hub</span></div>
    <div class="card"><div class="table-wrap">
      <table id="ngFwdTable">
        <thead><tr><th>Month</th><th>Price</th><th>Change</th><th>Open Interest</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">Market News</div>
    <div class="news-grid" id="ngNews"></div>

    <div class="eia-widget">
      <div class="eia-title">EIA Weekly Natural Gas Storage</div>
      <div class="eia-grid" id="ngEia">
        <div class="eia-item"><div class="eia-label">Working Gas</div><div class="eia-value" id="ngEiaStorage">—</div></div>
        <div class="eia-item"><div class="eia-label">Weekly Change</div><div class="eia-value" id="ngEiaChange">—</div></div>
        <div class="eia-item"><div class="eia-label">vs 5-Year Avg</div><div class="eia-value" id="ngEia5yr">—</div></div>
        <div class="eia-item"><div class="eia-label">Report Date</div><div class="eia-value" id="ngEiaDate">—</div></div>
      </div>
    </div>

    <div class="section-header">Economic Calendar</div>
    <div class="card"><div class="card-body"><div class="calendar-list" id="ngCalendar"></div></div></div>
  </div>

  <!-- ===== CRUDE OIL PAGE (content built in Message 3, map container ready) ===== -->
  <div class="page" id="page-crude">
    <div class="map-section">
      <button class="map-toggle-btn" onclick="toggleMap('crude')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/><path d="M8 2v16"/><path d="M16 6v16"/></svg> <span id="crudeMapLabel">Show Pipeline Map</span></button>
      <div class="map-container" id="crudeMapContainer" style="display:none"></div>
    </div>
    <div id="crudePageContent">
      <div class="hub-toggle-bar" id="crudeToggles"></div>
      <div class="bench-grid" id="crudeBenchGrid"></div>
      <div class="chart-container" id="crudeChartContainer">
        <div class="chart-header">
          <div class="chart-title"><span id="crudeChartTitle">WTI Cushing</span><button class="info-btn" onclick="openHubInfo(getSelectedHub('crude'))">&#9432;</button></div>
          <div class="chart-range-btns">
            <button class="range-btn" data-range="7" onclick="setRange('crude',7,this)">1W</button>
            <button class="range-btn active" data-range="30" onclick="setRange('crude',30,this)">1M</button>
            <button class="range-btn" data-range="90" onclick="setRange('crude',90,this)">3M</button>
            <button class="range-btn" data-range="180" onclick="setRange('crude',180,this)">6M</button>
          </div>
        </div>
        <div class="chart-canvas-wrap"><canvas id="crudeChart"></canvas></div>
      </div>

      <div class="section-header">Differentials vs WTI Cushing</div>
      <div class="card"><div class="table-wrap">
        <table id="crudeDiffTable">
          <thead><tr><th>Benchmark</th><th>Price</th><th>Differential</th><th>Change</th><th>30d Avg</th></tr></thead>
          <tbody></tbody>
        </table>
      </div></div>

      <div class="section-header">Forward Curve — <span id="crudeFwdTitle">WTI Cushing</span></div>
      <div class="card"><div class="table-wrap">
        <table id="crudeFwdTable">
          <thead><tr><th>Month</th><th>Price</th><th>Change</th><th>Open Interest</th></tr></thead>
          <tbody></tbody>
        </table>
      </div></div>

      <div class="section-header">Market News</div>
      <div class="news-grid" id="crudeNews"></div>

      <div class="eia-widget">
        <div class="eia-title">EIA Weekly Petroleum Status</div>
        <div class="eia-grid" id="crudeEia">
          <div class="eia-item"><div class="eia-label">Crude Inventory</div><div class="eia-value" id="crudeEiaInv">—</div></div>
          <div class="eia-item"><div class="eia-label">Weekly Change</div><div class="eia-value" id="crudeEiaChange">—</div></div>
          <div class="eia-item"><div class="eia-label">Cushing Stocks</div><div class="eia-value" id="crudeEiaCushing">—</div></div>
          <div class="eia-item"><div class="eia-label">Report Date</div><div class="eia-value" id="crudeEiaDate">—</div></div>
        </div>
      </div>

      <div class="section-header">Economic Calendar</div>
      <div class="card"><div class="card-body"><div class="calendar-list" id="crudeCalendar"></div></div></div>
    </div>
  </div>

  <!-- ===== POWER PAGE ===== -->
  <div class="page" id="page-power">
    <div class="hub-toggle-bar" id="powerToggles"></div>
    <div class="bench-grid" id="powerBenchGrid"></div>
    <div class="chart-container" id="powerChartContainer">
      <div class="chart-header">
        <div class="chart-title"><span id="powerChartTitle">ERCOT Hub</span><button class="info-btn" onclick="openHubInfo(getSelectedHub('power'))">&#9432;</button></div>
        <div class="chart-range-btns">
          <button class="range-btn" data-range="7" onclick="setRange('power',7,this)">1W</button>
          <button class="range-btn active" data-range="30" onclick="setRange('power',30,this)">1M</button>
          <button class="range-btn" data-range="90" onclick="setRange('power',90,this)">3M</button>
          <button class="range-btn" data-range="180" onclick="setRange('power',180,this)">6M</button>
        </div>
      </div>
      <div class="chart-canvas-wrap"><canvas id="powerChart"></canvas></div>
    </div>

    <div class="section-header">Spark Spreads (Heat Rate: 7.0 MMBtu/MWh)</div>
    <div class="card"><div class="table-wrap">
      <table id="powerSparkTable">
        <thead><tr><th>ISO Node</th><th>Power $/MWh</th><th>Gas Ref</th><th>Gas $/MMBtu</th><th>Gas Cost $/MWh</th><th>Spark Spread</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">Forward Curve — <span id="powerFwdTitle">ERCOT Hub</span></div>
    <div class="card"><div class="table-wrap">
      <table id="powerFwdTable">
        <thead><tr><th>Month</th><th>Price</th><th>Change</th><th>Open Interest</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">Market News</div>
    <div class="news-grid" id="powerNews"></div>

    <div class="eia-widget">
      <div class="eia-title">EIA Gas-Fired Power Generation</div>
      <div class="eia-grid" id="powerEia">
        <div class="eia-item"><div class="eia-label">Gas-Fired Gen</div><div class="eia-value" id="powerEiaGen">—</div></div>
        <div class="eia-item"><div class="eia-label">Weekly Change</div><div class="eia-value" id="powerEiaChange">—</div></div>
        <div class="eia-item"><div class="eia-label">% of Total Gen</div><div class="eia-value" id="powerEiaPct">—</div></div>
        <div class="eia-item"><div class="eia-label">Report Date</div><div class="eia-value" id="powerEiaDate">—</div></div>
      </div>
    </div>

    <div class="section-header">Economic Calendar</div>
    <div class="card"><div class="card-body"><div class="calendar-list" id="powerCalendar"></div></div></div>
  </div>

  <!-- ===== FREIGHT PAGE ===== -->
  <div class="page" id="page-freight">
    <div class="hub-toggle-bar" id="freightToggles"></div>
    <div class="bench-grid" id="freightBenchGrid"></div>
    <div class="chart-container" id="freightChartContainer">
      <div class="chart-header">
        <div class="chart-title"><span id="freightChartTitle">Baltic Dry Index</span><button class="info-btn" onclick="openHubInfo(getSelectedHub('freight'))">&#9432;</button></div>
        <div class="chart-range-btns">
          <button class="range-btn" data-range="7" onclick="setRange('freight',7,this)">1W</button>
          <button class="range-btn active" data-range="30" onclick="setRange('freight',30,this)">1M</button>
          <button class="range-btn" data-range="90" onclick="setRange('freight',90,this)">3M</button>
          <button class="range-btn" data-range="180" onclick="setRange('freight',180,this)">6M</button>
        </div>
      </div>
      <div class="chart-canvas-wrap"><canvas id="freightChart"></canvas></div>
    </div>

    <div class="section-header">Route Differentials vs Baltic Dry Index</div>
    <div class="card"><div class="table-wrap">
      <table id="freightDiffTable">
        <thead><tr><th>Route / Index</th><th>Rate</th><th>vs BDI</th><th>Change</th><th>30d Avg</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">FFA Forward Curve — <span id="freightFwdTitle">Baltic Dry Index</span></div>
    <div class="card"><div class="table-wrap">
      <table id="freightFwdTable">
        <thead><tr><th>Month</th><th>Rate</th><th>Change</th><th>Open Interest</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <div class="section-header">Market News</div>
    <div class="news-grid" id="freightNews"></div>

    <div class="section-header">Economic Calendar</div>
    <div class="card"><div class="card-body"><div class="calendar-list" id="freightCalendar"></div></div></div>
  </div>

  <!-- ===== TRADE BLOTTER ===== -->
  <div class="page" id="page-blotter">
    <!-- Account Bar -->
    <div class="bench-grid" id="accountBar" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));margin-bottom:20px">
      <div class="bench-card"><div class="hub-name">Balance</div><div class="hub-price" id="acctBalance">$1,000,000</div></div>
      <div class="bench-card"><div class="hub-name">Unrealized P&amp;L</div><div class="hub-price" id="acctUnrealized">$0</div></div>
      <div class="bench-card"><div class="hub-name">Realized P&amp;L</div><div class="hub-price" id="acctRealized">$0</div></div>
      <div class="bench-card"><div class="hub-name">Buying Power</div><div class="hub-price" id="acctBuyingPower">$1,000,000</div></div>
      <div class="bench-card"><div class="hub-name">Open Positions</div><div class="hub-price" id="acctOpenPos">0</div></div>
      <div class="bench-card"><div class="hub-name">Win Rate</div><div class="hub-price" id="acctWinRate">—</div></div>
    </div>

    <!-- Trade Form -->
    <div class="card" id="tradeFormCard">
      <div class="card-header"><span>New Trade</span><span id="tradeFormHint" style="font-size:12px;color:var(--text-muted);font-weight:400"></span></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
          <div class="form-group">
            <label>Trade Type</label>
            <select id="tradeType" onchange="onTradeTypeChange()">
              <option value="">Select type...</option>
              <option value="PHYS_FIXED">Physical Fixed</option>
              <option value="PHYS_INDEX">Physical Index</option>
              <option value="BASIS_SWAP">Basis Swap</option>
              <option value="FIXED_FLOAT">Fixed/Float Swap</option>
              <option value="SPREAD">Calendar Spread</option>
              <option value="BALMO">Balance of Month</option>
              <option value="OPTION_NG">NG Option</option>
              <option value="OPTION_CL">Crude Option</option>
              <option value="CRUDE_PHYS">Crude Physical</option>
              <option value="CRUDE_SWAP">Crude Swap</option>
              <option value="CRUDE_DIFF">Crude Differential</option>
              <option value="EFP">Exchange for Physical</option>
              <option value="TAS">Trade at Settlement</option>
              <option value="MULTILEG">Multi-Leg</option>
              <option value="FREIGHT_FFA">Freight FFA</option>
              <option value="FREIGHT_PHYS">Freight Physical</option>
            </select>
          </div>
          <div class="form-group">
            <label>Direction</label>
            <div style="display:flex;gap:4px">
              <button class="btn btn-sm" id="dirBuy" onclick="setDirection('BUY')" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)">BUY</button>
              <button class="btn btn-sm" id="dirSell" onclick="setDirection('SELL')" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)">SELL</button>
            </div>
          </div>
          <div class="form-group"><label>Hub / Location</label><select id="tradeHub"></select></div>
          <div class="form-group"><label>Volume</label><input type="number" id="tradeVolume" placeholder="10000"></div>
          <div class="form-group"><label>Entry Price <span style="font-size:11px;color:var(--text-muted)" id="priceHint">(at or above spot for BUY)</span></label><input type="number" id="tradeEntry" step="0.001" placeholder="Select hub"></div>
          <div class="form-group"><label>Spot Reference</label><input id="tradeSpot" readonly style="color:var(--text-muted)"></div>
          <div class="form-group"><label>Delivery Month</label><input type="month" id="tradeDelivery"></div>
          <div class="form-group"><label>Counterparty <span id="cptyHint" style="font-size:10px;color:var(--text-muted)"></span></label><select id="tradeCpty"><option value="">None (Exchange)</option></select></div>
        </div>

        <!-- Conditional fields -->
        <div id="conditionalFields" style="display:none;margin-top:12px">
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
            <div class="form-group cond-spread" style="display:none"><label>Near Month</label><input type="month" id="tradeNearMonth"></div>
            <div class="form-group cond-spread" style="display:none"><label>Far Month</label><input type="month" id="tradeFarMonth"></div>
            <div class="form-group cond-option" style="display:none"><label>Strike Price</label><input type="number" id="tradeStrike" step="0.01"></div>
            <div class="form-group cond-option" style="display:none"><label>Expiry</label><input type="date" id="tradeExpiry"></div>
            <div class="form-group cond-option" style="display:none"><label>Call / Put</label><select id="tradeCallPut"><option value="CALL">Call</option><option value="PUT">Put</option></select></div>
            <div class="form-group cond-option" style="display:none"><label>Premium</label><input type="number" id="tradePremium" step="0.01"></div>
            <div class="form-group cond-basis" style="display:none"><label>Basis Hub</label><select id="tradeBasisHub"></select></div>
            <div class="form-group cond-diff" style="display:none"><label>Spread Value</label><input type="number" id="tradeDiffSpread" step="0.01"></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px">
          <div class="form-group"><label>Stop Loss</label><input type="number" id="tradeStop" step="0.01" placeholder="Optional"></div>
          <div class="form-group"><label>Target Exit</label><input type="number" id="tradeTarget" step="0.01" placeholder="Optional"></div>
          <div class="form-group"><label>Venue</label>
            <select id="tradeVenue">
              <option value="OTC">OTC Bilateral</option><option value="ICE">ICE</option><option value="CME">CME</option>
              <option value="BGC">BGC</option><option value="Tradition">Tradition</option><option value="GFI">GFI</option>
            </select>
          </div>
          <div class="form-group"><label>Notes</label><input id="tradeNotes" placeholder="Optional notes"></div>
        </div>

        <!-- Margin preview -->
        <div style="display:flex;gap:16px;margin-top:16px;padding:12px;background:var(--surface2);border-radius:6px;font-size:13px;align-items:center;flex-wrap:wrap">
          <span style="color:var(--text-dim)">Margin Required: <strong id="marginRequired" style="color:var(--text)">$0</strong></span>
          <span style="color:var(--text-dim)">Available: <strong id="marginAvailable" style="color:var(--green)">$1,000,000</strong></span>
          <span style="color:var(--text-dim)">Utilization: <strong id="marginUtil" style="color:var(--text)">0%</strong></span>
          <button class="btn btn-primary" onclick="submitTrade()" style="margin-left:auto">Submit Trade</button>
        </div>
      </div>
    </div>

    <!-- Search / Filter -->
    <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
      <input id="blotterSearch" placeholder="Search trades (hub, type, notes...)" oninput="renderBlotterTable()" style="flex:1;min-width:200px">
      <span style="font-size:12px;color:var(--text-muted)" id="blotterCount">0 trades</span>
    </div>

    <!-- Blotter Table -->
    <div class="card">
      <div class="table-wrap">
        <table id="blotterTable">
          <thead><tr><th>Date</th><th>Type</th><th>Dir</th><th>Hub</th><th>Volume</th><th>Entry</th><th>Spot</th><th>MTM P&amp;L</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="blotterBody"></tbody>
        </table>
      </div>
      <div style="display:flex;justify-content:center;gap:8px;padding:12px" id="blotterPagination"></div>
    </div>

    <!-- Position Netting -->
    <div class="section-header">Net Position Summary</div>
    <div class="card"><div class="table-wrap">
      <table id="netPositionTable">
        <thead><tr><th>Hub</th><th>Long Volume</th><th>Short Volume</th><th>Net Exposure</th><th>Direction</th></tr></thead>
        <tbody id="netPositionBody"></tbody>
      </table>
    </div></div>

    <!-- Cumulative P&L Chart -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="section-header" style="margin-bottom:0">Cumulative Realized P&amp;L</div>
      <div style="display:flex;gap:4px">
        <button class="range-btn" onclick="setPnlRange('1W',this)">1W</button>
        <button class="range-btn" onclick="setPnlRange('1M',this)">1M</button>
        <button class="range-btn" onclick="setPnlRange('3M',this)">3M</button>
        <button class="range-btn active" onclick="setPnlRange('ALL',this)">ALL</button>
      </div>
    </div>
    <div class="chart-container">
      <div class="chart-canvas-wrap"><canvas id="pnlChart"></canvas></div>
    </div>
  </div>

  <!-- ===== RISK ANALYTICS ===== -->
  <div class="page" id="page-risk">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;margin-bottom:16px">
      <!-- VaR Card -->
      <div class="card">
        <div class="card-header" style="display:flex;align-items:center">Value at Risk<button class="info-btn" onclick="toggleInfo('varInfo',event)">i</button></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><div style="font-size:11px;color:var(--text-muted)">Portfolio Value</div><div class="mono" style="font-size:18px;font-weight:700" id="riskPortValue">$0</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">VaR (95%)</div><div class="mono red" style="font-size:18px;font-weight:700" id="riskVar95">$0</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">VaR (99%)</div><div class="mono red" style="font-size:18px;font-weight:700" id="riskVar99">$0</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">CVaR (95%)</div><div class="mono red" style="font-size:18px;font-weight:700" id="riskCvar95">$0</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">CVaR (99%)</div><div class="mono red" style="font-size:18px;font-weight:700" id="riskCvar99">$0</div></div>
          </div>
        </div>
      </div>
      <!-- Performance Card -->
      <div class="card">
        <div class="card-header" style="display:flex;align-items:center">Performance Metrics<button class="info-btn" onclick="toggleInfo('perfInfo',event)">i</button></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><div style="font-size:11px;color:var(--text-muted)">Sharpe Ratio</div><div class="mono" style="font-size:18px;font-weight:700" id="riskSharpe">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Win Rate</div><div class="mono" style="font-size:18px;font-weight:700" id="riskWinRate">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Profit Factor</div><div class="mono" style="font-size:18px;font-weight:700" id="riskPF">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Avg Win / Avg Loss</div><div class="mono" style="font-size:18px;font-weight:700" id="riskAvgWL">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Best Trade</div><div class="mono green" style="font-size:18px;font-weight:700" id="riskBest">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Worst Trade</div><div class="mono red" style="font-size:18px;font-weight:700" id="riskWorst">—</div></div>
            <div><div style="font-size:11px;color:var(--text-muted)">Total / Open / Closed</div><div class="mono" style="font-size:14px" id="riskCounts">0 / 0 / 0</div></div>
          </div>
        </div>
      </div>
      <!-- Scenario Analysis -->
      <div class="card">
        <div class="card-header" style="display:flex;align-items:center">Scenario Analysis<button class="info-btn" onclick="toggleInfo('scenInfo',event)">i</button></div>
        <div class="card-body"><div class="table-wrap">
          <table id="scenarioTable">
            <thead><tr><th>Scenario</th><th>NG</th><th>Power</th><th>Crude</th><th>Freight</th><th>Portfolio Impact</th></tr></thead>
            <tbody id="scenarioBody"></tbody>
          </table>
        </div></div>
      </div>
    </div>
    <!-- Open Positions + Heatmap — FULL WIDTH outside the auto-fill grid -->
    <div class="risk-positions-grid" style="display:grid;grid-template-columns:1fr 2fr;gap:16px;margin-bottom:16px">
      <div class="card">
        <div class="card-header">Open Positions</div>
        <div class="card-body"><div class="table-wrap">
          <table><thead><tr><th>Hub</th><th>Dir</th><th>Volume</th><th>MTM P&amp;L</th></tr></thead>
          <tbody id="riskOpenBody"></tbody></table>
        </div></div>
      </div>
      <div class="card">
        <div class="card-header">Position Heatmap <span style="font-size:11px;color:var(--text-muted);font-weight:400;margin-left:8px">sized by exposure · colored by P&amp;L</span></div>
        <div class="card-body" style="padding:12px"><div id="riskHeatmap" style="min-height:200px"></div></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="section-header" style="margin-bottom:0">Equity Curve</div>
      <div style="display:flex;gap:4px">
        <button class="range-btn active" onclick="setEqRange('1W',this)">1W</button>
        <button class="range-btn" onclick="setEqRange('1M',this)">1M</button>
        <button class="range-btn" onclick="setEqRange('3M',this)">3M</button>
        <button class="range-btn" onclick="setEqRange('YTD',this)">YTD</button>
        <button class="range-btn" onclick="setEqRange('ALL',this)">ALL</button>
      </div>
    </div>
    <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="equityChart"></canvas></div></div>
  </div>

  <!-- Info Popovers (outside cards to escape overflow:hidden) -->
  <div class="info-popover" id="varInfo">
    <h4>Value at Risk — How It's Calculated</h4>
    <div class="info-row"><span class="info-label">Portfolio Value</span><span class="info-desc">Starting balance + realized P&amp;L from closed trades + mark-to-market P&amp;L on open positions.</span></div>
    <div class="info-row"><span class="info-label">VaR (95%)</span><span class="info-desc">Maximum expected 1-day loss at 95% confidence. <code>Portfolio × σ_daily × 1.645</code> where σ_daily = 2% assumed daily volatility and 1.645 is the z-score for the 95th percentile.</span></div>
    <div class="info-row"><span class="info-label">VaR (99%)</span><span class="info-desc">Maximum expected 1-day loss at 99% confidence. Uses z-score of <code>2.326</code>. Captures more extreme tail events.</span></div>
    <div class="info-row"><span class="info-label">CVaR (95%)</span><span class="info-desc">Conditional VaR (Expected Shortfall). Average loss <em>given</em> VaR is breached. Estimated as <code>VaR_95 × 1.3</code>, reflecting tail losses average ~30% beyond VaR.</span></div>
    <div class="info-row"><span class="info-label">CVaR (99%)</span><span class="info-desc">Same at 99% confidence: <code>VaR_99 × 1.3</code>. Average loss in the worst 1% of trading days.</span></div>
  </div>
  <div class="info-popover" id="perfInfo">
    <h4>Performance Metrics — Definitions</h4>
    <div class="info-row"><span class="info-label">Sharpe Ratio</span><span class="info-desc">Risk-adjusted return: <code>(mean_PnL / std_PnL) × √252</code>. Annualized from per-trade data. Above 1.0 is good, above 2.0 is excellent.</span></div>
    <div class="info-row"><span class="info-label">Win Rate</span><span class="info-desc"><code>winning_trades / total_closed × 100</code>. A trade "wins" if realized P&amp;L &gt; 0.</span></div>
    <div class="info-row"><span class="info-label">Profit Factor</span><span class="info-desc"><code>gross_wins / gross_losses</code>. Above 1.0 = profitable. Above 2.0 = strong edge.</span></div>
    <div class="info-row"><span class="info-label">Avg Win / Loss</span><span class="info-desc">Average P&amp;L of winners vs average loss of losers. Measures reward-to-risk per trade.</span></div>
    <div class="info-row"><span class="info-label">Best / Worst</span><span class="info-desc">Largest single-trade gain and largest single-trade loss across all closed positions.</span></div>
  </div>
  <div class="info-popover" id="scenInfo" style="width:460px">
    <h4>Scenario Analysis — Methodology</h4>
    <div style="margin-bottom:10px;color:var(--text-dim);font-size:11px">Each scenario applies commodity-specific % shocks to open positions. Impact = <code>Σ (entry × %move × volume × direction)</code>.</div>
    <div class="info-row"><span class="info-label" style="color:#ef4444">Winter Freeze</span><span class="info-desc">Polar vortex: NG +40% (heating demand), Power +60% (generation stress), Crude +5% (diesel/heating oil), Freight +10% (supply disruption).</span></div>
    <div class="info-row"><span class="info-label" style="color:#f59e0b">OPEC Cut</span><span class="info-desc">Production cut surprise: Crude +20%, Freight +15% (tighter shipping). NG/Power 0% (different supply dynamics).</span></div>
    <div class="info-row"><span class="info-label" style="color:#22d3ee">Demand Destruction</span><span class="info-desc">Global recession: NG −25%, Power −25%, Crude −25%, Freight −30% (shipping collapses hardest).</span></div>
    <div class="info-row"><span class="info-label" style="color:#10b981">Storage Surprise</span><span class="info-desc">Bullish EIA miss: NG +15% (supply tightness), Power +10% (gas correlation), Freight +5% (LNG shipping). Crude unchanged.</span></div>
    <div class="info-row"><span class="info-label" style="color:#a78bfa">Summer Heat Wave</span><span class="info-desc">Extreme temps: Power +45% (AC/peaker demand), NG +20% (generation pull). Crude/Freight unaffected.</span></div>
  </div>

  <!-- ===== LEADERBOARD ===== -->
  <div class="page" id="page-leaderboard">
    <div style="display:flex;gap:4px;margin-bottom:16px">
      <button class="btn btn-sm btn-primary" id="lbTabIndiv" onclick="setLbTab('individual')">Individual</button>
      <button class="btn btn-sm btn-ghost" id="lbTabTeam" onclick="setLbTab('myteam')">My Team</button>
      <button class="btn btn-sm btn-ghost" id="lbTabRank" onclick="setLbTab('rankings')">Team Rankings</button>
      <span id="lbLiveIndicator" style="font-size:11px;padding:4px 8px;border-radius:4px;margin-left:auto"></span>
    </div>

    <div id="lbIndividual">
      <div class="card"><div class="table-wrap">
        <table id="lbTable">
          <thead><tr><th>Rank</th><th>Trader</th><th>Return %</th><th>Equity</th><th>Win Rate</th><th>PF</th><th>Trades</th><th>Trend</th></tr></thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div></div>
      <div class="section-header">Your Percentile Rank</div>
      <div class="card"><div class="card-body" id="percentileContainer"></div></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div class="section-header" style="margin-bottom:0">Equity Curves</div>
        <div style="display:flex;gap:4px">
          <button class="range-btn" onclick="setLbRange('1W',this)">1W</button>
          <button class="range-btn active" onclick="setLbRange('1M',this)">1M</button>
          <button class="range-btn" onclick="setLbRange('3M',this)">3M</button>
          <button class="range-btn" onclick="setLbRange('ALL',this)">ALL</button>
        </div>
      </div>
      <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="lbEquityChart"></canvas></div></div>
      <div id="lbChips" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px"></div>
    </div>

    <div id="lbMyTeam" style="display:none">
      <div class="card"><div class="card-body" id="myTeamContent"><p style="color:var(--text-muted);text-align:center;padding:20px">You are not assigned to a team</p></div></div>
      <div class="section-header">Team Equity Curves</div>
      <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="teamEquityChart"></canvas></div></div>
      <div id="teamChips" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px"></div>
    </div>

    <div id="lbRankings" style="display:none">
      <div class="section-header">Team Performance</div>
      <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="teamBarChart" style="height:200px"></canvas></div></div>
      <div id="teamRankChips" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px"></div>
      <div class="card" style="margin-top:16px"><div class="table-wrap">
        <table><thead><tr><th>Rank</th><th>Team</th><th>Members</th><th>Combined P&amp;L</th><th>Avg Return</th><th>Best Trader</th></tr></thead>
        <tbody id="lbTeamRankBody"></tbody></table>
      </div></div>
    </div>
  </div>

  <!-- ===== PROFILE MODAL ===== -->
  <div class="profile-modal-overlay" id="profileOverlay" onclick="if(event.target===this)closeProfile()">
    <div class="profile-modal" style="position:relative">
      <button class="profile-modal-close" onclick="closeProfile()">&times;</button>
      <div class="profile-modal-header">
        <div class="profile-modal-avatar" id="profAvatar"></div>
        <div>
          <div class="profile-modal-name" id="profName"></div>
          <div class="profile-modal-firm" id="profFirm"></div>
          <div class="profile-modal-rank-badge" id="profRank"></div>
        </div>
      </div>
      <div class="profile-modal-stats" id="profStats"></div>
      <div style="padding:0 24px 20px">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Equity Curve</div>
        <canvas id="profEquityCanvas" style="width:100%;height:120px;border-radius:6px;background:var(--surface2)"></canvas>
      </div>
    </div>
  </div>

  <!-- ===== MOBILE TRADE TICKET ===== -->
  <div id="mobileTicket" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:400;background:var(--surface);border-top:2px solid var(--accent);border-radius:16px 16px 0 0;max-height:85vh;overflow-y:auto;padding:20px;box-shadow:0 -4px 20px rgba(0,0,0,0.3)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <span style="font-size:16px;font-weight:700">Quick Trade</span>
      <button class="btn btn-ghost btn-sm" onclick="closeMobileTicket()">&times; Close</button>
    </div>
    <div class="form-group"><label>Type</label><select id="mobType" onchange="onMobTypeChange()" style="font-size:16px;padding:12px"></select></div>
    <div style="display:flex;gap:8px;margin:12px 0">
      <button id="mobBuy" onclick="setMobDir('BUY')" style="flex:1;padding:14px;font-size:16px;font-weight:700;border-radius:8px;border:2px solid var(--border);background:var(--surface2);color:var(--text-dim);cursor:pointer">BUY</button>
      <button id="mobSell" onclick="setMobDir('SELL')" style="flex:1;padding:14px;font-size:16px;font-weight:700;border-radius:8px;border:2px solid var(--border);background:var(--surface2);color:var(--text-dim);cursor:pointer">SELL</button>
    </div>
    <div class="form-group"><label>Hub</label><select id="mobHub" style="font-size:16px;padding:12px"></select></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="form-group"><label>Volume</label><input type="number" id="mobVolume" style="font-size:16px;padding:12px"></div>
      <div class="form-group"><label>Entry Price <span id="mobPriceHint" style="font-size:11px;color:var(--text-muted)"></span></label><input type="number" id="mobEntry" step="0.001" style="font-size:16px;padding:12px"></div>
    </div>
    <button class="btn btn-primary" onclick="submitMobileTrade()" style="width:100%;padding:14px;font-size:16px;margin-top:12px;justify-content:center">Submit Trade</button>
  </div>

</div>

<!-- Mobile FAB for quick trade -->
<button class="mobile-fab" onclick="openMobileTicket()">+</button>

<!-- =====================================================================
     SETTINGS PANEL
     ===================================================================== -->
<div class="panel-overlay" id="panelOverlay" onclick="closeAllPanels()"></div>

<div class="slide-panel right" id="settingsPanel">
  <div class="panel-header"><h2>Settings</h2><button class="panel-close" onclick="closeAllPanels()">&times;</button></div>
  <div class="panel-body">
    <div class="panel-section">
      <h3>Profile</h3>
      <div class="form-group"><label>Real Name <span style="font-size:11px;color:var(--text-muted)">(set by admin)</span></label><input id="setRealName" placeholder="" disabled style="opacity:0.6"></div>
      <div class="form-group"><label>Display Name <span style="font-size:11px;color:var(--text-muted)">(shown on leaderboard)</span></label><input id="setName" placeholder="Choose your display name" maxlength="30"></div>
      <div class="form-group"><label>Role <span style="font-size:11px;color:var(--text-muted)">(set by admin)</span></label><input id="setFirm" placeholder="Role" disabled style="opacity:0.6"></div>
      <div class="form-group">
        <label>Profile Photo</label>
        <div style="display:flex;align-items:center;gap:12px">
          <div id="photoPreview" style="width:48px;height:48px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:18px;font-weight:700;color:var(--text-dim)"></div>
          <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoUpload(this)" style="font-size:12px">
        </div>
      </div>
    </div>
    <div class="panel-section">
      <h3>Account</h3>
      <div class="form-group"><label>Starting Balance ($)</label><input type="number" id="setBalance" value="1000000"></div>
      <div class="form-group"><label>Margin Model</label>
        <select id="setMargin"><option value="nymex">NYMEX Initial Margin</option><option value="flat">Flat 4:1 Leverage</option></select>
      </div>
    </div>
    <div class="panel-section">
      <h3>OTC Trading</h3>
      <div class="otc-toggle">
        <label style="flex:1">Accept OTC trades from other teams</label>
        <label class="otc-switch"><input type="checkbox" id="setOtcAvailable" checked onchange="toggleOtcAvailable(this.checked)"><span class="slider"></span></label>
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin:0">When enabled, other teams can initiate bilateral trades with you. The mirror position will be auto-assigned to your book.</p>
    </div>
    <div class="panel-section">
      <h3>Data Source</h3>
      <div class="form-group"><label>Platts MDC Client ID</label><input id="setPlattsId" placeholder="Coming soon..." disabled></div>
      <div class="form-group"><label>Platts MDC Secret</label><input id="setPlattsSecret" type="password" placeholder="Coming soon..." disabled></div>
    </div>
    <div class="panel-section">
      <h3>Display</h3>
      <div class="form-group"><label>Theme</label>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm theme-opt" data-theme="dark" onclick="setTheme('dark')">Dark</button>
          <button class="btn btn-sm theme-opt" data-theme="medium" onclick="setTheme('medium')">Medium Dark</button>
          <button class="btn btn-sm theme-opt" data-theme="light" onclick="setTheme('light')">Light</button>
        </div>
      </div>
    </div>
    <div class="panel-section">
      <h3>Sound</h3>
      <div class="form-group" style="flex-direction:row;align-items:center;gap:12px">
        <label style="margin:0">Sound Alerts</label>
        <input type="checkbox" id="setSoundEnabled" style="width:auto">
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveSettings()" style="width:100%;justify-content:center">Save Settings</button>
    <button class="btn btn-ghost" onclick="doLogout()" style="width:100%;justify-content:center;margin-top:8px;color:var(--red);border-color:var(--red)">Log Out</button>
  </div>
</div>

<!-- =====================================================================
     HELP PANEL
     ===================================================================== -->
<div class="slide-panel left" id="helpPanel">
  <div class="panel-header"><h2>Help &amp; Guide</h2><button class="panel-close" onclick="closeAllPanels()">&times;</button></div>
  <div class="panel-body">
    <div class="panel-section"><h3>1. Getting Started</h3><p>Energy Desk is a simulated energy trading terminal. Register with your name and PIN from your admin to begin trading natural gas, crude oil, power, and freight markets.</p><p>Use the tabs at the top to navigate between market pages, your trade blotter, risk analytics, and the leaderboard.</p></div>
    <div class="panel-section"><h3>2. Natural Gas Trading</h3><p>Trade 13 major North American gas hubs from Henry Hub to Algonquin. Monitor basis spreads, forward curves, and weekly EIA storage reports. Gas is priced in $/MMBtu.</p></div>
    <div class="panel-section"><h3>3. Crude Oil Trading</h3><p>Trade 8 global crude benchmarks including WTI, Brent, and regional grades. Track differentials vs WTI Cushing and weekly petroleum inventory data. Crude is priced in $/BBL.</p></div>
    <div class="panel-section"><h3>4. Power Trading</h3><p>Trade 11 ISO/RTO power nodes across ERCOT, PJM, NEPOOL, MISO, CAISO, NYISO, and SPP. Monitor spark spreads (power price minus gas cost at 7.0 heat rate). Power is priced in $/MWh.</p></div>
    <div class="panel-section"><h3>5. Freight Trading</h3><p>Trade global shipping freight routes including dry bulk (Baltic indices) and tanker rates. Monitor Forward Freight Agreements (FFAs) and route differentials.</p></div>
    <div class="panel-section"><h3>6. Trade Types Glossary</h3>
      <p><strong>PHYS_FIXED</strong> — Fixed-price physical gas delivery</p>
      <p><strong>PHYS_INDEX</strong> — Index-priced physical (settles vs first-of-month)</p>
      <p><strong>BASIS_SWAP</strong> — Basis differential swap (hub vs Henry Hub)</p>
      <p><strong>FIXED_FLOAT</strong> — Fixed-for-floating swap</p>
      <p><strong>SPREAD</strong> — Calendar spread (near month vs far month)</p>
      <p><strong>BALMO</strong> — Balance-of-month trade</p>
      <p><strong>OPTION_NG</strong> — Natural gas option (call/put)</p>
      <p><strong>OPTION_CL</strong> — Crude oil option (call/put)</p>
      <p><strong>CRUDE_PHYS</strong> — Physical crude delivery</p>
      <p><strong>CRUDE_SWAP</strong> — Crude financial swap</p>
      <p><strong>CRUDE_DIFF</strong> — Crude differential trade</p>
      <p><strong>EFP</strong> — Exchange for Physical</p>
      <p><strong>TAS</strong> — Trade at Settlement</p>
      <p><strong>MULTILEG</strong> — Multi-leg structured trade</p>
      <p><strong>FREIGHT_FFA</strong> — Forward Freight Agreement</p>
      <p><strong>FREIGHT_PHYS</strong> — Physical freight/charter</p>
    </div>
    <div class="panel-section"><h3>7. Risk Metrics</h3><p><strong>VaR (95/99%)</strong> — Maximum expected loss at confidence level over 1 day.</p><p><strong>CVaR</strong> — Expected loss beyond VaR threshold (tail risk).</p><p><strong>Sharpe Ratio</strong> — Risk-adjusted return (annualized).</p><p><strong>Profit Factor</strong> — Gross wins divided by gross losses. Above 1.0 is profitable.</p></div>
    <div class="panel-section"><h3>8. How Margin Works</h3><p>NG Swap/Physical: $1,500 per 10,000 MMBtu. Crude: $5,000 per 1,000 BBL. Options: 50% of underlying. Basis Swap: $800 per 10,000 MMBtu.</p></div>
    <div class="panel-section"><h3>9. P&amp;L Explained</h3><p><strong>Unrealized P&amp;L</strong> = (Current Price - Entry Price) × Volume × Direction</p><p><strong>Realized P&amp;L</strong> = (Close Price - Entry Price) × Volume × Direction</p><p><strong>Equity</strong> = Starting Balance + Realized P&amp;L + Unrealized P&amp;L</p></div>
    <div class="panel-section"><h3>Keyboard Shortcuts</h3>
      <p><strong>1-7</strong> — Switch tabs</p><p><strong>B</strong> — Set BUY direction</p><p><strong>S</strong> — Set SELL direction</p><p><strong>Enter</strong> — Submit trade</p><p><strong>Esc</strong> — Close panel/modal</p><p><strong>?</strong> — Open this help</p><p><strong>I</strong> — Hub info for selected hub</p>
    </div>
  </div>
</div>

<!-- =====================================================================
     HUB INFO PANEL
     ===================================================================== -->
<div class="slide-panel right" id="hubInfoPanel" style="width:480px">
  <div class="panel-header"><h2 id="hubInfoTitle">Hub Info</h2><button class="panel-close" onclick="closeAllPanels()">&times;</button></div>
  <div class="panel-body" id="hubInfoBody"></div>
</div>

<!-- =====================================================================
     MODAL (generic)
     ===================================================================== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<!-- TRADING CALENDAR MODAL -->
<div class="cal-modal" id="calModal" onclick="if(event.target===this)closeCalendar()">
  <div class="cal-box">
    <div class="cal-nav">
      <button onclick="calNav(-1)">&#8249;</button>
      <span id="calTitle">February 2026</span>
      <button onclick="calNav(1)">&#8250;</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="cal-legend">
      <span><span class="dot" style="background:#ef4444"></span> Market Holiday</span>
      <span><span class="dot" style="background:var(--accent)"></span> Today</span>
      <span><span class="dot" style="background:var(--text-muted)"></span> Weekend</span>
    </div>
  </div>
</div>

<!-- CHAT TAB (collapsed) -->
<div class="chat-tab" id="chatTab" onclick="toggleChat()" style="display:none">
  Chat
  <span class="unread-dot" id="chatUnreadDot"></span>
</div>

<!-- CHAT PANEL -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="chat-back-btn" id="chatBackBtn" onclick="chatShowList()" style="display:none"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
      <h3 id="chatTitle">Messages</h3>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="chat-new-btn" id="chatNewBtn" onclick="chatNewConvo()">+ New</button>
      <button class="chat-new-btn" id="chatRenameBtn" onclick="chatRenameConvo()" style="display:none;font-size:11px;color:var(--text-muted)">✏ Rename</button>
      <button style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px" onclick="toggleChat()">✕</button>
    </div>
  </div>

  <!-- Conversation List View -->
  <div class="chat-convos" id="chatConvoList"></div>

  <!-- Message View (hidden by default) -->
  <div id="chatMsgView" style="display:none;flex:1;flex-direction:column;overflow:hidden">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-wrap">
      <input type="text" id="chatInput" placeholder="Type a message..." maxlength="2000" onkeydown="if(event.key==='Enter')chatSend()">
      <button onclick="chatSend()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4z"/></svg></button>
    </div>
  </div>
</div>

<!-- =====================================================================
     TOAST CONTAINER
     ===================================================================== -->
<div class="toast-container" id="toastContainer"></div>

<!-- =====================================================================
     JAVASCRIPT — CORE ENGINE
     ===================================================================== -->
<script>
/* =====================================================================
   GLOBAL STATE
   ===================================================================== */
const API_BASE = ''; // Same-origin — all API calls are relative
const STATE = {
  trader: JSON.parse(localStorage.getItem('ng_trader') || 'null'),
  trades: JSON.parse(localStorage.getItem('ng_trades') || '[]'),
  settings: JSON.parse(localStorage.getItem('ng_settings') || '{"balance":1000000,"margin":"nymex","sound":false}'),
  connected: false,
  currentPage: 'ng',
  selectedHubs: { ng: 'Henry Hub', crude: 'WTI Cushing', power: 'ERCOT Hub', freight: 'Baltic Dry Index' },
  chartRanges: { ng: 30, crude: 30, power: 30, freight: 30 },
  visibleHubs: {},
  forwardCurves: {},
  clickedPrice: null,
  eqRange: 'ALL',
  pnlRange: 'ALL',
  lbRange: '1M',
  lastActivity: Date.now(),
  ws: null
};

/* =====================================================================
   HUB DATA
   ===================================================================== */
const NG_HUBS = [
  { name:'Henry Hub', base:2.75, vol:4.5, color:'#22d3ee' },
  { name:'Waha', base:2.40, vol:6.0, color:'#f59e0b' },
  { name:'SoCal Gas', base:2.90, vol:5.5, color:'#a78bfa' },
  { name:'Chicago', base:2.70, vol:4.0, color:'#10b981' },
  { name:'Algonquin', base:3.55, vol:12.0, color:'#ef4444' },
  { name:'Transco Zone 6', base:3.35, vol:10.0, color:'#ec4899' },
  { name:'Dominion South', base:2.30, vol:5.0, color:'#84cc16' },
  { name:'Dawn', base:2.85, vol:4.5, color:'#06b6d4' },
  { name:'Sumas', base:2.95, vol:6.0, color:'#f97316' },
  { name:'Malin', base:2.93, vol:5.5, color:'#8b5cf6' },
  { name:'Opal', base:2.67, vol:5.0, color:'#14b8a6' },
  { name:'Tetco M3', base:3.30, vol:9.0, color:'#e11d48' },
  { name:'Kern River', base:2.80, vol:5.0, color:'#0ea5e9' }
];

const CRUDE_HUBS = [
  { name:'WTI Cushing', base:79.50, vol:1.8, color:'#22d3ee' },
  { name:'Brent Dated', base:82.70, vol:1.6, color:'#f59e0b' },
  { name:'WTI Midland', base:79.90, vol:2.0, color:'#a78bfa' },
  { name:'Mars Sour', base:77.70, vol:2.2, color:'#10b981' },
  { name:'LLS', base:80.70, vol:1.9, color:'#ec4899' },
  { name:'ANS', base:80.40, vol:2.0, color:'#ef4444' },
  { name:'Bakken', base:78.90, vol:2.1, color:'#84cc16' },
  { name:'WCS', base:65.00, vol:3.0, color:'#f97316' }
];

const POWER_HUBS = [
  { name:'ERCOT Hub', base:42.50, vol:8.0, color:'#22d3ee', gasRef:'Henry Hub' },
  { name:'ERCOT North', base:40.80, vol:7.5, color:'#06b6d4', gasRef:'Henry Hub' },
  { name:'ERCOT South', base:44.10, vol:9.0, color:'#0ea5e9', gasRef:'Henry Hub' },
  { name:'PJM West Hub', base:38.20, vol:6.0, color:'#a78bfa', gasRef:'Transco Zone 6' },
  { name:'NEPOOL Mass', base:51.30, vol:10.0, color:'#ef4444', gasRef:'Algonquin' },
  { name:'MISO Illinois', base:34.70, vol:5.5, color:'#10b981', gasRef:'Chicago' },
  { name:'CAISO NP15', base:48.60, vol:9.5, color:'#f59e0b', gasRef:'SoCal Gas' },
  { name:'CAISO SP15', base:47.20, vol:9.0, color:'#f97316', gasRef:'SoCal Gas' },
  { name:'NYISO Zone J', base:55.40, vol:11.0, color:'#ec4899', gasRef:'Transco Zone 6' },
  { name:'NYISO Zone A', base:36.80, vol:7.0, color:'#8b5cf6', gasRef:'Dawn' },
  { name:'SPP North', base:33.90, vol:6.5, color:'#84cc16', gasRef:'Henry Hub' }
];

const FREIGHT_HUBS = [
  { name:'Baltic Dry Index', base:1650, vol:5.0, color:'#22d3ee' },
  { name:'Baltic Capesize', base:2200, vol:7.0, color:'#f59e0b' },
  { name:'Baltic Panamax', base:1450, vol:5.5, color:'#a78bfa' },
  { name:'Baltic Supramax', base:1280, vol:5.0, color:'#10b981' },
  { name:'TD3C VLCC AG-East', base:45.50, vol:8.0, color:'#ef4444' },
  { name:'TC2 Transatlantic', base:18.20, vol:9.0, color:'#ec4899' },
  { name:'TD20 Suezmax WAF', base:32.80, vol:7.5, color:'#84cc16' },
  { name:'LNG Spot East', base:12.40, vol:6.0, color:'#f97316' }
];

const ALL_HUB_SETS = { ng: NG_HUBS, crude: CRUDE_HUBS, power: POWER_HUBS, freight: FREIGHT_HUBS };

// Price history storage: hubName -> array of prices
const priceHistory = {};
const basisHistory = {};

// Message 5 globals (must be declared before any render calls)
const MAP_STATE = { ng: false, crude: false };
let lbTab = 'individual';
let mobDir = '';
const SCENARIOS = [
  { name:'Winter Freeze', ng:40, power:60, crude:5, freight:10 },
  { name:'OPEC Cut', ng:0, power:0, crude:20, freight:15 },
  { name:'Demand Destruction', ng:-25, power:-25, crude:-25, freight:-30 },
  { name:'Storage Surprise Bull', ng:15, power:10, crude:0, freight:5 },
  { name:'Summer Heat Wave', ng:20, power:45, crude:0, freight:0 }
];
const SIM_PEERS = [
  {name:'J. Martinez',realName:'Juan Martinez',firm:'Basis Capital',team:{name:'Alpha',color:'#22d3ee'},ret:6.2,winRate:58,pf:1.80,trades:42},
  {name:'K. Thompson',realName:'Kate Thompson',firm:'Crude Trading LLC',team:{name:'Alpha',color:'#22d3ee'},ret:3.8,winRate:52,pf:1.40,trades:31},
  {name:'A. Singh',realName:'Arun Singh',firm:'Optionality Partners',team:{name:'Beta',color:'#f59e0b'},ret:11.4,winRate:64,pf:2.30,trades:55},
  {name:'R. Chen',realName:'Robert Chen',firm:'Spread Capital',team:{name:'Beta',color:'#f59e0b'},ret:-1.2,winRate:45,pf:0.90,trades:28},
  {name:'M. Williams',realName:'Marcus Williams',firm:'Grid Power Co',team:{name:'Gamma',color:'#10b981'},ret:2.1,winRate:51,pf:1.20,trades:19},
  {name:'S. Patel',realName:'Sanjay Patel',firm:'Energy Macro Fund',team:{name:'Gamma',color:'#10b981'},ret:7.8,winRate:55,pf:1.90,trades:48},
  {name:'L. Davis',realName:'Lisa Davis',firm:'Vol Trading Group',team:null,ret:4.5,winRate:48,pf:1.50,trades:36},
  {name:'T. Nakamura',realName:'Takeshi Nakamura',firm:'Pacific Energy',team:null,ret:-0.5,winRate:43,pf:0.95,trades:22}
];

/* =====================================================================
   PRICE ENGINE
   ===================================================================== */
function genHistory(base, days, vol) {
  const h = [base];
  for (let i = 1; i < days; i++) {
    let p = h[i-1] + (Math.random()-0.5) * 2 * (base * vol/100 / 15);
    if (p < base * 0.4) p = base * 0.4;
    h.push(p);
  }
  return h;
}

function initPrices() {
  for (const [sector, hubs] of Object.entries(ALL_HUB_SETS)) {
    hubs.forEach(h => {
      priceHistory[h.name] = genHistory(h.base, 180, h.vol);
      STATE.visibleHubs[h.name] = true;
    });
  }
  initForwardCurves();
}

function tickPrices() {
  for (const [sector, hubs] of Object.entries(ALL_HUB_SETS)) {
    hubs.forEach(h => {
      const hist = priceHistory[h.name];
      const last = hist[hist.length - 1];
      let next = last + (Math.random()-0.5) * 2 * (h.base * h.vol/100 / 15);
      if (next < h.base * 0.4) next = h.base * 0.4;
      hist.push(next);
      if (hist.length > 200) hist.shift();
    });
  }
  tickForwardCurves();
  renderCurrentPage();
}

function initForwardCurves() {
  for (const [sector, hubs] of Object.entries(ALL_HUB_SETS)) {
    hubs.forEach(h => {
      const curve = [];
      const spot = priceHistory[h.name][priceHistory[h.name].length - 1];
      for (let m = 0; m < 12; m++) {
        const seasonal = Math.sin((m + 1) / 12 * Math.PI * 2) * (h.base * 0.03);
        const contango = m * (h.base * 0.002);
        curve.push({ price: spot + seasonal + contango + (Math.random()-0.5)*h.base*0.01, oi: Math.floor(5000 + Math.random()*50000) });
      }
      STATE.forwardCurves[h.name] = curve;
    });
  }
}

function tickForwardCurves() {
  for (const name in STATE.forwardCurves) {
    const hub = findHub(name);
    if (!hub) continue;
    STATE.forwardCurves[name].forEach(pt => {
      pt.price += (Math.random()-0.5) * 2 * (hub.base * hub.vol/100 / 50);
      if (pt.price < hub.base * 0.3) pt.price = hub.base * 0.3;
      pt.oi += Math.floor((Math.random()-0.5) * 200);
      if (pt.oi < 100) pt.oi = 100;
    });
  }
}

function findHub(name) {
  for (const hubs of Object.values(ALL_HUB_SETS)) {
    const h = hubs.find(x => x.name === name);
    if (h) return h;
  }
  return null;
}

function getPrice(name) {
  const h = priceHistory[name];
  return h ? h[h.length - 1] : 0;
}

function getPriceChange(name) {
  const h = priceHistory[name];
  if (!h || h.length < 2) return 0;
  return h[h.length - 1] - h[h.length - 2];
}

function getPriceChangePct(name) {
  const h = priceHistory[name];
  if (!h || h.length < 2) return 0;
  return ((h[h.length-1] - h[h.length-2]) / h[h.length-2]) * 100;
}

function getSelectedHub(sector) { return STATE.selectedHubs[sector]; }
function setSelectedHub(sector, name) { STATE.selectedHubs[sector] = name; renderCurrentPage(); }

/* =====================================================================
   CHART RENDERING
   ===================================================================== */
function drawChart(canvasId, hubName, range) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !canvas.parentElement) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  const rect = canvas.parentElement.getBoundingClientRect();
  if (!rect || !rect.width) return;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = 300 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '300px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 300;

  const hub = findHub(hubName);
  const hist = priceHistory[hubName];
  if (!hist || !hub) return;

  const data = hist.slice(-range);
  if (data.length < 2) return;

  const min = Math.min(...data) * 0.998;
  const max = Math.max(...data) * 1.002;
  const padL = 65, padR = 35, padT = 20, padB = 40;
  const cW = W - padL - padR, cH = H - padT - padB;

  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  const bgColor = isLight ? '#ffffff' : getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
  const gridColor = isLight ? '#e2e8f0' : 'rgba(30,45,61,0.6)';
  const textColor = isLight ? '#475569' : '#94a3b8';

  // Background
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, W, H);

  // Grid lines
  ctx.strokeStyle = gridColor;
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 5; i++) {
    const y = padT + (cH / 5) * i;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
    const val = max - (max - min) * (i / 5);
    ctx.fillStyle = textColor;
    ctx.font = '11px IBM Plex Mono';
    ctx.textAlign = 'right';
    ctx.fillText(val.toFixed(hubName.includes('Baltic') || hubName.includes('Index') ? 0 : 2), padL - 8, y + 4);
  }

  // Gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, H - padB);
  grad.addColorStop(0, hub.color + '30');
  grad.addColorStop(1, hub.color + '00');
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = padL + (i / (data.length - 1)) * cW;
    const y = padT + (1 - (data[i] - min) / (max - min)) * cH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.lineTo(padL + cW, padT + cH);
  ctx.lineTo(padL, padT + cH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = padL + (i / (data.length - 1)) * cW;
    const y = padT + (1 - (data[i] - min) / (max - min)) * cH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.strokeStyle = hub.color;
  ctx.lineWidth = 2;
  ctx.stroke();

  // Current price dot
  const lastX = padL + cW;
  const lastY = padT + (1 - (data[data.length-1] - min) / (max - min)) * cH;
  ctx.beginPath(); ctx.arc(lastX, lastY, 4, 0, Math.PI * 2); ctx.fillStyle = hub.color; ctx.fill();

  // X-axis time labels
  ctx.fillStyle = textColor;
  ctx.font = '10px IBM Plex Mono';
  ctx.textAlign = 'center';
  const now = new Date();
  const labelCount = Math.min(6, data.length);
  for (let i = 0; i < labelCount; i++) {
    const idx = Math.floor(i * (data.length - 1) / (labelCount - 1));
    const x = padL + (idx / (data.length - 1)) * cW;
    const daysBack = data.length - 1 - idx;
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const label = labelDate.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    ctx.fillText(label, x, H - padB + 18);
  }

  // Store chart meta for crosshair
  canvas._chartMeta = { padL, padR, padT, padB, cW, cH, min, max, data, hubName, hub };
}

// Crosshair handler
function initChartCrosshair(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || canvas._crosshairInit) return;
  canvas._crosshairInit = true;

  canvas.addEventListener('mousemove', e => {
    const meta = canvas._chartMeta;
    if (!meta) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const { padL, padR, padT, cW, cH, min, max, data, hub, hubName } = meta;

    if (mx < padL || mx > padL + cW) {
      drawChart(canvasId, hubName, STATE.chartRanges[canvasId.replace('Chart','')]);
      return;
    }

    // Find nearest data index from mouse X
    const idx = Math.round(((mx - padL) / cW) * (data.length - 1));
    const clampIdx = Math.max(0, Math.min(data.length - 1, idx));
    const price = data[clampIdx];
    const range = max - min || 1;

    // Snap positions
    const snapX = padL + (clampIdx / (data.length - 1)) * cW;
    const snapY = padT + (1 - (price - min) / range) * cH;

    // Redraw base chart
    drawChart(canvasId, hubName, STATE.chartRanges[canvasId.replace('Chart','')]);
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    ctx.save();
    ctx.scale(dpr, dpr);

    // Vertical line at snapped X
    ctx.strokeStyle = 'rgba(148,163,184,0.4)';
    ctx.lineWidth = 0.5;
    ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(snapX, padT); ctx.lineTo(snapX, padT + cH); ctx.stroke();
    // Horizontal line at snapped Y
    ctx.beginPath(); ctx.moveTo(padL, snapY); ctx.lineTo(padL + cW, snapY); ctx.stroke();
    ctx.setLineDash([]);

    // Snap dot on the line
    ctx.beginPath(); ctx.arc(snapX, snapY, 5, 0, Math.PI * 2);
    ctx.fillStyle = hub.color; ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();

    // Tooltip with price
    const isLarge = hubName.includes('Baltic') || hubName.includes('Index');
    const txt = isLarge ? price.toFixed(0) : price.toFixed(2);
    ctx.font = '12px IBM Plex Mono';
    const tw = ctx.measureText(txt).width + 16;
    // Position tooltip — flip side if near right edge
    const tipX = snapX + 12 + tw > padL + cW ? snapX - tw - 12 : snapX + 12;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(tipX, snapY - 12, tw, 22);
    ctx.strokeStyle = hub.color; ctx.lineWidth = 1;
    ctx.strokeRect(tipX, snapY - 12, tw, 22);
    ctx.fillStyle = hub.color;
    ctx.textAlign = 'left';
    ctx.fillText(txt, tipX + 8, snapY + 4);

    // Date label at bottom
    const now = new Date();
    const daysBack = data.length - 1 - clampIdx;
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const dateStr = labelDate.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    ctx.font = '10px IBM Plex Mono';
    const dtw = ctx.measureText(dateStr).width + 10;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(snapX - dtw/2, padT + cH + 2, dtw, 18);
    ctx.fillStyle = '#e2e8f0';
    ctx.textAlign = 'center';
    ctx.fillText(dateStr, snapX, padT + cH + 14);

    ctx.restore();
  });

  canvas.addEventListener('mouseleave', () => {
    const meta = canvas._chartMeta;
    if (meta) drawChart(canvasId, meta.hubName, STATE.chartRanges[canvasId.replace('Chart','')]);
  });

  // Click to set entry price (snaps to data)
  canvas.addEventListener('click', e => {
    const meta = canvas._chartMeta;
    if (!meta) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const { padL, cW, data, hubName } = meta;
    const idx = Math.round(((mx - padL) / cW) * (data.length - 1));
    const clampIdx = Math.max(0, Math.min(data.length - 1, idx));
    const price = data[clampIdx];
    STATE.clickedPrice = parseFloat(price.toFixed(hubName.includes('Baltic') ? 0 : 4));
    toast('Entry price captured: ' + STATE.clickedPrice, 'info');
  });
}

function setRange(sector, days, btn) {
  STATE.chartRanges[sector] = days;
  btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCurrentPage();
}

/* =====================================================================
   SPARKLINE SVG
   ===================================================================== */
function sparklineSVG(data, color, w, h) {
  if (!data || data.length < 2) return '';
  const d = data.slice(-30);
  const min = Math.min(...d), max = Math.max(...d);
  const range = max - min || 1;
  const pts = d.map((v, i) => `${(i/(d.length-1))*w},${h - ((v-min)/range)*h}`).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5"/></svg>`;
}

/* =====================================================================
   RENDER FUNCTIONS — NATURAL GAS
   ===================================================================== */
function renderNGPage() {
  // Toggle bar
  const toggleBar = document.getElementById('ngToggles');
  toggleBar.innerHTML = NG_HUBS.map(h =>
    `<button class="hub-toggle ${STATE.visibleHubs[h.name]?'on':''}" onclick="toggleHub('${h.name}')" style="${STATE.visibleHubs[h.name]?'background:'+h.color+';color:#000;border-color:'+h.color:''}">${h.name}</button>`
  ).join('');

  // Bench grid
  const grid = document.getElementById('ngBenchGrid');
  grid.innerHTML = NG_HUBS.filter(h => STATE.visibleHubs[h.name]).map(h => {
    const p = getPrice(h.name), c = getPriceChange(h.name), cp = getPriceChangePct(h.name);
    const sel = STATE.selectedHubs.ng === h.name ? 'selected' : '';
    return `<div class="bench-card ${sel}" onclick="setSelectedHub('ng','${h.name}')">
      <div class="hub-name" style="color:${h.color}">${h.name}</div>
      <div class="hub-price">$${p.toFixed(2)}</div>
      <div class="hub-change ${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(3)} (${cp>=0?'+':''}${cp.toFixed(2)}%)</div>
      <div class="sparkline">${sparklineSVG(priceHistory[h.name], h.color, 150, 24)}</div>
    </div>`;
  }).join('');

  // Chart
  const selHub = STATE.selectedHubs.ng;
  document.getElementById('ngChartTitle').textContent = selHub;
  try { drawChart('ngChart', selHub, STATE.chartRanges.ng);
  initChartCrosshair('ngChart'); } catch(e) { console.error('NG chart error:', e); }

  // Basis table
  const henry = getPrice('Henry Hub');
  const basisTbody = document.querySelector('#ngBasisTable tbody');
  basisTbody.innerHTML = NG_HUBS.map(h => {
    const p = getPrice(h.name), basis = p - henry, c = getPriceChange(h.name);
    const hist30 = (priceHistory[h.name]||[]).slice(-30);
    const henryHist30 = (priceHistory['Henry Hub']||[]).slice(-30);
    const avg30 = hist30.reduce((s,v,i) => s + (v - (henryHist30[i]||henry)), 0) / hist30.length;
    return `<tr>
      <td style="color:${h.color};font-weight:600">${h.name}</td>
      <td class="mono">$${p.toFixed(3)}</td>
      <td class="mono ${basis>=0?'green':'red'}">${basis>=0?'+':''}${basis.toFixed(3)}</td>
      <td class="mono ${c>=0?'green':'red'}">${c>=0?'+':''}${c.toFixed(3)}</td>
      <td class="mono">${avg30>=0?'+':''}${avg30.toFixed(3)}</td>
    </tr>`;
  }).join('');

  // Forward curve
  document.getElementById('ngFwdTitle').textContent = selHub;
  const fwd = STATE.forwardCurves[selHub] || [];
  const fwdTbody = document.querySelector('#ngFwdTable tbody');
  const now = new Date();
  fwdTbody.innerHTML = fwd.map((pt, i) => {
    const mDate = new Date(now.getFullYear(), now.getMonth() + i + 1, 1);
    const mLabel = mDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    const prevPrice = i > 0 ? fwd[i-1].price : getPrice(selHub);
    const change = pt.price - prevPrice;
    return `<tr>
      <td>${mLabel}</td>
      <td class="mono">$${pt.price.toFixed(3)}</td>
      <td class="mono ${change>=0?'green':'red'}">${change>=0?'+':''}${change.toFixed(3)}</td>
      <td class="mono">${pt.oi.toLocaleString()}</td>
    </tr>`;
  }).join('');

  // News
  renderNews('ng', 'ngNews');

  // Calendar
  renderCalendar('ngCalendar', 'ng');

  // Refresh map if visible
  if (MAP_STATE.ng) renderPipelineMap('ng');
}

function toggleHub(name) {
  STATE.visibleHubs[name] = !STATE.visibleHubs[name];
  renderCurrentPage();
}

/* =====================================================================
   RENDER FUNCTIONS — CRUDE OIL
   ===================================================================== */
function renderCrudePage() {
  // Toggle bar
  const toggleBar = document.getElementById('crudeToggles');
  if (!toggleBar) return;
  toggleBar.innerHTML = CRUDE_HUBS.map(h =>
    `<button class="hub-toggle ${STATE.visibleHubs[h.name]?'on':''}" onclick="toggleHub('${h.name}')" style="${STATE.visibleHubs[h.name]?'background:'+h.color+';color:#000;border-color:'+h.color:''}">${h.name}</button>`
  ).join('');

  // Bench grid
  const grid = document.getElementById('crudeBenchGrid');
  grid.innerHTML = CRUDE_HUBS.filter(h => STATE.visibleHubs[h.name]).map(h => {
    const p = getPrice(h.name), c = getPriceChange(h.name), cp = getPriceChangePct(h.name);
    const sel = STATE.selectedHubs.crude === h.name ? 'selected' : '';
    return `<div class="bench-card ${sel}" onclick="setSelectedHub('crude','${h.name}')">
      <div class="hub-name" style="color:${h.color}">${h.name}</div>
      <div class="hub-price">$${p.toFixed(2)}</div>
      <div class="hub-change ${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(2)} (${cp>=0?'+':''}${cp.toFixed(2)}%)</div>
      <div class="sparkline">${sparklineSVG(priceHistory[h.name], h.color, 150, 24)}</div>
    </div>`;
  }).join('');

  // Chart
  const selHub = STATE.selectedHubs.crude;
  document.getElementById('crudeChartTitle').textContent = selHub;
  try { drawChart('crudeChart', selHub, STATE.chartRanges.crude);
  initChartCrosshair('crudeChart'); } catch(e) { console.error('Crude chart error:', e); }

  // Differentials table vs WTI Cushing
  const wti = getPrice('WTI Cushing');
  const diffTbody = document.querySelector('#crudeDiffTable tbody');
  diffTbody.innerHTML = CRUDE_HUBS.map(h => {
    const p = getPrice(h.name), diff = p - wti, c = getPriceChange(h.name);
    const hist30 = (priceHistory[h.name]||[]).slice(-30);
    const wtiHist30 = (priceHistory['WTI Cushing']||[]).slice(-30);
    const avg30 = hist30.reduce((s,v,i) => s + (v - (wtiHist30[i]||wti)), 0) / hist30.length;
    return `<tr>
      <td style="color:${h.color};font-weight:600">${h.name}</td>
      <td class="mono">$${p.toFixed(2)}</td>
      <td class="mono ${diff>=0?'green':'red'}">${diff>=0?'+':''}${diff.toFixed(2)}</td>
      <td class="mono ${c>=0?'green':'red'}">${c>=0?'+':''}${c.toFixed(2)}</td>
      <td class="mono">${avg30>=0?'+':''}${avg30.toFixed(2)}</td>
    </tr>`;
  }).join('');

  // Forward curve
  document.getElementById('crudeFwdTitle').textContent = selHub;
  const fwd = STATE.forwardCurves[selHub] || [];
  const fwdTbody = document.querySelector('#crudeFwdTable tbody');
  const now = new Date();
  fwdTbody.innerHTML = fwd.map((pt, i) => {
    const mDate = new Date(now.getFullYear(), now.getMonth() + i + 1, 1);
    const mLabel = mDate.toLocaleDateString('en-US', { month:'short', year:'numeric' });
    const prevPrice = i > 0 ? fwd[i-1].price : getPrice(selHub);
    const change = pt.price - prevPrice;
    return `<tr>
      <td>${mLabel}</td>
      <td class="mono">$${pt.price.toFixed(2)}</td>
      <td class="mono ${change>=0?'green':'red'}">${change>=0?'+':''}${change.toFixed(2)}</td>
      <td class="mono">${pt.oi.toLocaleString()}</td>
    </tr>`;
  }).join('');

  // News
  renderNews('crude', 'crudeNews');

  // Calendar
  renderCalendar('crudeCalendar', 'crude');

  // Refresh map if visible
  if (MAP_STATE.crude) renderPipelineMap('crude');
}

/* =====================================================================
   RENDER FUNCTIONS — POWER
   ===================================================================== */
function renderPowerPage() {
  // Toggle bar
  const toggleBar = document.getElementById('powerToggles');
  if (!toggleBar) return;
  toggleBar.innerHTML = POWER_HUBS.map(h =>
    `<button class="hub-toggle ${STATE.visibleHubs[h.name]?'on':''}" onclick="toggleHub('${h.name}')" style="${STATE.visibleHubs[h.name]?'background:'+h.color+';color:#000;border-color:'+h.color:''}">${h.name}</button>`
  ).join('');

  // Bench grid
  const grid = document.getElementById('powerBenchGrid');
  grid.innerHTML = POWER_HUBS.filter(h => STATE.visibleHubs[h.name]).map(h => {
    const p = getPrice(h.name), c = getPriceChange(h.name), cp = getPriceChangePct(h.name);
    const sel = STATE.selectedHubs.power === h.name ? 'selected' : '';
    return `<div class="bench-card ${sel}" onclick="setSelectedHub('power','${h.name}')">
      <div class="hub-name" style="color:${h.color}">${h.name}</div>
      <div class="hub-price">$${p.toFixed(2)}</div>
      <div class="hub-change ${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(2)} (${cp>=0?'+':''}${cp.toFixed(2)}%)</div>
      <div class="sparkline">${sparklineSVG(priceHistory[h.name], h.color, 150, 24)}</div>
    </div>`;
  }).join('');

  // Chart
  const selHub = STATE.selectedHubs.power;
  document.getElementById('powerChartTitle').textContent = selHub;
  try { drawChart('powerChart', selHub, STATE.chartRanges.power);
  initChartCrosshair('powerChart'); } catch(e) { console.error('Power chart error:', e); }

  // Spark Spread table
  const HEAT_RATE = 7.0;
  const sparkTbody = document.querySelector('#powerSparkTable tbody');
  sparkTbody.innerHTML = POWER_HUBS.map(h => {
    const powerPrice = getPrice(h.name);
    const gasPrice = getPrice(h.gasRef);
    const gasCostMwh = gasPrice * HEAT_RATE;
    const spark = powerPrice - gasCostMwh;
    return `<tr>
      <td style="color:${h.color};font-weight:600">${h.name}</td>
      <td class="mono">$${powerPrice.toFixed(2)}</td>
      <td style="color:var(--text-dim);font-size:12px">${h.gasRef}</td>
      <td class="mono">$${gasPrice.toFixed(3)}</td>
      <td class="mono">$${gasCostMwh.toFixed(2)}</td>
      <td class="mono ${spark>=0?'green':'red'}" style="font-weight:700">${spark>=0?'+':''}$${spark.toFixed(2)}</td>
    </tr>`;
  }).join('');

  // Forward curve
  document.getElementById('powerFwdTitle').textContent = selHub;
  const fwd = STATE.forwardCurves[selHub] || [];
  const fwdTbody = document.querySelector('#powerFwdTable tbody');
  const now = new Date();
  fwdTbody.innerHTML = fwd.map((pt, i) => {
    const mDate = new Date(now.getFullYear(), now.getMonth() + i + 1, 1);
    const mLabel = mDate.toLocaleDateString('en-US', { month:'short', year:'numeric' });
    const prevPrice = i > 0 ? fwd[i-1].price : getPrice(selHub);
    const change = pt.price - prevPrice;
    return `<tr>
      <td>${mLabel}</td>
      <td class="mono">$${pt.price.toFixed(2)}</td>
      <td class="mono ${change>=0?'green':'red'}">${change>=0?'+':''}${change.toFixed(2)}</td>
      <td class="mono">${pt.oi.toLocaleString()}</td>
    </tr>`;
  }).join('');

  // News
  renderNews('power', 'powerNews');

  // Calendar
  renderCalendar('powerCalendar', 'power');
}

/* =====================================================================
   RENDER FUNCTIONS — FREIGHT
   ===================================================================== */
function renderFreightPage() {
  const toggleBar = document.getElementById('freightToggles');
  if (!toggleBar) return;
  toggleBar.innerHTML = FREIGHT_HUBS.map(h =>
    `<button class="hub-toggle ${STATE.visibleHubs[h.name]?'on':''}" onclick="toggleHub('${h.name}')" style="${STATE.visibleHubs[h.name]?'background:'+h.color+';color:#000;border-color:'+h.color:''}">${h.name}</button>`
  ).join('');

  const grid = document.getElementById('freightBenchGrid');
  grid.innerHTML = FREIGHT_HUBS.filter(h => STATE.visibleHubs[h.name]).map(h => {
    const p = getPrice(h.name), c = getPriceChange(h.name), cp = getPriceChangePct(h.name);
    const sel = STATE.selectedHubs.freight === h.name ? 'selected' : '';
    const isIdx = h.base > 100;
    return `<div class="bench-card ${sel}" onclick="setSelectedHub('freight','${h.name}')">
      <div class="hub-name" style="color:${h.color}">${h.name}</div>
      <div class="hub-price">${isIdx ? p.toFixed(0) : '$'+p.toFixed(2)}</div>
      <div class="hub-change ${c>=0?'up':'down'}">${c>=0?'+':''}${isIdx?c.toFixed(0):c.toFixed(2)} (${cp>=0?'+':''}${cp.toFixed(2)}%)</div>
      <div class="sparkline">${sparklineSVG(priceHistory[h.name], h.color, 150, 24)}</div>
    </div>`;
  }).join('');

  const selHub = STATE.selectedHubs.freight;
  document.getElementById('freightChartTitle').textContent = selHub;
  try { drawChart('freightChart', selHub, STATE.chartRanges.freight);
  initChartCrosshair('freightChart'); } catch(e) { console.error('Freight chart error:', e); }

  // Differentials table vs BDI
  const bdi = getPrice('Baltic Dry Index');
  const diffTbody = document.querySelector('#freightDiffTable tbody');
  diffTbody.innerHTML = FREIGHT_HUBS.map(h => {
    const p = getPrice(h.name), c = getPriceChange(h.name);
    const isIdx = h.base > 100;
    const diff = isIdx ? p - bdi : p; // tanker rates aren't comparable to BDI directly
    const diffLabel = h.name === 'Baltic Dry Index' ? '—' : (isIdx ? (diff>=0?'+':'')+diff.toFixed(0) : '$'+p.toFixed(2));
    const hist30 = (priceHistory[h.name]||[0]).slice(-30);
    const avg = hist30.length ? hist30.reduce((s,v)=>s+v,0)/hist30.length : 0;
    return `<tr>
      <td style="color:${h.color};font-weight:600">${h.name}</td>
      <td class="mono">${isIdx ? p.toFixed(0) : '$'+p.toFixed(2)}</td>
      <td class="mono">${diffLabel}</td>
      <td class="mono ${c>=0?'green':'red'}">${c>=0?'+':''}${isIdx?c.toFixed(0):c.toFixed(2)}</td>
      <td class="mono">${isIdx ? avg.toFixed(0) : '$'+avg.toFixed(2)}</td>
    </tr>`;
  }).join('');

  // Forward curve
  document.getElementById('freightFwdTitle').textContent = selHub;
  const fwd = STATE.forwardCurves[selHub] || [];
  const fwdTbody = document.querySelector('#freightFwdTable tbody');
  const now = new Date();
  const isIdx = findHub(selHub) && findHub(selHub).base > 100;
  fwdTbody.innerHTML = fwd.map((pt, i) => {
    const mDate = new Date(now.getFullYear(), now.getMonth() + i + 1, 1);
    const mLabel = mDate.toLocaleDateString('en-US', { month:'short', year:'numeric' });
    const prevPrice = i > 0 ? fwd[i-1].price : getPrice(selHub);
    const change = pt.price - prevPrice;
    return `<tr>
      <td>${mLabel}</td>
      <td class="mono">${isIdx ? pt.price.toFixed(0) : '$'+pt.price.toFixed(2)}</td>
      <td class="mono ${change>=0?'green':'red'}">${change>=0?'+':''}${isIdx?change.toFixed(0):change.toFixed(2)}</td>
      <td class="mono">${pt.oi.toLocaleString()}</td>
    </tr>`;
  }).join('');

  renderNews('freight', 'freightNews');
  renderCalendar('freightCalendar', 'freight');
}

/* =====================================================================
   RENDER FUNCTIONS — TRADE BLOTTER
   ===================================================================== */
let tradeDirection = '';
let blotterPage = 0;
const BLOTTER_PAGE_SIZE = 10;

function renderBlotterPage() {
  updateAccountBar();
  populateHubDropdown();
  updateMarginPreview();
  renderBlotterTable();
  renderNetPositions();
  drawPnlChart();
  try { initPnlCrosshair(); } catch(e) {}

  // Pre-fill entry price if clicked from chart
  if (STATE.clickedPrice !== null) {
    document.getElementById('tradeEntry').value = STATE.clickedPrice;
    document.getElementById('tradeFormHint').textContent = 'Entry price captured from chart: ' + STATE.clickedPrice;
    STATE.clickedPrice = null;
  }

  // Update spot ref
  const hub = document.getElementById('tradeHub').value;
  if (hub) document.getElementById('tradeSpot').value = getPrice(hub).toFixed(4);
}

function updateAccountBar() {
  const balance = STATE.settings.balance || 1000000;
  let realized = 0, unrealized = 0, wins = 0, losses = 0, openCount = 0;

  STATE.trades.forEach(t => {
    if (t.status === 'CLOSED') {
      const pnl = parseFloat(t.realizedPnl || 0);
      realized += pnl;
      if (pnl > 0) wins++; else if (pnl < 0) losses++;
    } else if (t.status === 'OPEN') {
      openCount++;
      const spot = getPrice(t.hub);
      const dir = t.direction === 'BUY' ? 1 : -1;
      const vol = parseFloat(t.volume || 0);
      const entry = parseFloat(t.entryPrice || 0);
      unrealized += (spot - entry) * vol * dir;
    }
  });

  const equity = balance + realized + unrealized;
  const usedMargin = STATE.trades.filter(t=>t.status==='OPEN').reduce((s,t)=>s+calcMargin(t),0);
  const buyingPower = equity - usedMargin;
  const wr = (wins+losses) > 0 ? ((wins/(wins+losses))*100).toFixed(1)+'%' : '—';

  const fmt = v => '$' + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
  const sign = v => v >= 0 ? '' : '-';

  document.getElementById('acctBalance').textContent = fmt(equity);
  document.getElementById('acctBalance').style.color = '';

  const uel = document.getElementById('acctUnrealized');
  uel.textContent = sign(unrealized) + fmt(unrealized);
  uel.style.color = unrealized >= 0 ? 'var(--green)' : 'var(--red)';

  const rel = document.getElementById('acctRealized');
  rel.textContent = sign(realized) + fmt(realized);
  rel.style.color = realized >= 0 ? 'var(--green)' : 'var(--red)';

  document.getElementById('acctBuyingPower').textContent = fmt(buyingPower);
  document.getElementById('acctBuyingPower').style.color = buyingPower > 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('acctOpenPos').textContent = openCount;
  document.getElementById('acctWinRate').textContent = wr;
}

function populateHubDropdown() {
  const sel = document.getElementById('tradeHub');
  const type = document.getElementById('tradeType').value;
  const curVal = sel.value;

  let hubs;
  if (type.startsWith('CRUDE') || type === 'EFP' || type === 'OPTION_CL') hubs = CRUDE_HUBS;
  else if (type.startsWith('FREIGHT')) hubs = FREIGHT_HUBS;
  else hubs = NG_HUBS;

  sel.innerHTML = hubs.map(h => `<option value="${h.name}" ${h.name===curVal?'selected':''}>${h.name}</option>`).join('');

  // Also populate basis hub dropdown
  const basisSel = document.getElementById('tradeBasisHub');
  if (basisSel) basisSel.innerHTML = NG_HUBS.map(h => `<option value="${h.name}">${h.name}</option>`).join('');

  // Update spot reference
  const hub = sel.value;
  if (hub) document.getElementById('tradeSpot').value = getPrice(hub).toFixed(4);
}

function onTradeTypeChange() {
  const type = document.getElementById('tradeType').value;
  populateHubDropdown();

  // Show/hide conditional fields
  const condDiv = document.getElementById('conditionalFields');
  condDiv.style.display = 'none';
  condDiv.querySelectorAll('.form-group').forEach(fg => fg.style.display = 'none');

  if (['SPREAD','CRUDE_DIFF'].includes(type)) {
    condDiv.style.display = 'block';
    condDiv.querySelectorAll('.cond-spread').forEach(fg => fg.style.display = 'flex');
    if (type === 'CRUDE_DIFF') condDiv.querySelectorAll('.cond-diff').forEach(fg => fg.style.display = 'flex');
  }
  if (['OPTION_NG','OPTION_CL'].includes(type)) {
    condDiv.style.display = 'block';
    condDiv.querySelectorAll('.cond-option').forEach(fg => fg.style.display = 'flex');
  }
  if (type === 'BASIS_SWAP') {
    condDiv.style.display = 'block';
    condDiv.querySelectorAll('.cond-basis').forEach(fg => fg.style.display = 'flex');
  }
  updateMarginPreview();
}

function setDirection(dir) {
  tradeDirection = dir;
  const buyBtn = document.getElementById('dirBuy');
  const sellBtn = document.getElementById('dirSell');
  const hint = document.getElementById('priceHint');
  if (dir === 'BUY') {
    buyBtn.style.background = 'var(--green)'; buyBtn.style.color = '#fff'; buyBtn.style.borderColor = 'var(--green)';
    sellBtn.style.background = 'var(--surface2)'; sellBtn.style.color = 'var(--text-dim)'; sellBtn.style.borderColor = 'var(--border)';
    if(hint) hint.textContent = '(at or above spot for BUY)';
  } else if (dir === 'SELL') {
    sellBtn.style.background = 'var(--red)'; sellBtn.style.color = '#fff'; sellBtn.style.borderColor = 'var(--red)';
    buyBtn.style.background = 'var(--surface2)'; buyBtn.style.color = 'var(--text-dim)'; buyBtn.style.borderColor = 'var(--border)';
    if(hint) hint.textContent = '(at or below spot for SELL)';
  } else {
    buyBtn.style.background = 'var(--surface2)'; buyBtn.style.color = 'var(--text-dim)'; buyBtn.style.borderColor = 'var(--border)';
    sellBtn.style.background = 'var(--surface2)'; sellBtn.style.color = 'var(--text-dim)'; sellBtn.style.borderColor = 'var(--border)';
    if(hint) hint.textContent = '';
  }
}

function calcMargin(t) {
  const vol = parseFloat(t.volume || 0);
  const type = t.type || '';
  const isCrude = type.startsWith('CRUDE') || type === 'EFP' || type === 'OPTION_CL';
  if (isCrude) return (vol / 1000) * 5000;
  if (type === 'BASIS_SWAP') return (vol / 10000) * 800;
  if (type === 'OPTION_NG') return (vol / 10000) * 1500 * 0.5;
  if (type === 'OPTION_CL') return (vol / 1000) * 5000 * 0.5;
  if (type.startsWith('FREIGHT')) return (vol / 1000) * 2000;
  return (vol / 10000) * 1500;
}

function updateMarginPreview() {
  const type = document.getElementById('tradeType').value;
  const vol = parseFloat(document.getElementById('tradeVolume').value || 0);
  const mockTrade = { type, volume: vol };
  const reqMargin = calcMargin(mockTrade);

  const balance = STATE.settings.balance || 1000000;
  let realized = 0;
  STATE.trades.forEach(t => { if (t.status === 'CLOSED') realized += parseFloat(t.realizedPnl || 0); });
  const usedMargin = STATE.trades.filter(t=>t.status==='OPEN').reduce((s,t)=>s+calcMargin(t),0);
  const equity = balance + realized;
  const available = equity - usedMargin;

  document.getElementById('marginRequired').textContent = '$' + reqMargin.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('marginAvailable').textContent = '$' + available.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('marginAvailable').style.color = available > reqMargin ? 'var(--green)' : 'var(--red)';
  const util = equity > 0 ? (((usedMargin + reqMargin) / equity) * 100).toFixed(1) : '0.0';
  document.getElementById('marginUtil').textContent = util + '%';
}

// Listen for volume/type changes to update margin
document.getElementById('tradeVolume').addEventListener('input', updateMarginPreview);
document.getElementById('tradeHub').addEventListener('change', function() {
  const price = getPrice(this.value);
  document.getElementById('tradeSpot').value = price.toFixed(4);
  document.getElementById('tradeEntry').value = price.toFixed(4);
});

async function submitTrade() {
  const type = document.getElementById('tradeType').value;
  const hub = document.getElementById('tradeHub').value;
  const volume = document.getElementById('tradeVolume').value;

  if (!type) return toast('Select a trade type', 'error');
  if (!tradeDirection) return toast('Select BUY or SELL', 'error');
  if (!hub) return toast('Select a hub', 'error');
  if (!volume || parseFloat(volume) <= 0) return toast('Enter a valid volume', 'error');

  // Get spot price and validate entry price
  const spotPrice = getPrice(hub);
  if (!spotPrice || spotPrice <= 0) return toast('No market price available', 'error');
  const enteredPrice = parseFloat(document.getElementById('tradeEntry').value);
  const currentPrice = (enteredPrice && enteredPrice > 0) ? enteredPrice : spotPrice;

  // Validate: BUY at or above spot, SELL at or below spot
  if (tradeDirection === 'BUY' && currentPrice < spotPrice) {
    return toast('BUY price must be at or above spot ($' + spotPrice.toFixed(4) + ')', 'error');
  }
  if (tradeDirection === 'SELL' && currentPrice > spotPrice) {
    return toast('SELL price must be at or below spot ($' + spotPrice.toFixed(4) + ')', 'error');
  }

  const trade = {
    type, direction: tradeDirection, hub,
    volume: parseFloat(volume), entryPrice: currentPrice,
    spotRef: spotPrice,
    deliveryMonth: document.getElementById('tradeDelivery').value,
    counterparty: document.getElementById('tradeCpty').value,
    stopLoss: document.getElementById('tradeStop').value || null,
    targetExit: document.getElementById('tradeTarget').value || null,
    venue: document.getElementById('tradeVenue').value,
    notes: document.getElementById('tradeNotes').value,
    status: 'OPEN',
    timestamp: new Date().toISOString()
  };

  // Market hours check for exchange trades
  const venue = trade.venue;
  const isExchange = venue && venue !== 'OTC';
  if (isExchange && !MARKET_OPEN) {
    return toast('Exchange is closed (' + MARKET_REASON + '). Use OTC or wait for market open.', 'error');
  }

  // OTC bilateral routing
  const cptyTrader = document.getElementById('tradeCpty').value;
  const isOtcBilateral = cptyTrader && cptyTrader.length > 0;

  // Conditional fields
  if (['SPREAD','CRUDE_DIFF'].includes(type)) {
    trade.nearMonth = document.getElementById('tradeNearMonth').value;
    trade.farMonth = document.getElementById('tradeFarMonth').value;
  }
  if (['OPTION_NG','OPTION_CL'].includes(type)) {
    trade.strike = document.getElementById('tradeStrike').value;
    trade.expiry = document.getElementById('tradeExpiry').value;
    trade.callPut = document.getElementById('tradeCallPut').value;
    trade.premium = document.getElementById('tradePremium').value;
  }
  if (type === 'BASIS_SWAP') {
    trade.basisHub = document.getElementById('tradeBasisHub').value;
  }

  // Try server submission
  if (STATE.connected && STATE.trader) {
    try {
      let url, body;
      if (isOtcBilateral) {
        url = API_BASE + '/api/trades/otc/' + STATE.trader.trader_name;
        body = JSON.stringify({...trade, counterparty: cptyTrader});
      } else {
        url = API_BASE + '/api/trades/' + STATE.trader.trader_name;
        body = JSON.stringify(trade);
      }
      const r = await fetch(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body
      });
      const d = await r.json();
      if (!d.success) { toast(d.error || 'Trade rejected by server', 'error'); return; }
      trade.id = d.trade_id;
      if (isOtcBilateral) {
        const cptyInfo = OTC_COUNTERPARTIES.find(c=>c.trader_name===cptyTrader);
        toast('OTC trade executed with ' + (cptyInfo?cptyInfo.display_name:cptyTrader) + '. Mirror position created.', 'success');
      }
    } catch { /* fallback to local */ }
  }

  // Store locally
  if (!trade.id) trade.id = Date.now();
  STATE.trades.unshift(trade);
  localStorage.setItem('ng_trades', JSON.stringify(STATE.trades));

  playSound('trade');
  toast('Trade submitted: ' + tradeDirection + ' ' + volume + ' ' + hub, 'success');

  // Reset form
  document.getElementById('tradeType').value = '';
  document.getElementById('tradeVolume').value = '';
  document.getElementById('tradeEntry').value = '';
  document.getElementById('tradeCpty').value = '';
  document.getElementById('tradeNotes').value = '';
  document.getElementById('tradeStop').value = '';
  document.getElementById('tradeTarget').value = '';
  document.getElementById('tradeFormHint').textContent = '';
  tradeDirection = '';
  setDirection('');
  document.getElementById('dirBuy').style.background = 'var(--surface2)';
  document.getElementById('dirBuy').style.color = 'var(--text-dim)';
  document.getElementById('dirBuy').style.borderColor = 'var(--border)';
  document.getElementById('dirSell').style.background = 'var(--surface2)';
  document.getElementById('dirSell').style.color = 'var(--text-dim)';
  document.getElementById('dirSell').style.borderColor = 'var(--border)';

  renderBlotterPage();
}

function renderBlotterTable() {
  let trades = [...STATE.trades];
  const search = (document.getElementById('blotterSearch').value || '').toLowerCase();
  if (search) {
    trades = trades.filter(t =>
      (t.hub||'').toLowerCase().includes(search) ||
      (t.type||'').toLowerCase().includes(search) ||
      (t.notes||'').toLowerCase().includes(search) ||
      (t.counterparty||'').toLowerCase().includes(search)
    );
  }

  document.getElementById('blotterCount').textContent = trades.length + ' trades';

  // Pagination
  const totalPages = Math.max(1, Math.ceil(trades.length / BLOTTER_PAGE_SIZE));
  if (blotterPage >= totalPages) blotterPage = totalPages - 1;
  const start = blotterPage * BLOTTER_PAGE_SIZE;
  const pageTrades = trades.slice(start, start + BLOTTER_PAGE_SIZE);

  const tbody = document.getElementById('blotterBody');
  tbody.innerHTML = pageTrades.map(t => {
    const spot = getPrice(t.hub);
    const dir = t.direction === 'BUY' ? 1 : -1;
    const vol = parseFloat(t.volume || 0);
    const entry = parseFloat(t.entryPrice || 0);
    let mtm = 0;
    if (t.status === 'OPEN') mtm = (spot - entry) * vol * dir;
    else mtm = parseFloat(t.realizedPnl || 0);

    const mtmColor = mtm >= 0 ? 'green' : 'red';
    const dirColor = t.direction === 'BUY' ? 'color:var(--green)' : 'color:var(--red)';
    const statusBadge = t.status === 'OPEN' ? '<span class="badge" style="background:rgba(34,211,238,0.15);color:var(--accent)">OPEN</span>' : '<span class="badge" style="background:rgba(148,163,184,0.15);color:var(--text-dim)">CLOSED</span>';

    // Row tint for open trades
    const rowBg = t.status === 'OPEN' ? (mtm >= 0 ? 'background:rgba(16,185,129,0.03)' : 'background:rgba(239,68,68,0.03)') : '';

    // Check 1-hour delete window
    const created = new Date(t.timestamp || t.server_created_at || Date.now());
    const canDelete = (Date.now() - created.getTime()) < 3600000;

    const dateStr = new Date(t.timestamp || Date.now()).toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    const isLarge = (t.hub||'').includes('Baltic') || (t.hub||'').includes('Index');

    let actions = '';
    if (t.status === 'OPEN') actions += `<button class="btn btn-ghost btn-sm" onclick="closeTrade(${t.id})">Close</button>`;
    if (canDelete) actions += `<button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="deleteTrade(${t.id})">Delete</button>`;
    else if (t.status === 'OPEN') actions += `<span style="font-size:10px;color:var(--text-muted)" title="Admin required after 1hr">Locked</span>`;
    actions += `<button class="btn btn-ghost btn-sm" onclick="cloneTrade(${t.id})">Clone</button>`;

    return `<tr style="${rowBg}">
      <td style="font-size:12px;white-space:nowrap">${dateStr}</td>
      <td style="font-size:11px">${t.type}</td>
      <td style="${dirColor};font-weight:700">${t.direction}</td>
      <td>${t.hub}</td>
      <td class="mono">${parseFloat(t.volume).toLocaleString()}</td>
      <td class="mono">${isLarge ? entry.toFixed(0) : entry.toFixed(3)}</td>
      <td class="mono">${isLarge ? spot.toFixed(0) : spot.toFixed(3)}</td>
      <td class="mono ${mtmColor}" style="font-weight:600">${mtm>=0?'+':''}$${Math.abs(mtm).toLocaleString(undefined,{maximumFractionDigits:0})}</td>
      <td>${statusBadge}</td>
      <td><div class="actions-cell">${actions}</div></td>
    </tr>`;
  }).join('');

  if (!pageTrades.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-muted);padding:30px">No trades yet. Use the form above to place your first trade.</td></tr>';
  }

  // Pagination controls
  const pagDiv = document.getElementById('blotterPagination');
  if (totalPages <= 1) { pagDiv.innerHTML = ''; return; }
  let pagHtml = '';
  for (let i = 0; i < totalPages; i++) {
    pagHtml += `<button class="btn btn-sm ${i===blotterPage?'btn-primary':'btn-ghost'}" onclick="blotterPage=${i};renderBlotterTable()">${i+1}</button>`;
  }
  pagDiv.innerHTML = pagHtml;
}

function closeTrade(id) {
  const t = STATE.trades.find(x => x.id === id);
  if (!t || t.status !== 'OPEN') return;
  const cp = getPrice(t.hub);
  if (!cp || cp <= 0) return toast('No market price available for ' + t.hub, 'error');
  const isOtc = t.venue === 'OTC' && (t.counterpartyTrader || t.otcMirrorOf);
  const confirmMsg = isOtc
    ? 'Close OTC trade at market price $' + cp.toFixed(4) + '? (Mirror position will also close)'
    : 'Close at market price $' + cp.toFixed(4) + '?';
  if (!confirm(confirmMsg)) return;

  const dir = t.direction === 'BUY' ? 1 : -1;
  const pnl = (cp - parseFloat(t.entryPrice)) * parseFloat(t.volume) * dir;
  t.status = 'CLOSED';
  t.closePrice = cp;
  t.realizedPnl = pnl;
  t.closedAt = new Date().toISOString();
  localStorage.setItem('ng_trades', JSON.stringify(STATE.trades));

  // Update server
  if (STATE.connected && STATE.trader) {
    if (isOtc) {
      fetch(API_BASE + '/api/trades/otc-close/' + STATE.trader.trader_name + '/' + id, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ closePrice: cp })
      }).catch(() => {});
    } else {
      fetch(API_BASE + '/api/trades/' + STATE.trader.trader_name + '/' + id, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'CLOSED', closePrice: cp, realizedPnl: pnl })
      }).catch(() => {});
    }
  }

  playSound('trade');
  toast('Trade closed: ' + (pnl >= 0 ? '+' : '') + '$' + Math.abs(pnl).toLocaleString(undefined,{maximumFractionDigits:0}) + (isOtc?' (mirror also closed)':''), pnl >= 0 ? 'success' : 'error');
  renderBlotterPage();
}

function deleteTrade(id) {
  const idx = STATE.trades.findIndex(x => x.id === id);
  if (idx === -1) return;
  STATE.trades.splice(idx, 1);
  localStorage.setItem('ng_trades', JSON.stringify(STATE.trades));
  if (STATE.connected && STATE.trader) {
    fetch('/api/trades/' + STATE.trader.trader_name + '/' + id, { method: 'DELETE' }).catch(() => {});
  }
  toast('Trade deleted', 'info');
  renderBlotterPage();
}

function cloneTrade(id) {
  const t = STATE.trades.find(x => x.id === id);
  if (!t) return;
  document.getElementById('tradeType').value = t.type || '';
  onTradeTypeChange();
  setDirection(t.direction);
  setTimeout(() => {
    document.getElementById('tradeHub').value = t.hub || '';
    document.getElementById('tradeVolume').value = t.volume || '';
    document.getElementById('tradeEntry').value = t.entryPrice || '';
    document.getElementById('tradeCpty').value = t.counterparty || '';
    document.getElementById('tradeNotes').value = t.notes || '';
    document.getElementById('tradeSpot').value = getPrice(t.hub).toFixed(4);
    updateMarginPreview();
  }, 50);
  toast('Trade cloned — review and submit', 'info');
  document.getElementById('tradeFormCard').scrollIntoView({ behavior: 'smooth' });
}

function renderNetPositions() {
  const positions = {};
  STATE.trades.filter(t => t.status === 'OPEN').forEach(t => {
    if (!positions[t.hub]) positions[t.hub] = { long: 0, short: 0 };
    if (t.direction === 'BUY') positions[t.hub].long += parseFloat(t.volume);
    else positions[t.hub].short += parseFloat(t.volume);
  });

  const tbody = document.getElementById('netPositionBody');
  const entries = Object.entries(positions);
  if (!entries.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px">No open positions</td></tr>';
    return;
  }

  tbody.innerHTML = entries.map(([hub, pos]) => {
    const net = pos.long - pos.short;
    const dir = net > 0 ? 'NET LONG' : net < 0 ? 'NET SHORT' : 'FLAT';
    const dirColor = net > 0 ? 'color:var(--green)' : net < 0 ? 'color:var(--red)' : 'color:var(--text-muted)';
    return `<tr>
      <td style="font-weight:600">${hub}</td>
      <td class="mono green">${pos.long.toLocaleString()}</td>
      <td class="mono red">${pos.short.toLocaleString()}</td>
      <td class="mono" style="${dirColor};font-weight:700">${Math.abs(net).toLocaleString()}</td>
      <td style="${dirColor};font-weight:600">${dir}</td>
    </tr>`;
  }).join('');
}

function drawPnlChart() {
  const canvas = document.getElementById('pnlChart');
  if (!canvas || !canvas.parentElement) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  const rect = canvas.parentElement.getBoundingClientRect();
  if (!rect || !rect.width) return;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = 280 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '280px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 280;

  const closed = STATE.trades.filter(t => t.status === 'CLOSED').reverse();
  if (closed.length < 1) {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    ctx.fillStyle = isLight ? '#ffffff' : getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = isLight ? '#94a3b8' : '#475569';
    ctx.font = '13px IBM Plex Sans';
    ctx.textAlign = 'center';
    ctx.fillText('Close trades to see cumulative P&L', W/2, H/2);
    return;
  }

  const cumPnlAll = [];
  let running = 0;
  closed.forEach(t => { running += parseFloat(t.realizedPnl || 0); cumPnlAll.push(running); });

  // Range filtering
  const rangeMap = { '1W': 7, '1M': 30, '3M': 90, 'ALL': cumPnlAll.length };
  const sliceN = rangeMap[STATE.pnlRange] || cumPnlAll.length;
  const cumPnl = cumPnlAll.slice(-Math.min(sliceN, cumPnlAll.length));

  const min = Math.min(0, ...cumPnl);
  const max = Math.max(0, ...cumPnl);
  const range = (max - min) || 1;
  const padL = 70, padR = 35, padT = 20, padB = 45;
  const cW = W - padL - padR, cH = H - padT - padB;

  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  ctx.fillStyle = isLight ? '#ffffff' : getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
  ctx.fillRect(0, 0, W, H);

  // Zero line
  const zeroY = padT + (1 - (0 - min) / range) * cH;
  ctx.strokeStyle = 'rgba(148,163,184,0.3)';
  ctx.lineWidth = 0.5;
  ctx.setLineDash([4, 4]);
  ctx.beginPath(); ctx.moveTo(padL, zeroY); ctx.lineTo(W - padR, zeroY); ctx.stroke();
  ctx.setLineDash([]);

  // P&L line
  const lastVal = cumPnl[cumPnl.length - 1];
  const lineColor = lastVal >= 0 ? '#10b981' : '#ef4444';
  ctx.beginPath();
  cumPnl.forEach((val, i) => {
    const x = padL + (cumPnl.length > 1 ? (i / (cumPnl.length - 1)) * cW : cW / 2);
    const y = padT + (1 - (val - min) / range) * cH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.stroke();

  // Gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, H - padB);
  if (lastVal >= 0) { grad.addColorStop(0, 'rgba(16,185,129,0.15)'); grad.addColorStop(1, 'rgba(16,185,129,0)'); }
  else { grad.addColorStop(0, 'rgba(239,68,68,0)'); grad.addColorStop(1, 'rgba(239,68,68,0.15)'); }
  ctx.beginPath();
  cumPnl.forEach((val, i) => {
    const x = padL + (cumPnl.length > 1 ? (i / (cumPnl.length - 1)) * cW : cW / 2);
    const y = padT + (1 - (val - min) / range) * cH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(padL + cW, zeroY);
  ctx.lineTo(padL, zeroY);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Y-axis labels
  const textColor = isLight ? '#475569' : '#94a3b8';
  ctx.fillStyle = textColor;
  ctx.font = '11px IBM Plex Mono';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const val = min + (range * i / 4);
    const y = padT + (1 - i / 4) * cH;
    ctx.fillText('$' + val.toFixed(0), padL - 8, y + 4);
  }

  // X-axis date labels
  ctx.fillStyle = textColor;
  ctx.font = '10px IBM Plex Mono';
  ctx.textAlign = 'center';
  const now = new Date();
  const totalSpanDays = rangeMap[STATE.pnlRange] || cumPnl.length;
  const labelCount = Math.min(6, cumPnl.length);
  for (let i = 0; i < labelCount; i++) {
    const idx = cumPnl.length > 1 ? Math.floor(i * (cumPnl.length - 1) / (labelCount - 1)) : 0;
    const x = padL + (cumPnl.length > 1 ? (idx / (cumPnl.length - 1)) * cW : cW / 2);
    const daysBack = Math.round(totalSpanDays * (1 - idx / Math.max(1, cumPnl.length - 1)));
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const label = labelDate.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    ctx.fillText(label, x, H - padB + 20);
  }

  // Store metadata for crosshair
  canvas._pnlMeta = { padL, padR, padT, padB, cW, cH, min, max, range, data: cumPnl, lineColor, W, H };
}

function initPnlCrosshair() {
  const canvas = document.getElementById('pnlChart');
  if (!canvas || canvas._pnlCrossInit) return;
  canvas._pnlCrossInit = true;

  canvas.addEventListener('mousemove', e => {
    const meta = canvas._pnlMeta;
    if (!meta) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const { padL, padT, cW, cH, min, range, data, lineColor, W, H, padB } = meta;
    if (mx < padL || mx > padL + cW) { drawPnlChart(); return; }

    const idx = Math.round(((mx - padL) / cW) * (data.length - 1));
    const clampIdx = Math.max(0, Math.min(data.length - 1, idx));
    const val = data[clampIdx];
    const snapX = padL + (clampIdx / (data.length - 1)) * cW;
    const snapY = padT + (1 - (val - min) / range) * cH;

    drawPnlChart();
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    ctx.save(); ctx.scale(dpr, dpr);

    ctx.strokeStyle = 'rgba(148,163,184,0.4)'; ctx.lineWidth = 0.5; ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(snapX, padT); ctx.lineTo(snapX, padT + cH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(padL, snapY); ctx.lineTo(padL + cW, snapY); ctx.stroke();
    ctx.setLineDash([]);

    ctx.beginPath(); ctx.arc(snapX, snapY, 5, 0, Math.PI * 2);
    ctx.fillStyle = lineColor; ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();

    const sign = val >= 0 ? '+' : '-';
    const txt = sign + '$' + Math.abs(val).toLocaleString(undefined, { maximumFractionDigits: 0 });
    ctx.font = '12px IBM Plex Mono';
    const tw = ctx.measureText(txt).width + 16;
    const tipX = snapX + 12 + tw > padL + cW ? snapX - tw - 12 : snapX + 12;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(tipX, snapY - 14, tw, 24);
    ctx.strokeStyle = lineColor; ctx.lineWidth = 1;
    ctx.strokeRect(tipX, snapY - 14, tw, 24);
    ctx.fillStyle = lineColor; ctx.textAlign = 'left';
    ctx.fillText(txt, tipX + 8, snapY + 3);

    const now = new Date();
    const daysBack = data.length - 1 - clampIdx;
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const dateStr = labelDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.font = '10px IBM Plex Mono';
    const dtw = ctx.measureText(dateStr).width + 10;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(snapX - dtw / 2, padT + cH + 2, dtw, 18);
    ctx.fillStyle = '#e2e8f0'; ctx.textAlign = 'center';
    ctx.fillText(dateStr, snapX, padT + cH + 14);
    ctx.restore();
  });

  canvas.addEventListener('mouseleave', () => { if (canvas._pnlMeta) drawPnlChart(); });
}

// Keyboard shortcuts for blotter
document.addEventListener('keydown', e => {
  if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
  if (STATE.currentPage === 'blotter') {
    if (e.key.toLowerCase() === 'b') { e.preventDefault(); setDirection('BUY'); }
    if (e.key.toLowerCase() === 's') { e.preventDefault(); setDirection('SELL'); }
    if (e.key === 'Enter') { e.preventDefault(); submitTrade(); }
  }
});

/* =====================================================================
   NEWS
   ===================================================================== */
const SIM_NEWS = {
  ng: [
    { source:'Simulated', headline:'Henry Hub Prices Surge on Colder Weather Forecast', description:'Extended cold pattern expected across Eastern US pushes gas futures higher.', time:'2h ago' },
    { source:'Simulated', headline:'Freeport LNG Export Terminal Reaches Full Capacity', description:'Gulf Coast LNG demand continues to tighten domestic supply.', time:'4h ago' },
    { source:'Simulated', headline:'EIA Reports Larger-Than-Expected Storage Draw', description:'Working gas dropped 120 Bcf, well above the 5-year average draw.', time:'6h ago' },
    { source:'Simulated', headline:'Permian Basin Flaring Regulations Tighten', description:'New rules could reduce associated gas production in the Waha corridor.', time:'8h ago' },
    { source:'Simulated', headline:'Algonquin Basis Explodes on Pipeline Constraints', description:'Northeast basis blows out as Algonquin capacity maxes out during cold snap.', time:'10h ago' },
    { source:'Simulated', headline:'Dawn Hub Storage Nears Operational Minimums', description:'Canadian storage at Dawn approaches critically low levels ahead of spring.', time:'12h ago' }
  ],
  crude: [
    { source:'Simulated', headline:'OPEC+ Agrees to Extend Production Cuts', description:'Cartel maintains supply discipline, supporting Brent above $80.', time:'2h ago' },
    { source:'Simulated', headline:'US Crude Inventories Fall for 5th Straight Week', description:'EIA reports 4.2M barrel draw at Cushing hub.', time:'5h ago' },
    { source:'Simulated', headline:'WCS Discount Widens on Pipeline Bottleneck', description:'Canadian heavy crude struggles to reach Gulf Coast refiners.', time:'7h ago' },
    { source:'Simulated', headline:'Mars Sour Premium Strengthens on Refinery Demand', description:'Gulf Coast sour crude demand rises ahead of maintenance season.', time:'9h ago' },
    { source:'Simulated', headline:'Brent-WTI Spread Narrows to $3 on Export Growth', description:'Rising US exports tighten the transatlantic arbitrage.', time:'11h ago' },
    { source:'Simulated', headline:'Bakken Production Hits Record Despite Takeaway Limits', description:'North Dakota output surpasses 1.3 million barrels per day.', time:'14h ago' }
  ],
  power: [
    { source:'Simulated', headline:'ERCOT Issues Conservation Alert Amid Heat Wave', description:'Texas grid operator warns of tight reserves as temps hit 105°F.', time:'1h ago' },
    { source:'Simulated', headline:'PJM Capacity Auction Clears at Record Prices', description:'Rising demand and retirements push capacity prices to new highs.', time:'4h ago' },
    { source:'Simulated', headline:'CAISO Curtails 5GW of Solar During Midday Peak', description:'California oversupply leads to negative prices during afternoon hours.', time:'6h ago' },
    { source:'Simulated', headline:'NYISO Zone J Spikes to $200/MWh on Transmission Outage', description:'NYC zone prices soar as key transmission line goes offline.', time:'8h ago' },
    { source:'Simulated', headline:'MISO Wind Generation Sets New Record', description:'Wind output across Midwest surpasses 25GW, depressing on-peak prices.', time:'10h ago' },
    { source:'Simulated', headline:'NEPOOL Winter Readiness Report Raises Concerns', description:'New England ISO flags potential fuel security issues for upcoming winter.', time:'13h ago' }
  ],
  freight: [
    { source:'Simulated', headline:'Baltic Dry Index Surges on Iron Ore Demand', description:'Chinese steel production ramp-up drives capesize rates higher.', time:'2h ago' },
    { source:'Simulated', headline:'VLCC Rates Spike on Red Sea Rerouting', description:'Tankers avoiding Suez Canal add ton-miles, tightening supply.', time:'4h ago' },
    { source:'Simulated', headline:'Panamax Rates Firm on South American Grain Season', description:'Brazilian soybean exports boost Pacific and Atlantic rates.', time:'6h ago' },
    { source:'Simulated', headline:'LNG Spot Freight Eases as Newbuilds Enter Fleet', description:'New vessel deliveries add tonnage, pressuring spot charter rates.', time:'8h ago' },
    { source:'Simulated', headline:'Suezmax Market Tightens on West African Crude Exports', description:'Rising WAF crude demand boosts dirty tanker rates.', time:'10h ago' },
    { source:'Simulated', headline:'Dry Bulk Scrapping Accelerates as Emissions Rules Loom', description:'Older vessels exit fleet ahead of CII regulations, supporting rates.', time:'12h ago' }
  ]
};

let liveNews = {};

function renderNews(sector, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const articles = liveNews[sector] || SIM_NEWS[sector] || [];
  container.innerHTML = articles.slice(0, 6).map(a =>
    `<div class="news-card" onclick="openNewsModal('${a.headline.replace(/'/g,"\\'")}','${(a.description||'').replace(/'/g,"\\'")}','${a.url||''}')">
      <div class="news-source">${a.source}</div>
      <div class="news-headline">${a.headline}</div>
      <div class="news-desc">${a.description || ''}</div>
      <div class="news-time">${a.time}</div>
    </div>`
  ).join('');
}

function openNewsModal(headline, desc, url) {
  const modal = document.getElementById('modalContent');
  modal.innerHTML = `<h3>${headline}</h3><p>${desc}</p>
    ${url ? `<p><a href="${url}" target="_blank" style="color:var(--accent)">Read full article →</a></p>` : ''}
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal()">Close</button></div>`;
  document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

/* =====================================================================
   ECONOMIC CALENDAR
   ===================================================================== */
const CALENDAR_EVENTS = {
  ng: [
    { name:'EIA Natural Gas Storage Report', impact:'HIGH', dayOfWeek:4, recurring:true },
    { name:'NOAA 6-10 Day Forecast', impact:'MEDIUM', dayOfWeek:1, recurring:true },
    { name:'FERC Monthly Gas Report', impact:'MEDIUM', daysAway:12 },
    { name:'LNG Export Terminal Maintenance Window', impact:'HIGH', daysAway:18 },
    { name:'NYMEX NG Options Expiry', impact:'HIGH', daysAway:25 },
  ],
  crude: [
    { name:'EIA Weekly Petroleum Status', impact:'HIGH', dayOfWeek:3, recurring:true },
    { name:'API Weekly Crude Stocks', impact:'MEDIUM', dayOfWeek:2, recurring:true },
    { name:'OPEC+ Monthly Meeting', impact:'HIGH', daysAway:14 },
    { name:'Baker Hughes Rig Count', impact:'MEDIUM', dayOfWeek:5, recurring:true },
    { name:'NYMEX CL Options Expiry', impact:'HIGH', daysAway:22 },
  ],
  power: [
    { name:'ERCOT Seasonal Assessment', impact:'HIGH', daysAway:8 },
    { name:'PJM Capacity Auction Results', impact:'HIGH', daysAway:20 },
    { name:'CAISO Renewables Forecast Update', impact:'MEDIUM', dayOfWeek:1, recurring:true },
    { name:'FERC Monthly Energy Review', impact:'MEDIUM', daysAway:15 },
    { name:'EPA Emissions Rule Comment Deadline', impact:'HIGH', daysAway:30 },
  ],
  freight: [
    { name:'Baltic Exchange Weekly Summary', impact:'HIGH', dayOfWeek:5, recurring:true },
    { name:'Shanghai Shipping Exchange Index', impact:'MEDIUM', dayOfWeek:1, recurring:true },
    { name:'IMO CII Rating Review', impact:'HIGH', daysAway:21 },
    { name:'Chinese PMI Release', impact:'HIGH', daysAway:5 },
    { name:'BIMCO Market Report', impact:'MEDIUM', daysAway:12 },
  ]
};

function renderCalendar(containerId, sector) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const events = CALENDAR_EVENTS[sector] || [];
  const now = new Date();

  const items = events.map(ev => {
    let daysAway;
    if (ev.recurring && ev.dayOfWeek !== undefined) {
      const today = now.getDay();
      daysAway = (ev.dayOfWeek - today + 7) % 7;
      if (daysAway === 0) daysAway = 0; // today
    } else {
      daysAway = ev.daysAway || 0;
    }
    const evDate = new Date(now.getTime() + daysAway * 86400000);
    return { ...ev, daysAway, date: evDate };
  }).sort((a, b) => a.daysAway - b.daysAway);

  container.innerHTML = items.map(ev => {
    const dateStr = ev.date.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    const daysLabel = ev.daysAway === 0 ? 'Today' : ev.daysAway === 1 ? 'Tomorrow' : ev.daysAway + 'd away';
    return `<div class="cal-item">
      <span class="cal-date">${dateStr}</span>
      <span class="cal-name">${ev.name}</span>
      <span class="cal-impact ${ev.impact.toLowerCase()}">${ev.impact}</span>
      <span class="cal-days">${daysLabel}</span>
    </div>`;
  }).join('');
}

/* =====================================================================
   HUB INFO PANELS
   ===================================================================== */
const HUB_INFO = {
  'Henry Hub': { location:'Erath, Louisiana', desc:'The benchmark natural gas pricing point in North America. Henry Hub is the delivery point for NYMEX natural gas futures and serves as the primary reference for US gas trading.', contract:'10,000 MMBtu per contract', tick:'$0.001/MMBtu ($10/tick)', hours:'Sun-Fri 6:00pm-5:00pm ET', settlement:'Physical delivery', seasonal:'Prices typically peak in winter (Dec-Feb) during heating season and can spike during summer (Jul-Aug) on cooling demand. Shoulder months (Apr-May, Sep-Oct) tend to be lowest.', risks:'Hurricane exposure in Gulf of Mexico, storage injection/withdrawal patterns, LNG export demand, associated gas production from Permian Basin.', related:['Waha','Transco Zone 6','Dawn'] },
  'Waha': { location:'Permian Basin, West Texas', desc:'The main hub for Permian Basin associated gas. Waha often trades at a significant discount to Henry Hub due to pipeline takeaway constraints from the prolific Permian production region.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Basis typically weakens (wider discount) when Permian oil production increases. Narrower basis during high-demand winters.', risks:'Pipeline capacity buildout, Permian oil production rates, flaring regulations, Gulf Coast LNG demand pulling gas east.', related:['Henry Hub','Kern River','Opal'] },
  'SoCal Gas': { location:'Southern California', desc:'Key delivery hub for Southern California gas demand. Prices are influenced by California environmental regulations, hydroelectric availability, and desert cooling demand.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Physical', seasonal:'Summer peaks driven by power generation for cooling. Winter peaks are moderate. Hydro availability in spring can depress prices.', risks:'Aliso Canyon storage facility constraints, wildfire impacts on infrastructure, state environmental policy, renewable penetration reducing gas burn.', related:['CAISO SP15','Kern River','Malin'] },
  'Chicago': { location:'Chicago, Illinois', desc:'Major Midwest gas hub serving the Chicago metro area. A key intersection of multiple pipeline systems connecting Gulf supply, Appalachian supply, and Midwestern demand.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Strong winter premium due to heating demand. Moderate summer prices. Shoulder seasons see basis compression.', risks:'Polar vortex events, pipeline maintenance on key corridors, Appalachian supply growth, industrial demand fluctuations.', related:['Henry Hub','Dawn','MISO Illinois'] },
  'Algonquin': { location:'Algonquin Citygate, New England', desc:'The primary pricing point for New England gas. Notorious for extreme winter volatility due to pipeline constraints into the region and heavy heating demand.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Extreme winter spikes ($20-60+ during polar events). Summer basis is relatively flat. Most volatile hub in North America.', risks:'Pipeline capacity constraints (no new pipelines approved), LNG import dependence in winter, heating oil switching capability, Mystic Generating Station retirement.', related:['Transco Zone 6','NEPOOL Mass','Tetco M3'] },
  'Transco Zone 6': { location:'New York City area', desc:'Transco Zone 6 NY covers the New York City metropolitan gas market. Part of the Transcontinental Pipeline system, it is a critical hub for Northeast demand.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Winter premium similar to Algonquin but less extreme. Summer basis is moderate. Cold snaps cause rapid basis expansion.', risks:'NYC building electrification mandates, pipeline expansion opposition, winter weather severity, power sector gas demand.', related:['Algonquin','NYISO Zone J','Tetco M3'] },
  'Dominion South': { location:'Appalachian Basin, Southwest PA', desc:'Hub for Marcellus/Utica shale gas production. Often trades at a discount to Henry Hub due to abundant local supply and pipeline takeaway constraints.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Basis widens (deeper discount) when production is high and demand is low. Tighter in winter when local demand absorbs supply.', risks:'Marcellus/Utica production growth, pipeline capacity additions (MVP, regional projects), environmental regulations on drilling.', related:['Tetco M3','Henry Hub','Chicago'] },
  'Dawn': { location:'Dawn, Ontario, Canada', desc:'Major Canadian gas hub and storage center. Dawn serves as the benchmark for Eastern Canadian gas and connects to major US pipeline systems.', contract:'10,000 MMBtu (GJ equivalent)', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Winter premium on heating demand. Storage-driven trading around injection/withdrawal seasons.', risks:'Cross-border pipeline policy, Canadian production trends, storage capacity utilization, regulatory changes.', related:['Chicago','Henry Hub','NYISO Zone A'] },
  'Sumas': { location:'Sumas, Washington (US-Canada border)', desc:'Pacific Northwest border crossing hub for gas flowing between British Columbia and Washington/Oregon markets.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Winter basis widens on Pacific NW heating demand. Hydro-heavy region means gas competes with cheap hydro in spring.', risks:'BC production trends, Enbridge T-South pipeline capacity, Pacific NW LNG project development, hydroelectric conditions.', related:['Malin','CAISO NP15','Dawn'] },
  'Malin': { location:'Malin, Oregon (OR-CA border)', desc:'Key interconnect between Pacific Northwest and California gas markets. Serves as a gateway for Canadian and Rockies gas flowing into California.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Influenced by both California demand and PNW supply. Basis typically tracks between Sumas and SoCal Gas.', risks:'Ruby Pipeline flow dynamics, California regulatory changes, wildfire impacts, competing Rockies supply routes.', related:['SoCal Gas','Sumas','Kern River'] },
  'Opal': { location:'Opal, Wyoming', desc:'Rocky Mountain gas hub fed by Wyoming and Colorado production. A key supply-side hub for westbound gas flows to California and Pacific Northwest.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Relatively stable pricing with moderate seasonal swings. Basis widths fluctuate with Rockies production levels.', risks:'Rockies production decline rates, pipeline flow reversals, competition with Permian gas for western markets.', related:['Kern River','Waha','Malin'] },
  'Tetco M3': { location:'Appalachian Basin, Eastern PA', desc:'Texas Eastern M3 zone covers the pipeline delivery area into the eastern Pennsylvania and New Jersey region. Closely correlated with Transco Zone 6 but reflects local Appalachian dynamics.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Winter spikes correlate with Northeast cold events. Summer basis moderate. Close spread to Transco Z6.', risks:'Similar to Transco Z6 — pipeline constraints, Marcellus oversupply, local demand fluctuations.', related:['Transco Zone 6','Dominion South','Algonquin'] },
  'Kern River': { location:'Kern County, California', desc:'Delivery point on the Kern River Pipeline connecting Rocky Mountain production to California markets via the Mojave Desert corridor.', contract:'10,000 MMBtu', tick:'$0.001/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Tracks California demand patterns. Summer cooling demand supports prices. Spring hydro surplus weakens basis.', risks:'California energy transition, Kern River pipeline utilization rates, competing supply from Permian via El Paso line.', related:['SoCal Gas','Opal','Waha'] },
  'WTI Cushing': { location:'Cushing, Oklahoma', desc:'The benchmark crude oil pricing point for North America and the delivery hub for NYMEX WTI futures. Cushing is a major storage and pipeline crossroads.', contract:'1,000 BBL per contract', tick:'$0.01/BBL ($10/tick)', hours:'Sun-Fri 6:00pm-5:00pm ET', settlement:'Physical delivery', seasonal:'Seasonal builds in Q1, draws in summer driving season. Refinery maintenance (turnaround) in spring/fall.', risks:'OPEC+ production policy, US shale production growth, SPR releases, global demand outlook, Cushing storage levels.', related:['Brent Dated','WTI Midland','Mars Sour'] },
  'Brent Dated': { location:'North Sea, UK', desc:'The global benchmark crude oil price, representing light sweet crude from the North Sea. Used to price approximately 2/3 of globally traded crude.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'ICE 01:00-23:00 London', settlement:'Cash settled (ICE)', seasonal:'Global demand patterns, refinery runs, OPEC policy drive seasonal moves.', risks:'OPEC+ policy, North Sea production decline, geopolitical events (Middle East, Russia), global recession risk.', related:['WTI Cushing','Mars Sour','ANS'] },
  'WTI Midland': { location:'Midland, Texas (Permian Basin)', desc:'Represents crude oil priced at the Permian Basin wellhead. Typically trades at a slight premium or discount to Cushing depending on pipeline takeaway.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'OTC 24/7', settlement:'Financial', seasonal:'Follows WTI Cushing patterns. Basis fluctuates with pipeline capacity.', risks:'Permian production growth, pipeline capacity additions, refinery demand on Gulf Coast.', related:['WTI Cushing','LLS','Bakken'] },
  'Mars Sour': { location:'Gulf of Mexico', desc:'Medium sour crude grade from the Gulf of Mexico. Mars is a key benchmark for sour crude pricing and is heavily influenced by Gulf Coast refinery demand.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'OTC 24/7', settlement:'Financial', seasonal:'Sour crude premium strengthens when heavy/sour-capable refineries are running hard.', risks:'Gulf hurricane disruptions, OPEC sour crude supply, refinery coker capacity, IMO fuel specifications.', related:['WTI Cushing','LLS','WCS'] },
  'LLS': { location:'St. James, Louisiana', desc:'Louisiana Light Sweet is the primary domestic sweet crude benchmark for the Gulf Coast refining complex. Priced at the St. James terminal.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'OTC 24/7', settlement:'Physical', seasonal:'Premium typically strengthens during high refinery utilization periods.', risks:'Gulf Coast refinery demand, waterborne crude import competition, pipeline flows from Midcontinent.', related:['WTI Cushing','Mars Sour','Brent Dated'] },
  'ANS': { location:'Valdez, Alaska', desc:'Alaska North Slope crude, a medium-gravity sour grade shipped by tanker from Valdez to US West Coast refineries.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'OTC 24/7', settlement:'Financial', seasonal:'West Coast refinery demand and Trans-Alaska Pipeline throughput drive pricing.', risks:'TAPS pipeline throughput decline, West Coast refinery closures, competing Pacific Basin crudes.', related:['WTI Cushing','Brent Dated','WCS'] },
  'Bakken': { location:'Williston Basin, North Dakota', desc:'Light sweet crude from the Bakken shale play. Quality premium but transportation discounts due to limited pipeline access and rail dependence.', contract:'1,000 BBL', tick:'$0.01/BBL', hours:'OTC 24/7', settlement:'Financial', seasonal:'Basis widens when rail economics deteriorate or pipeline capacity is constrained.', risks:'DAPL pipeline legal challenges, rail transportation costs, North Dakota production volumes, winter operational challenges.', related:['WTI Cushing','WTI Midland','WCS'] },
  'WCS': { location:'Hardisty, Alberta, Canada', desc:'Western Canadian Select is the benchmark for Canadian heavy sour crude. Trades at a significant discount to WTI due to quality differential and transportation costs.', contract:'1,000 BBL', tick:'$0.01/BBL (CAD)', hours:'OTC 24/7', settlement:'Financial', seasonal:'Discount widens during refinery maintenance seasons and narrows when heavy crude demand is strong.', risks:'Trans Mountain pipeline expansion, Alberta production curtailments, US Midwest refinery demand, diluent availability.', related:['WTI Cushing','Mars Sour','Bakken'] },
  'ERCOT Hub': { location:'Texas (statewide)', desc:'The Electric Reliability Council of Texas Hub represents the load-weighted average across all ERCOT settlement points. Texas operates its own isolated grid.', contract:'50 MWh (on-peak block)', tick:'$0.01/MWh', hours:'OTC / ICE', settlement:'Financial', seasonal:'Extreme summer peaks (Jul-Aug) on cooling demand. Winter spikes possible (Feb 2021 event). Moderate shoulder seasons.', risks:'Extreme weather events, renewable intermittency, grid reliability concerns, generation retirements, political/regulatory intervention.', related:['ERCOT North','ERCOT South','SPP North'] },
  'ERCOT North': { location:'North Texas (Dallas/Fort Worth)', desc:'Settlement zone covering the Dallas-Fort Worth metroplex, the largest load center in ERCOT.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Follows ERCOT Hub patterns with slightly lower volatility than South zone.', risks:'Same as ERCOT Hub with localized transmission constraints.', related:['ERCOT Hub','ERCOT South','SPP North'] },
  'ERCOT South': { location:'South Texas (Houston/San Antonio)', desc:'Settlement zone covering the Houston and San Antonio areas, with significant industrial load and Gulf Coast exposure.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Higher summer peaks than North due to coastal humidity. Industrial base load adds stability.', risks:'Hurricane exposure, coastal flooding, petrochemical facility demand swings.', related:['ERCOT Hub','ERCOT North','Henry Hub'] },
  'PJM West Hub': { location:'Western PJM (PA/OH/WV)', desc:'The primary financial trading hub in the PJM Interconnection, covering the western portion of the world\'s largest power market.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC / ICE', settlement:'Financial', seasonal:'Summer and winter peaks. Gas-on-the-margin pricing during peak hours.', risks:'Gas price exposure (Transco Z6), renewable buildout, capacity market design changes, coal plant retirements.', related:['NYISO Zone J','NEPOOL Mass','Transco Zone 6'] },
  'NEPOOL Mass': { location:'Massachusetts / New England', desc:'The New England Power Pool Massachusetts hub. New England is heavily gas-dependent for power generation with limited pipeline capacity.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Extreme winter spikes when gas prices soar (Algonquin basis). Moderate summer. Highest winter power prices in US.', risks:'Gas pipeline constraints, Mystic station retirement, offshore wind development, fuel security concerns.', related:['Algonquin','PJM West Hub','NYISO Zone J'] },
  'MISO Illinois': { location:'Illinois / Midwest', desc:'MISO Illinois hub covers the central portion of the Midcontinent ISO, a region with diverse generation mix including wind, gas, coal, and nuclear.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Moderate seasonal patterns. Wind generation can depress off-peak prices significantly.', risks:'Wind overbuild risk, coal retirements, Chicago gas price linkage, transmission constraints.', related:['Chicago','PJM West Hub','SPP North'] },
  'CAISO NP15': { location:'Northern California', desc:'California ISO North Path 15 hub, covering Northern California including the Bay Area. Heavy renewable penetration leads to unique pricing dynamics.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Duck curve: negative midday prices from solar, evening ramps. Summer heat events spike prices.', risks:'Solar curtailment, hydro availability, wildfire risk, gas plant retirements, battery storage buildout.', related:['CAISO SP15','SoCal Gas','Malin'] },
  'CAISO SP15': { location:'Southern California', desc:'California ISO South Path 15 hub covering the Los Angeles basin and Southern California. Similar duck curve dynamics to NP15.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Desert heat drives summer peaks. Solar-driven negative midday prices. Evening ramp steeper than NP15.', risks:'Same as NP15 plus desert solar overgeneration, transmission constraints on Path 15.', related:['CAISO NP15','SoCal Gas','ERCOT Hub'] },
  'NYISO Zone J': { location:'New York City', desc:'NYISO Zone J covers New York City, the most congested and expensive power zone in the eastern US. Transmission constraints keep prices elevated.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Summer peaks on AC demand. Winter peaks on heating-related electric load. Always premium to upstate.', risks:'Transmission constraints, Indian Point retirement impacts, gas pipeline availability, building electrification mandates.', related:['Transco Zone 6','PJM West Hub','NEPOOL Mass'] },
  'NYISO Zone A': { location:'Western New York (Buffalo)', desc:'NYISO Zone A covers western New York, benefiting from proximity to Niagara hydro and Canadian imports.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Lower and less volatile than Zone J. Hydro availability provides price stability.', risks:'Hydro conditions, Canadian import availability, limited gas pipeline expansion.', related:['Dawn','PJM West Hub','MISO Illinois'] },
  'SPP North': { location:'Great Plains (KS/OK/NE)', desc:'Southwest Power Pool North hub covering the wind-rich Great Plains. Among the lowest wholesale power prices due to massive wind generation.', contract:'50 MWh', tick:'$0.01/MWh', hours:'OTC', settlement:'Financial', seasonal:'Frequent negative prices during high wind periods. Summer has moderate peaks.', risks:'Wind curtailment, transmission buildout, negative price risk, limited storage.', related:['ERCOT Hub','MISO Illinois','Henry Hub'] },
  'Baltic Dry Index': { location:'Global (composite)', desc:'The BDI is a composite index of dry bulk shipping rates across Capesize, Panamax, and Supramax vessel classes. Widely watched as a barometer of global trade and commodity demand.', contract:'FFA ($/day or index pts)', tick:'1 index point', hours:'Baltic Exchange 09:00-17:00 London', settlement:'Financial (FFA)', seasonal:'Peaks during grain seasons (Q1 South America, Q3 North America) and Chinese restocking cycles. Weakest in Q4.', risks:'Chinese steel/iron ore demand, global grain trade, fleet supply growth, port congestion, geopolitical disruptions.', related:['Baltic Capesize','Baltic Panamax','Baltic Supramax'] },
  'Baltic Capesize': { location:'Global (iron ore/coal routes)', desc:'Capesize vessels (180,000+ DWT) primarily carry iron ore and coal on long-haul routes. Most volatile segment of dry bulk.', contract:'FFA ($/day)', tick:'$1/day', hours:'Baltic Exchange', settlement:'Financial', seasonal:'Heavily tied to Chinese iron ore imports. Q1 restocking and Q3 pre-winter builds drive rates.', risks:'Chinese property sector, Brazilian/Australian iron ore production, fleet ordering cycles, canal transit disruptions.', related:['Baltic Dry Index','Baltic Panamax','TD3C VLCC AG-East'] },
  'Baltic Panamax': { location:'Global (grain/coal routes)', desc:'Panamax vessels (65-80,000 DWT) are the workhorses of grain and minor bulk trades, sized to transit the Panama Canal.', contract:'FFA ($/day)', tick:'$1/day', hours:'Baltic Exchange', settlement:'Financial', seasonal:'South American grain season (Feb-May) and US grain season (Sep-Nov) drive seasonal peaks.', risks:'Global grain harvests, fertilizer trade, coal demand shifts, Panama Canal water levels/restrictions.', related:['Baltic Dry Index','Baltic Supramax','Baltic Capesize'] },
  'Baltic Supramax': { location:'Global (minor bulk routes)', desc:'Supramax/Ultramax vessels (50-65,000 DWT) with self-loading gear. Most versatile segment, trading a wide range of minor bulk commodities.', contract:'FFA ($/day)', tick:'$1/day', hours:'Baltic Exchange', settlement:'Financial', seasonal:'More diversified seasonal pattern than Capesize/Panamax. Regional trade flows dominate.', risks:'Regional commodity flows, port infrastructure, fleet age profile, trade route disruptions.', related:['Baltic Dry Index','Baltic Panamax','LNG Spot East'] },
  'TD3C VLCC AG-East': { location:'Arabian Gulf to East Asia', desc:'The benchmark dirty tanker route for VLCCs (Very Large Crude Carriers, 300,000+ DWT) from the Arabian Gulf to China/East Asia. Priced in Worldscale points.', contract:'FFA (Worldscale pts)', tick:'WS 0.5', hours:'Baltic Exchange', settlement:'Financial', seasonal:'Q4 Asian refinery runs drive rates. Summer OPEC output decisions impact. Red Sea diversions add ton-miles.', risks:'OPEC production/export volumes, geopolitical (Strait of Hormuz, Red Sea), fleet ordering, sanctions on tanker trade.', related:['TD20 Suezmax WAF','TC2 Transatlantic','Brent Dated'] },
  'TC2 Transatlantic': { location:'NW Europe to US Atlantic Coast', desc:'Benchmark clean tanker route for Medium Range (MR) vessels carrying refined products across the Atlantic.', contract:'FFA (Worldscale pts)', tick:'WS 0.5', hours:'Baltic Exchange', settlement:'Financial', seasonal:'Winter heating oil demand boosts transatlantic product flows. Summer gasoline demand supports rates.', risks:'Refinery utilization differentials, product stock levels, vessel supply, refinery closures.', related:['TD3C VLCC AG-East','TD20 Suezmax WAF','Brent Dated'] },
  'TD20 Suezmax WAF': { location:'West Africa to NW Europe', desc:'Suezmax tanker route (130-160,000 DWT) carrying crude from West Africa to European refineries.', contract:'FFA (Worldscale pts)', tick:'WS 0.5', hours:'Baltic Exchange', settlement:'Financial', seasonal:'West African crude export volumes and European refinery demand drive seasonal patterns.', risks:'Nigerian/Angolan production levels, European refinery demand, competing Atlantic Basin grades, Suez Canal disruptions.', related:['TD3C VLCC AG-East','TC2 Transatlantic','Brent Dated'] },
  'LNG Spot East': { location:'East Asia (JKM-linked)', desc:'Spot LNG freight rate for standard-size LNG carriers on East Asian routes, linked to JKM (Japan Korea Marker) pricing dynamics.', contract:'$/MMBtu equivalent', tick:'$0.01/MMBtu', hours:'OTC 24/7', settlement:'Financial', seasonal:'Winter demand spikes on Asian heating/power demand. Summer sees easing as European injection competes for cargoes.', risks:'LNG newbuild deliveries, Panama Canal LNG transit restrictions, Asian gas demand, floating storage economics.', related:['Baltic Dry Index','Henry Hub','TD3C VLCC AG-East'] }
};

function openHubInfo(hubName) {
  const info = HUB_INFO[hubName];
  if (!info) { toast('No info available for ' + hubName, 'error'); return; }
  document.getElementById('hubInfoTitle').textContent = hubName;
  document.getElementById('hubInfoBody').innerHTML = `
    <div class="panel-section"><h3>Location &amp; Description</h3><p><strong>${info.location}</strong></p><p>${info.desc}</p></div>
    <div class="panel-section"><h3>Contract Specifications</h3>
      <p><strong>Size:</strong> ${info.contract}</p><p><strong>Tick:</strong> ${info.tick}</p>
      <p><strong>Hours:</strong> ${info.hours}</p><p><strong>Settlement:</strong> ${info.settlement}</p>
    </div>
    <div class="panel-section"><h3>Seasonal Patterns</h3><p>${info.seasonal}</p></div>
    <div class="panel-section"><h3>Key Constraints &amp; Risks</h3><p>${info.risks}</p></div>
    <div class="panel-section"><h3>Related Hubs</h3><p>${info.related.join(' · ')}</p></div>
  `;
  openPanel('hubInfo');
}

/* =====================================================================
   PANELS
   ===================================================================== */
function openPanel(name) {
  closeAllPanels();
  document.getElementById('panelOverlay').classList.add('active');
  const panel = document.getElementById(name + 'Panel');
  if (panel) panel.classList.add('active');
}

function closeAllPanels() {
  document.getElementById('panelOverlay').classList.remove('active');
  document.querySelectorAll('.slide-panel').forEach(p => p.classList.remove('active'));
}

/* =====================================================================
   THEME
   ===================================================================== */
function setTheme(theme) {
  if (theme === 'dark') document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('ng_theme', theme);
  document.querySelectorAll('.theme-opt').forEach(b => {
    b.classList.toggle('btn-primary', b.dataset.theme === theme);
    b.classList.toggle('btn-ghost', b.dataset.theme !== theme);
  });
  renderCurrentPage();
}
(function(){ setTheme(localStorage.getItem('ng_theme') || 'dark'); })();

/* =====================================================================
   REGISTRATION
   ===================================================================== */
function getTraderPhoto() {
  const tn = STATE.trader ? STATE.trader.trader_name : '';
  if (!tn) return '';
  return localStorage.getItem('ng_photo_' + tn) || '';
}
function setTraderPhoto(data) {
  const tn = STATE.trader ? STATE.trader.trader_name : '';
  if (!tn || !data) return;
  localStorage.setItem('ng_photo_' + tn, data);
}

function checkRegistration() {
  if (STATE.trader) {
    document.getElementById('regOverlay').classList.add('hidden');
    initAfterLogin();
  }
}

async function doLogin() {
  const name = document.getElementById('regName').value.trim();
  const pin = document.getElementById('regPin').value.trim();
  const errEl = document.getElementById('regError');
  errEl.style.display = 'none';

  if (!name) { errEl.textContent = 'Name is required'; errEl.style.display = 'block'; return; }
  if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) { errEl.textContent = 'A valid 4-digit PIN is required'; errEl.style.display = 'block'; return; }

  try {
    const r = await fetch('/api/traders/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, pin })
    });
    const d = await r.json();
    if (d.success) {
      STATE.trader = {
        trader_name: d.trader_name,
        real_name: d.real_name,
        display_name: d.display_name,
        firm: d.firm,
        pin: pin,
        starting_balance: d.starting_balance,
        team: d.team || null
      };
      if (d.photo_url) setTraderPhoto(d.photo_url);
      localStorage.setItem('ng_trader', JSON.stringify(STATE.trader));
      document.getElementById('regOverlay').classList.add('hidden');
      toast('Welcome, ' + d.display_name + '!', 'success');
      initAfterLogin();
    } else {
      errEl.textContent = d.error || 'Login failed';
      errEl.style.display = 'block';
    }
  } catch {
    // Offline mode — allow login without server
    const traderName = name.toLowerCase().replace(/\s+/g, '_');
    STATE.trader = { trader_name: traderName, real_name: name, display_name: name, firm: '', pin: pin };
    localStorage.setItem('ng_trader', JSON.stringify(STATE.trader));
    document.getElementById('regOverlay').classList.add('hidden');
    toast('Welcome, ' + name + '! (Offline mode)', 'info');
    initAfterLogin();
  }
}

function initAfterLogin() {
  // Populate settings
  if (STATE.trader) {
    document.getElementById('setRealName').value = STATE.trader.real_name || STATE.trader.display_name || '';
    document.getElementById('setName').value = STATE.trader.display_name || '';
    document.getElementById('setFirm').value = STATE.trader.firm || '';
  }
  document.getElementById('setBalance').value = STATE.settings.balance || 1000000;
  document.getElementById('setSoundEnabled').checked = STATE.settings.sound || false;
  updatePhotoPreview();
  updateHeaderProfile();
  connectWebSocket();
  fetchLiveNews();
  postLoginInit();
}

function updateHeaderProfile() {
  const chip = document.getElementById('headerProfile');
  if (!STATE.trader) { chip.style.display='none'; return; }
  chip.style.display='flex';
  const name = STATE.trader.display_name || 'Trader';
  const photo = getTraderPhoto() || '';
  const avatarEl = document.getElementById('headerAvatar');
  const nameEl = document.getElementById('headerName');
  if (photo) {
    avatarEl.innerHTML = `<img src="${photo}">`;
  } else {
    const initials = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    avatarEl.innerHTML = initials;
    avatarEl.style.background = 'var(--accent)';
  }
  nameEl.textContent = name;
}

function showMyProfile() {
  const balance = STATE.settings.balance||1000000;
  let realized=0,wins=0,losses=0,grossWins=0,grossLosses=0;
  STATE.trades.forEach(t=>{if(t.status==='CLOSED'){const pnl=parseFloat(t.realizedPnl||0);realized+=pnl;if(pnl>0){wins++;grossWins+=pnl;}else if(pnl<0){losses++;grossLosses+=Math.abs(pnl);}}});
  const equity=balance+realized;
  const ret=((equity-balance)/balance)*100;
  const wr=(wins+losses)>0?((wins/(wins+losses))*100):0;
  const pf=grossLosses>0?(grossWins/grossLosses):(grossWins>0?999:0);
  const name=STATE.trader?STATE.trader.display_name:'You';
  const realName=STATE.trader?STATE.trader.real_name:'';
  const firm=STATE.trader?STATE.trader.firm:'';
  const photo=getTraderPhoto()||'';
  const team=STATE.trader?STATE.trader.team:null;
  showTraderProfile({name,realName,firm,team,ret:parseFloat(ret.toFixed(2)),winRate:parseFloat(wr.toFixed(1)),pf:parseFloat(pf.toFixed(2)),trades:STATE.trades.length,equity,photo,isMe:true});
}

function showTraderProfile(trader) {
  const overlay = document.getElementById('profileOverlay');
  const balance = STATE.settings.balance||1000000;

  // Avatar
  const avatarEl = document.getElementById('profAvatar');
  const initials = trader.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const bgColor = trader.isMe ? 'var(--accent)' : 'var(--text-muted)';
  if (trader.photo) {
    avatarEl.innerHTML = `<img src="${trader.photo}">`;
    avatarEl.style.background = bgColor;
  } else {
    avatarEl.innerHTML = initials;
    avatarEl.style.background = bgColor;
  }

  // Name / firm / rank
  document.getElementById('profName').textContent = trader.name + (trader.isMe ? ' (You)' : '');
  const firmLine = trader.firm || 'Independent';
  const realNameLine = trader.realName && trader.realName !== trader.name ? 'Real name: ' + trader.realName : '';
  document.getElementById('profFirm').innerHTML = firmLine + (realNameLine ? '<br><span style="color:var(--text-dim);font-size:12px">' + realNameLine + '</span>' : '');
  const rankEl = document.getElementById('profRank');
  let rankHtml = '';
  if (trader.rank) {
    const suffix = trader.rank===1?'st':trader.rank===2?'nd':trader.rank===3?'rd':'th';
    rankHtml += `#${trader.rank}${suffix} on leaderboard`;
  }
  if (trader.team && trader.team.name) {
    rankHtml += `${rankHtml?' · ':''}<span style="display:inline-flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${trader.team.color||'var(--accent)'};display:inline-block"></span>${trader.team.name}</span>`;
  }
  rankEl.innerHTML = rankHtml || '';

  // Stats grid
  const retColor = trader.ret>=0 ? '#10b981' : '#ef4444';
  const equity = trader.equity || balance*(1+trader.ret/100);
  document.getElementById('profStats').innerHTML = `
    <div class="profile-stat"><div class="profile-stat-label">Return</div><div class="profile-stat-value" style="color:${retColor}">${trader.ret>=0?'+':''}${trader.ret.toFixed(1)}%</div></div>
    <div class="profile-stat"><div class="profile-stat-label">Equity</div><div class="profile-stat-value">$${equity.toLocaleString(undefined,{maximumFractionDigits:0})}</div></div>
    <div class="profile-stat"><div class="profile-stat-label">Win Rate</div><div class="profile-stat-value">${trader.winRate.toFixed(0)}%</div></div>
    <div class="profile-stat"><div class="profile-stat-label">Profit Factor</div><div class="profile-stat-value">${trader.pf.toFixed(2)}</div></div>
    <div class="profile-stat"><div class="profile-stat-label">Trades</div><div class="profile-stat-value">${trader.trades}</div></div>
    <div class="profile-stat"><div class="profile-stat-label">Status</div><div class="profile-stat-value" style="font-size:14px">${trader.isMe?'Active':'Peer'}</div></div>
  `;

  // Mini equity curve
  drawProfileEquityCurve(equity, retColor);

  overlay.classList.add('active');
}

function drawProfileEquityCurve(finalEquity, color) {
  const canvas = document.getElementById('profEquityCanvas');
  if (!canvas) return;
  const dpr = window.devicePixelRatio||1;
  const W = canvas.offsetWidth || 332;
  const H = 120;
  canvas.width = W*dpr; canvas.height = H*dpr;
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);

  const balance = STATE.settings.balance||1000000;
  const steps = 30;
  const line = [balance];
  for (let i=1;i<=steps;i++) {
    const target = balance+(finalEquity-balance)*(i/steps);
    const noise = (Math.random()-0.5)*balance*0.005;
    line.push(target+noise);
  }
  line[line.length-1] = finalEquity;

  const minV = Math.min(...line)*0.999;
  const maxV = Math.max(...line)*1.001;
  const range = maxV-minV||1;
  const pad = {t:10,b:10,l:10,r:10};
  const pw = W-pad.l-pad.r;
  const ph = H-pad.t-pad.b;

  ctx.clearRect(0,0,W,H);
  ctx.beginPath();
  line.forEach((v,i)=>{
    const x=pad.l+(i/steps)*pw;
    const y=pad.t+ph-(((v-minV)/range)*ph);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();

  // Fill under
  ctx.lineTo(pad.l+pw, pad.t+ph);
  ctx.lineTo(pad.l, pad.t+ph);
  ctx.closePath();
  ctx.fillStyle=color+'20';ctx.fill();
}

function closeProfile() {
  document.getElementById('profileOverlay').classList.remove('active');
}

function openLbProfile(index) {
  const entries = window._lbEntries;
  if (!entries || !entries[index]) return;
  showTraderProfile(entries[index]);
}

function doLogout() {
  localStorage.removeItem('ng_trader');
  
  STATE.trader = null;
  document.getElementById('regOverlay').classList.remove('hidden');
  document.getElementById('regName').value = '';
  document.getElementById('regPin').value = '';
  document.getElementById('headerProfile').style.display = 'none';
  // Clean up chat
  document.getElementById('chatTab').style.display = 'none';
  document.getElementById('chatPanel').classList.remove('open');
  CHAT_STATE.open = false;
  CHAT_STATE.conversations = [];
  CHAT_STATE.activeConvo = null;
  if(CHAT_STATE.pollTimer){clearInterval(CHAT_STATE.pollTimer);CHAT_STATE.pollTimer=null;}
  closeAllPanels();
  toast('Logged out', 'info');
}

/* =====================================================================
   SETTINGS
   ===================================================================== */
function saveSettings() {
  if (STATE.trader) {
    const newDisplayName = document.getElementById('setName').value.trim() || STATE.trader.display_name;
    if (newDisplayName !== STATE.trader.display_name) {
      STATE.trader.display_name = newDisplayName;
      // Sync display name to server
      try {
        fetch('/api/traders/display-name/' + STATE.trader.trader_name, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ display_name: newDisplayName })
        });
      } catch {}
    }
    localStorage.setItem('ng_trader', JSON.stringify(STATE.trader));
  }
  STATE.settings.balance = parseFloat(document.getElementById('setBalance').value) || 1000000;
  STATE.settings.margin = document.getElementById('setMargin').value;
  STATE.settings.sound = document.getElementById('setSoundEnabled').checked;
  localStorage.setItem('ng_settings', JSON.stringify(STATE.settings));
  toast('Settings saved', 'success');
  updateHeaderProfile();
  closeAllPanels();
}

function handlePhotoUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const canvas = document.createElement('canvas');
  canvas.width = 64; canvas.height = 64;
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.onload = () => {
    const s = Math.min(img.width, img.height);
    const sx = (img.width - s) / 2, sy = (img.height - s) / 2;
    ctx.drawImage(img, sx, sy, s, s, 0, 0, 64, 64);
    const b64 = canvas.toDataURL('image/jpeg', 0.8);
    setTraderPhoto(b64);
    updatePhotoPreview();
    updateHeaderProfile();
    // Upload to server
    if (STATE.trader) {
      fetch('/api/traders/photo/' + STATE.trader.trader_name, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ photo: b64 })
      }).catch(() => {});
    }
    toast('Photo updated', 'success');
  };
  img.src = URL.createObjectURL(file);
}

function updatePhotoPreview() {
  const el = document.getElementById('photoPreview');
  const photo = getTraderPhoto();
  if (photo) {
    el.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover">`;
  } else if (STATE.trader) {
    el.textContent = STATE.trader.display_name.charAt(0).toUpperCase();
  }
}

/* =====================================================================
   WEBSOCKET CONNECTION
   ===================================================================== */
function connectWebSocket() {
  updateConnBadge('reconnecting');
  // Try HTTP status first
  fetch('/api/status').then(r => r.json()).then(d => {
    if (d.success) {
      STATE.connected = true;
      updateConnBadge('online', d.active_traders);
    }
  }).catch(() => {
    STATE.connected = false;
    updateConnBadge('offline');
  });

  // Periodic check
  setInterval(() => {
    fetch('/api/status').then(r => r.json()).then(d => {
      STATE.connected = true;
      updateConnBadge('online', d.active_traders);
    }).catch(() => {
      STATE.connected = false;
      updateConnBadge('offline');
    });
  }, 15000);
}

function updateConnBadge(status, traders) {
  const dot = document.getElementById('connDot');
  const text = document.getElementById('connText');
  dot.className = 'conn-dot ' + (status === 'online' ? 'online' : status === 'reconnecting' ? 'reconnecting' : 'offline');
  if (status === 'online') text.textContent = 'CONNECTED' + (traders ? ' · ' + traders + ' traders' : '');
  else if (status === 'reconnecting') text.textContent = 'RECONNECTING...';
  else text.textContent = 'OFFLINE — LOCAL MODE';
}

/* =====================================================================
   LIVE NEWS FETCH
   ===================================================================== */
async function fetchLiveNews() {
  for (const sector of ['ng', 'crude', 'power', 'freight']) {
    try {
      const r = await fetch('/api/news/' + sector);
      const d = await r.json();
      if (d.success && d.articles.length) liveNews[sector] = d.articles;
    } catch {}
  }
}

/* =====================================================================
   SOUND ALERTS
   ===================================================================== */
let audioCtx;
function playSound(type) {
  if (!STATE.settings.sound) return;
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  if (type === 'trade') { osc.frequency.value = 880; gain.gain.value = 0.1; osc.type = 'sine'; }
  else if (type === 'alert') { osc.frequency.value = 440; gain.gain.value = 0.15; osc.type = 'triangle'; }
  else { osc.frequency.value = 660; gain.gain.value = 0.08; osc.type = 'sine'; }
  osc.start(); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3); osc.stop(audioCtx.currentTime + 0.3);
}

/* =====================================================================
   KEYBOARD SHORTCUTS
   ===================================================================== */
document.addEventListener('keydown', e => {
  // Don't capture when in input
  if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;

  const pages = ['ng','crude','power','freight','blotter','risk','leaderboard'];
  if (e.key >= '1' && e.key <= '7') { e.preventDefault(); switchPage(pages[parseInt(e.key)-1]); }
  if (e.key === 'Escape') { closeAllPanels(); closeModal(); }
  if (e.key === '?' || (e.shiftKey && e.key === '/')) { e.preventDefault(); openPanel('help'); }
  if (e.key.toLowerCase() === 'i') {
    const hub = STATE.selectedHubs[STATE.currentPage];
    if (hub && HUB_INFO[hub]) openHubInfo(hub);
  }
});

/* =====================================================================
   SESSION TIMEOUT
   ===================================================================== */
let timeoutTimer;
function resetActivityTimer() {
  STATE.lastActivity = Date.now();
  const banner = document.getElementById('timeoutBanner');
  if (banner.classList.contains('active')) {
    banner.classList.remove('active');
  }
}
function checkTimeout() {
  if (Date.now() - STATE.lastActivity > 30 * 60 * 1000) {
    document.getElementById('timeoutBanner').classList.add('active');
  }
}
function dismissTimeout() {
  document.getElementById('timeoutBanner').classList.remove('active');
  resetActivityTimer();
  // Refresh prices
  for (let i = 0; i < 5; i++) tickPrices();
  toast('Prices refreshed', 'info');
}
document.addEventListener('mousemove', resetActivityTimer);
document.addEventListener('keydown', resetActivityTimer);
document.addEventListener('click', resetActivityTimer);
setInterval(checkTimeout, 60000);

/* =====================================================================
   TOAST
   ===================================================================== */
function toast(msg, type) {
  type = type || 'info';
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3500);
}

/* =====================================================================
   PAGE SWITCHING
   ===================================================================== */
function switchPage(name) {
  STATE.currentPage = name;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  if (page) page.classList.add('active');
  const tab = document.querySelector('.tab-btn[data-page="' + name + '"]');
  if (tab) tab.classList.add('active');
  renderCurrentPage();
}

function renderCurrentPage() {
  try {
    switch (STATE.currentPage) {
      case 'ng': renderNGPage(); break;
      case 'crude': if (typeof renderCrudePage === 'function') renderCrudePage(); break;
      case 'power': if (typeof renderPowerPage === 'function') renderPowerPage(); break;
      case 'freight': if (typeof renderFreightPage === 'function') renderFreightPage(); break;
      case 'blotter': if (typeof renderBlotterPage === 'function') renderBlotterPage(); break;
      case 'risk': if (typeof renderRiskPage === 'function') renderRiskPage(); break;
      case 'leaderboard': if (typeof renderLeaderboardPage === 'function') renderLeaderboardPage(); break;
    }
  } catch(e) { console.error('renderCurrentPage error:', e); }
}

/* =====================================================================
   RENDER FUNCTIONS — RISK ANALYTICS
   ===================================================================== */

function renderRiskPage() {
  const balance = STATE.settings.balance || 1000000;
  let realized=0, unrealized=0, wins=0, losses=0, openCount=0, closedCount=0;
  let grossWins=0, grossLosses=0, best=-Infinity, worst=Infinity;
  const pnlList = [];

  STATE.trades.forEach(t => {
    if (t.status === 'CLOSED') {
      closedCount++;
      const pnl = parseFloat(t.realizedPnl||0);
      realized += pnl;
      pnlList.push(pnl);
      if (pnl > 0) { wins++; grossWins += pnl; }
      else if (pnl < 0) { losses++; grossLosses += Math.abs(pnl); }
      if (pnl > best) best = pnl;
      if (pnl < worst) worst = pnl;
    } else if (t.status === 'OPEN') {
      openCount++;
      const spot = getPrice(t.hub);
      const dir = t.direction === 'BUY' ? 1 : -1;
      unrealized += (spot - parseFloat(t.entryPrice)) * parseFloat(t.volume) * dir;
    }
  });

  const equity = balance + realized + unrealized;
  const portfolio = Math.abs(unrealized) + Math.abs(realized) || equity;
  const dailyVol = 0.02;

  // VaR
  const var95 = portfolio * dailyVol * 1.645;
  const var99 = portfolio * dailyVol * 2.326;
  document.getElementById('riskPortValue').textContent = '$' + equity.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('riskVar95').textContent = '-$' + var95.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('riskVar99').textContent = '-$' + var99.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('riskCvar95').textContent = '-$' + (var95*1.3).toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById('riskCvar99').textContent = '-$' + (var99*1.3).toLocaleString(undefined,{maximumFractionDigits:0});

  // Performance
  const wr = (wins+losses)>0 ? ((wins/(wins+losses))*100).toFixed(1)+'%' : '—';
  const pf = grossLosses>0 ? (grossWins/grossLosses).toFixed(2) : (grossWins>0?'999':'—');
  const avgWin = wins>0 ? grossWins/wins : 0;
  const avgLoss = losses>0 ? grossLosses/losses : 0;
  const sharpe = pnlList.length>1 ? (function(){ const mean=pnlList.reduce((a,b)=>a+b,0)/pnlList.length; const std=Math.sqrt(pnlList.reduce((s,v)=>s+(v-mean)*(v-mean),0)/(pnlList.length-1)); return std>0?((mean/std)*Math.sqrt(252)).toFixed(2):'—'; })() : '—';

  document.getElementById('riskSharpe').textContent = sharpe;
  document.getElementById('riskWinRate').textContent = wr;
  document.getElementById('riskPF').textContent = pf;
  document.getElementById('riskAvgWL').textContent = avgWin>0||avgLoss>0 ? '$'+avgWin.toFixed(0)+' / $'+avgLoss.toFixed(0) : '—';
  document.getElementById('riskBest').textContent = best>-Infinity ? (best>=0?'+':'')+('$'+Math.abs(best).toLocaleString(undefined,{maximumFractionDigits:0})) : '—';
  document.getElementById('riskWorst').textContent = worst<Infinity ? '-$'+Math.abs(worst).toLocaleString(undefined,{maximumFractionDigits:0}) : '—';
  document.getElementById('riskCounts').textContent = STATE.trades.length+' / '+openCount+' / '+closedCount;

  // Scenario analysis
  const scenBody = document.getElementById('scenarioBody');
  scenBody.innerHTML = SCENARIOS.map(sc => {
    let impact = 0;
    STATE.trades.filter(t=>t.status==='OPEN').forEach(t => {
      const vol = parseFloat(t.volume);
      const entry = parseFloat(t.entryPrice);
      const dir = t.direction==='BUY'?1:-1;
      const type = t.type||'';
      let pctMove = 0;
      if (type.startsWith('CRUDE')||type==='EFP'||type==='OPTION_CL') pctMove = sc.crude;
      else if (type.startsWith('FREIGHT')) pctMove = sc.freight;
      else if (POWER_HUBS.find(h=>h.name===t.hub)) pctMove = sc.power;
      else pctMove = sc.ng;
      impact += entry * (pctMove/100) * vol * dir;
    });
    const impColor = impact>=0?'green':'red';
    return `<tr><td style="font-weight:600">${sc.name}</td><td class="mono">${sc.ng>=0?'+':''}${sc.ng}%</td><td class="mono">${sc.power>=0?'+':''}${sc.power}%</td><td class="mono">${sc.crude>=0?'+':''}${sc.crude}%</td><td class="mono">${sc.freight>=0?'+':''}${sc.freight}%</td><td class="mono ${impColor}" style="font-weight:700">${impact>=0?'+':'-'}$${Math.abs(impact).toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>`;
  }).join('');

  // Open positions
  const riskOpen = document.getElementById('riskOpenBody');
  const open = STATE.trades.filter(t=>t.status==='OPEN');
  if (!open.length) { riskOpen.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">No open positions</td></tr>'; }
  else { riskOpen.innerHTML = open.map(t => { const spot=getPrice(t.hub);const dir=t.direction==='BUY'?1:-1;const mtm=(spot-parseFloat(t.entryPrice))*parseFloat(t.volume)*dir;return `<tr><td>${t.hub}</td><td style="color:${t.direction==='BUY'?'var(--green)':'var(--red)'};font-weight:700">${t.direction}</td><td class="mono">${parseFloat(t.volume).toLocaleString()}</td><td class="mono ${mtm>=0?'green':'red'}">${mtm>=0?'+':'-'}$${Math.abs(mtm).toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>`;}).join(''); }

  // Equity curve
  drawEquityCurve();
  try { initEquityCrosshair(); } catch(e) { console.error('Equity crosshair error:', e); }

  // Position Heatmap
  renderRiskHeatmap(open);
}

function renderRiskHeatmap(openTrades) {
  const container = document.getElementById('riskHeatmap');
  if (!container) return;

  if (!openTrades || !openTrades.length) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:180px;color:var(--text-muted);font-size:13px">No open positions to display</div>';
    return;
  }

  // Calculate MTM for each position
  const positions = openTrades.map(t => {
    const spot = getPrice(t.hub);
    const dir = t.direction === 'BUY' ? 1 : -1;
    const entry = parseFloat(t.entryPrice);
    const vol = parseFloat(t.volume);
    const mtm = (spot - entry) * vol * dir;
    const exposure = Math.abs(entry * vol);
    const pctReturn = entry > 0 ? ((spot - entry) / entry) * dir * 100 : 0;
    return { hub: t.hub, direction: t.direction, volume: vol, mtm, exposure, pctReturn, spot, entry };
  });

  // Sort by absolute exposure descending (biggest blocks first)
  positions.sort((a, b) => b.exposure - a.exposure);

  const totalExposure = positions.reduce((s, p) => s + p.exposure, 0) || 1;
  const maxAbsPct = Math.max(...positions.map(p => Math.abs(p.pctReturn)), 1);

  // Build treemap-style heatmap
  // Split into rows: first row gets the biggest positions, second row gets smaller ones
  const bigThreshold = positions.length > 3 ? 2 : positions.length;
  const topRow = positions.slice(0, bigThreshold);
  const botRow = positions.slice(bigThreshold);
  const topTotal = topRow.reduce((s, p) => s + p.exposure, 0) || 1;
  const botTotal = botRow.reduce((s, p) => s + p.exposure, 0) || 1;

  function buildCell(p) {
    const intensity = Math.min(Math.abs(p.pctReturn) / maxAbsPct, 1);
    let bgColor, textColor;
    if (p.mtm >= 0) {
      bgColor = `rgba(16,185,129,${0.12 + intensity * 0.35})`;
      textColor = '#10b981';
    } else {
      bgColor = `rgba(239,68,68,${0.12 + intensity * 0.35})`;
      textColor = '#ef4444';
    }
    const mtmStr = (p.mtm >= 0 ? '+' : '-') + '$' + Math.abs(p.mtm).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const retStr = (p.pctReturn >= 0 ? '+' : '') + p.pctReturn.toFixed(2) + '%';
    return `<div style="flex:${p.exposure};min-width:100px;background:${bgColor};border:1px solid ${textColor}33;border-radius:6px;padding:10px 12px;display:flex;flex-direction:column;justify-content:center;cursor:default;transition:transform 0.15s" onmouseenter="this.style.transform='scale(1.02)'" onmouseleave="this.style.transform='scale(1)'">
      <div style="font-weight:700;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.hub}</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${p.direction} ${p.volume.toLocaleString()} @ ${p.entry.toFixed(2)}</div>
      <div style="font-size:18px;font-weight:800;color:${textColor};margin-top:6px;font-family:var(--font-mono)">${mtmStr}</div>
      <div style="font-size:11px;color:${textColor};font-family:var(--font-mono)">${retStr}</div>
    </div>`;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:4px;height:100%;min-height:200px">';
  // Top row
  html += '<div style="display:flex;gap:4px;flex:1">';
  topRow.forEach(p => { html += buildCell(p); });
  html += '</div>';
  // Bottom row (if any)
  if (botRow.length) {
    html += '<div style="display:flex;gap:4px;flex:1">';
    botRow.forEach(p => { html += buildCell(p); });
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function setEqRange(range, btn) {
  STATE.eqRange = range;
  if (btn) {
    btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  drawEquityCurve();
  try { initEquityCrosshair(); } catch(e) {}
}

function setPnlRange(range, btn) {
  STATE.pnlRange = range;
  if (btn) {
    btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  drawPnlChart();
  try { initPnlCrosshair(); } catch(e) {}
}

function setLbRange(range, btn) {
  STATE.lbRange = range;
  if (btn) {
    btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  const canvas = document.getElementById('lbEquityChart');
  if (canvas && canvas._lbRedraw) {
    canvas._lbRedraw();
  } else {
    // Trigger full leaderboard re-render for range change
    window._lbChartVisible = {}; // Reset cache for new range
    renderLeaderboardPage();
  }
}

function drawEquityCurve() {
  const canvas = document.getElementById('equityChart');
  if (!canvas || !canvas.parentElement) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  const rect = canvas.parentElement.getBoundingClientRect();
  if (!rect || !rect.width) return;
  const dpr = window.devicePixelRatio||1;
  canvas.width = rect.width*dpr; canvas.height = 280*dpr;
  canvas.style.width = rect.width+'px'; canvas.style.height = '280px';
  ctx.scale(dpr,dpr);
  const W=rect.width, H=280;
  const balance = STATE.settings.balance||1000000;
  const isLight = document.documentElement.getAttribute('data-theme')==='light';
  ctx.fillStyle = isLight?'#ffffff':getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
  ctx.fillRect(0,0,W,H);

  const closed = STATE.trades.filter(t=>t.status==='CLOSED').reverse();
  if (closed.length<1){ctx.fillStyle=isLight?'#94a3b8':'#475569';ctx.font='13px IBM Plex Sans';ctx.textAlign='center';ctx.fillText('Close trades to see equity curve',W/2,H/2);return;}

  // Build full equity series
  const fullPts=[balance];let run=balance;
  closed.forEach(t=>{run+=parseFloat(t.realizedPnl||0);fullPts.push(run);});

  // Apply range filter
  const range = STATE.eqRange || 'ALL';
  let equityPts;
  if (range === 'ALL') {
    equityPts = fullPts;
  } else {
    let maxPts;
    if (range === '1W') maxPts = 7;
    else if (range === '1M') maxPts = 30;
    else if (range === '3M') maxPts = 90;
    else if (range === 'YTD') {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      maxPts = Math.ceil((now - startOfYear) / 86400000);
    } else maxPts = fullPts.length;
    equityPts = fullPts.length > maxPts ? fullPts.slice(fullPts.length - maxPts) : fullPts;
  }

  if (equityPts.length < 2) { equityPts = fullPts; }

  const min=Math.min(...equityPts)*0.998,max=Math.max(...equityPts)*1.002,rangeV=max-min||1;
  const padL=75,padR=40,padT=20,padB=45,cW=W-padL-padR,cH=H-padT-padB;

  // Period return stats
  const startVal = equityPts[0];
  const endVal = equityPts[equityPts.length - 1];
  const periodPnl = endVal - startVal;
  const periodPct = ((endVal - startVal) / startVal * 100);
  const periodHigh = Math.max(...equityPts);
  const periodLow = Math.min(...equityPts);
  const drawdown = ((periodHigh - endVal) / periodHigh * 100);

  const lineColor = endVal>=startVal?'#10b981':'#ef4444';

  // Gradient fill
  ctx.beginPath();
  equityPts.forEach((v,i)=>{const x=padL+(i/(equityPts.length-1))*cW;const y=padT+(1-(v-min)/rangeV)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  const grad = ctx.createLinearGradient(0, padT, 0, padT+cH);
  grad.addColorStop(0, lineColor + '20');
  grad.addColorStop(1, lineColor + '03');
  ctx.lineTo(padL+cW, padT+cH);
  ctx.lineTo(padL, padT+cH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  equityPts.forEach((v,i)=>{const x=padL+(i/(equityPts.length-1))*cW;const y=padT+(1-(v-min)/rangeV)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle=lineColor;ctx.lineWidth=2;ctx.stroke();

  // Start balance reference line
  const balY=padT+(1-(startVal-min)/rangeV)*cH;
  ctx.strokeStyle='rgba(148,163,184,0.3)';ctx.setLineDash([4,4]);ctx.lineWidth=0.5;
  ctx.beginPath();ctx.moveTo(padL,balY);ctx.lineTo(W-padR,balY);ctx.stroke();ctx.setLineDash([]);

  // Y labels
  const textColor = isLight?'#475569':'#94a3b8';
  ctx.fillStyle=textColor;ctx.font='11px IBM Plex Mono';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const val=min+(rangeV*i/4);const y=padT+(1-i/4)*cH;ctx.fillText('$'+(val/1000).toFixed(0)+'k',padL-8,y+4);}

  // X-axis date labels
  ctx.fillStyle = textColor;
  ctx.font = '10px IBM Plex Mono';
  ctx.textAlign = 'center';
  const now = new Date();
  const labelCount = Math.min(6, equityPts.length);
  for (let i = 0; i < labelCount; i++) {
    const idx = Math.floor(i * (equityPts.length - 1) / (labelCount - 1));
    const x = padL + (idx / (equityPts.length - 1)) * cW;
    const daysBack = equityPts.length - 1 - idx;
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const label = labelDate.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    ctx.fillText(label, x, H - padB + 20);
  }

  // Period stats overlay (top right)
  const statsX = W - padR - 10;
  ctx.textAlign = 'right';
  ctx.font = '11px IBM Plex Mono';
  ctx.fillStyle = lineColor;
  ctx.fillText((periodPnl>=0?'+':'-')+'$'+Math.abs(periodPnl).toLocaleString(undefined,{maximumFractionDigits:0})+' ('+periodPct.toFixed(2)+'%)', statsX, padT + 14);
  ctx.fillStyle = textColor;
  ctx.font = '10px IBM Plex Mono';
  ctx.fillText('DD: '+drawdown.toFixed(2)+'%  Hi: $'+(periodHigh/1000).toFixed(1)+'k  Lo: $'+(periodLow/1000).toFixed(1)+'k', statsX, padT + 28);

  // Store metadata for crosshair
  canvas._eqMeta = { padL, padR, padT, padB, cW, cH, min, max, range: rangeV, data: equityPts, lineColor, W, H, startVal };
}

function initEquityCrosshair() {
  const canvas = document.getElementById('equityChart');
  if (!canvas || canvas._eqCrosshairInit) return;
  canvas._eqCrosshairInit = true;

  canvas.addEventListener('mousemove', e => {
    const meta = canvas._eqMeta;
    if (!meta) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const { padL, padT, cW, cH, min, max, range, data, lineColor, W, H } = meta;

    if (mx < padL || mx > padL + cW) {
      drawEquityCurve();
      return;
    }

    // Find nearest data index
    const idx = Math.round(((mx - padL) / cW) * (data.length - 1));
    const clampIdx = Math.max(0, Math.min(data.length - 1, idx));
    const val = data[clampIdx];

    // Snap positions
    const snapX = padL + (clampIdx / (data.length - 1)) * cW;
    const snapY = padT + (1 - (val - min) / range) * cH;

    // Redraw base
    drawEquityCurve();
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    ctx.save();
    ctx.scale(dpr, dpr);

    // Crosshair lines
    ctx.strokeStyle = 'rgba(148,163,184,0.4)';
    ctx.lineWidth = 0.5;
    ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(snapX, padT); ctx.lineTo(snapX, padT + cH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(padL, snapY); ctx.lineTo(padL + cW, snapY); ctx.stroke();
    ctx.setLineDash([]);

    // Snap dot
    ctx.beginPath(); ctx.arc(snapX, snapY, 5, 0, Math.PI * 2);
    ctx.fillStyle = lineColor; ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();

    // Tooltip with equity value
    const startVal = meta.startVal || (STATE.settings.balance || 1000000);
    const pnl = val - startVal;
    const pnlStr = (pnl >= 0 ? '+' : '-') + '$' + Math.abs(pnl).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const valStr = '$' + (val / 1000).toFixed(1) + 'k';
    const txt = valStr + ' (' + pnlStr + ')';
    ctx.font = '11px IBM Plex Mono';
    const tw = ctx.measureText(txt).width + 16;
    const tipX = snapX + 12 + tw > padL + cW ? snapX - tw - 12 : snapX + 12;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(tipX, snapY - 14, tw, 24);
    ctx.strokeStyle = lineColor; ctx.lineWidth = 1;
    ctx.strokeRect(tipX, snapY - 14, tw, 24);
    ctx.fillStyle = lineColor;
    ctx.textAlign = 'left';
    ctx.fillText(txt, tipX + 8, snapY + 3);

    // Date label at bottom
    const now = new Date();
    const daysBack = data.length - 1 - clampIdx;
    const labelDate = new Date(now.getTime() - daysBack * 86400000);
    const dateStr = labelDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.font = '10px IBM Plex Mono';
    const dtw = ctx.measureText(dateStr).width + 10;
    const padB = meta.padB;
    ctx.fillStyle = 'rgba(15,21,32,0.92)';
    ctx.fillRect(snapX - dtw / 2, padT + cH + 2, dtw, 18);
    ctx.fillStyle = '#e2e8f0';
    ctx.textAlign = 'center';
    ctx.fillText(dateStr, snapX, padT + cH + 14);

    ctx.restore();
  });

  canvas.addEventListener('mouseleave', () => {
    if (canvas._eqMeta) drawEquityCurve();
  });
}

/* =====================================================================
   RENDER FUNCTIONS — LEADERBOARD
   ===================================================================== */

function setLbTab(tab) {
  lbTab = tab;
  document.getElementById('lbIndividual').style.display = tab==='individual'?'block':'none';
  document.getElementById('lbMyTeam').style.display = tab==='myteam'?'block':'none';
  document.getElementById('lbRankings').style.display = tab==='rankings'?'block':'none';
  document.getElementById('lbTabIndiv').className = 'btn btn-sm '+(tab==='individual'?'btn-primary':'btn-ghost');
  document.getElementById('lbTabTeam').className = 'btn btn-sm '+(tab==='myteam'?'btn-primary':'btn-ghost');
  document.getElementById('lbTabRank').className = 'btn btn-sm '+(tab==='rankings'?'btn-primary':'btn-ghost');
  renderLeaderboardPage();
}

function renderLeaderboardPage() {
  // Always try server first, fall back to offline
  fetch('/api/leaderboard').then(r=>r.json()).then(d=>{
    if(d.success && d.leaderboard && d.leaderboard.length > 0) { renderLeaderboardData(d.leaderboard, true); return; }
    renderLeaderboardData(null, false);
  }).catch(()=>renderLeaderboardData(null, false));
}

function renderLeaderboardData(serverData, isLive) {
  const indicator = document.getElementById('lbLiveIndicator');
  if(indicator){
    if(isLive){indicator.textContent='● LIVE';indicator.style.color='var(--green)';indicator.style.background='rgba(16,185,129,0.1)';}
    else{indicator.textContent='● SIMULATED';indicator.style.color='var(--amber)';indicator.style.background='rgba(245,158,11,0.1)';}
  }
  const balance = STATE.settings.balance||1000000;
  let realized=0,wins=0,losses=0,grossWins=0,grossLosses=0;
  STATE.trades.forEach(t=>{if(t.status==='CLOSED'){const pnl=parseFloat(t.realizedPnl||0);realized+=pnl;if(pnl>0){wins++;grossWins+=pnl;}else if(pnl<0){losses++;grossLosses+=Math.abs(pnl);}}});
  const equity=balance+realized;
  const myRet=((equity-balance)/balance)*100;
  const myWR=(wins+losses)>0?((wins/(wins+losses))*100):0;
  const myPF=grossLosses>0?(grossWins/grossLosses):(grossWins>0?999:0);
  const myName=STATE.trader?STATE.trader.display_name:'You';
  const myRealName=STATE.trader?STATE.trader.real_name:'';
  const myFirm=STATE.trader?STATE.trader.firm:'';
  const myPhoto=getTraderPhoto()||'';
  const myTraderName=STATE.trader?STATE.trader.trader_name:'';
  let entries = [];
  if (serverData && isLive) {
    entries = serverData.map(s => ({name:s.display_name,realName:s.real_name||s.display_name,firm:s.firm,ret:s.return_pct,winRate:s.win_rate,pf:s.profit_factor,trades:s.trade_count,equity:s.equity,photo:s.photo_url||'',isMe:s.trader_name===myTraderName,team:s.team||null,traderName:s.trader_name,lastSeen:s.last_seen||null}));
    const myIdx=entries.findIndex(e=>e.isMe);
    if(myIdx>=0){entries[myIdx].ret=parseFloat(myRet.toFixed(2));entries[myIdx].winRate=parseFloat(myWR.toFixed(1));entries[myIdx].pf=parseFloat(myPF.toFixed(2));entries[myIdx].trades=STATE.trades.length;entries[myIdx].equity=equity;entries[myIdx].photo=myPhoto||entries[myIdx].photo;}
    // Keep STATE.trader in sync with server (team assignments, etc.)
    if(myIdx>=0 && STATE.trader){
      STATE.trader.team = entries[myIdx].team || null;
      STATE.trader.firm = entries[myIdx].firm || STATE.trader.firm;
      localStorage.setItem('ng_trader', JSON.stringify(STATE.trader));
    }
  } else {
    entries = SIM_PEERS.map(p => ({...p, isMe:false, equity:balance*(1+p.ret/100)}));
    entries.push({name:myName,realName:myRealName,firm:myFirm,ret:parseFloat(myRet.toFixed(2)),winRate:parseFloat(myWR.toFixed(1)),pf:parseFloat(myPF.toFixed(2)),trades:STATE.trades.length,isMe:true,equity:equity,photo:myPhoto});
  }
  entries.sort((a,b)=>b.ret-a.ret);
  entries.forEach((e,i)=>e.rank=i+1);
  if (lbTab === 'individual') {
    const body = document.getElementById('lbBody');
    body.innerHTML = entries.map((e,i) => {
      const initials = e.name.split(' ').map(w=>w[0]).join('').toUpperCase();
      const bgColor = e.isMe?'var(--accent)':'var(--text-muted)';
      const avatar = e.photo ? `<div class="lb-avatar"><img src="${e.photo}"></div>` : `<div class="lb-avatar" style="background:${bgColor}">${initials}</div>`;
      const highlight = e.isMe ? 'lb-highlight' : '';
      const retColor = e.ret>=0?'green':'red';
      const teamDot = e.team ? `<span class="lb-team-dot" style="background:${e.team.color||'var(--accent)'}"></span>` : '';
      const isOnline = e.isMe || (e.lastSeen && (Date.now() - new Date(e.lastSeen+'Z').getTime()) < 120000);
      const onlineDot = `<span style="width:7px;height:7px;border-radius:50%;background:${isOnline?'var(--green)':'var(--text-muted)'};display:inline-block;flex-shrink:0;margin-right:2px" title="${isOnline?'Online':'Offline'}"></span>`;
      return `<tr class="${highlight} lb-clickable" onclick="openLbProfile(${i})"><td style="font-weight:700">${e.rank}</td><td><div style="display:flex;align-items:center;gap:8px">${avatar}<div><div style="font-weight:600">${onlineDot}${teamDot}${e.name}</div><div style="font-size:11px;color:var(--text-muted)">${e.firm}</div></div></div></td><td class="mono ${retColor}" style="font-weight:700">${e.ret>=0?'+':''}${e.ret.toFixed(1)}%</td><td class="mono">$${e.equity.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="mono">${e.winRate.toFixed(0)}%</td><td class="mono">${e.pf.toFixed(2)}</td><td class="mono">${e.trades}</td><td>${sparklineSVG(priceHistory[NG_HUBS[e.rank%NG_HUBS.length].name],e.ret>=0?'#10b981':'#ef4444',60,20)}</td></tr>`;
    }).join('');
    window._lbEntries = entries;
    const myEntry = entries.find(e=>e.isMe);
    const totalCount = entries.length;
    const myRank = myEntry ? myEntry.rank : totalCount;
    const metrics = [
      {label:'Return %', value:(myRet>=0?'+':'')+myRet.toFixed(1)+'%', pct:Math.round(((totalCount-myRank+1)/totalCount)*100)},
      {label:'Win Rate', value:myWR.toFixed(1)+'%', pct:Math.round((entries.filter(e=>myWR>=e.winRate).length/totalCount)*100)},
      {label:'Profit Factor', value:myPF.toFixed(2), pct:Math.round((entries.filter(e=>myPF>=e.pf).length/totalCount)*100)},
      {label:'# Trades', value:STATE.trades.length.toString(), pct:Math.round((entries.filter(e=>STATE.trades.length>=e.trades).length/totalCount)*100)},
    ];
    document.getElementById('percentileContainer').innerHTML = metrics.map(m => `<div class="pct-row"><span class="pct-label">${m.label}</span><span class="pct-value">${m.value}</span><div class="pct-bar-wrap"><div class="pct-bar" style="width:${m.pct}%"></div></div><span class="pct-rank">Top ${100-m.pct}%</span></div>`).join('');
    drawLbEquityCurve(entries, myEntry);
    const lbCanvas = document.getElementById('lbEquityChart');
    if (lbCanvas) { lbCanvas._lbRedraw = () => drawLbEquityCurve(entries, myEntry); }
    try { initLbCrosshair(); } catch(e) {}
  }
  if (lbTab === 'myteam') {
    const myEntry = entries.find(e=>e.isMe);
    const myTeam = myEntry ? myEntry.team : null;
    const teamEl = document.getElementById('myTeamContent');
    if (myTeam) {
      const tm = entries.filter(e=>e.team&&e.team.name===myTeam.name).sort((a,b)=>b.ret-a.ret);
      const tp = tm.reduce((s,e)=>s+(e.equity-balance),0);
      teamEl.innerHTML = `<div style="margin-bottom:12px"><span style="display:inline-flex;align-items:center;gap:6px;font-size:16px;font-weight:700"><span style="width:12px;height:12px;border-radius:50%;background:${myTeam.color}"></span>${myTeam.name}</span><span style="margin-left:16px;color:var(--text-dim)">${tm.length} members</span></div><div class="table-wrap"><table><thead><tr><th>Rank</th><th>Trader</th><th>Return %</th><th>Equity</th><th>Trades</th></tr></thead><tbody>${tm.map((e,i)=>{const rc=e.ret>=0?'green':'red';return `<tr${e.isMe?' class="lb-highlight"':''}><td style="font-weight:700">${i+1}</td><td style="font-weight:600">${e.name}</td><td class="mono ${rc}">${e.ret>=0?'+':''}${e.ret.toFixed(1)}%</td><td class="mono">$${e.equity.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="mono">${e.trades}</td></tr>`;}).join('')}</tbody></table></div><div style="margin-top:12px;font-size:14px">Team Combined P&L: <strong style="color:${tp>=0?'var(--green)':'var(--red)'}">${tp>=0?'+':'-'}$${Math.abs(tp).toLocaleString(undefined,{maximumFractionDigits:0})}</strong></div>`;
    } else { teamEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">You are not assigned to a team</p>'; }
    // Draw team equity chart
    if (myTeam) {
      const tm2 = entries.filter(e=>e.team&&e.team.name===myTeam.name);
      setTimeout(()=>drawTeamEquityChart(tm2),50);
    }
  }
  if (lbTab === 'rankings') {
    const teamMap = {};
    entries.forEach(e=>{if(e.team){if(!teamMap[e.team.name])teamMap[e.team.name]={name:e.team.name,color:e.team.color,members:[],totalPnl:0};teamMap[e.team.name].members.push(e);teamMap[e.team.name].totalPnl+=(e.equity-balance);}});
    const tl = Object.values(teamMap).sort((a,b)=>b.totalPnl-a.totalPnl);
    const tb = document.getElementById('lbTeamRankBody');
    if(!tl.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:20px">No teams found</td></tr>';}
    else{tb.innerHTML=tl.map((t,i)=>{const ar=t.members.reduce((s,m)=>s+m.ret,0)/t.members.length;const best=t.members.sort((a,b)=>b.ret-a.ret)[0];const pc=t.totalPnl>=0?'green':'red';return `<tr><td style="font-weight:700">${i+1}</td><td><span style="display:inline-flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:${t.color}"></span>${t.name}</span></td><td>${t.members.length}</td><td class="mono ${pc}">${t.totalPnl>=0?'+':'-'}$${Math.abs(t.totalPnl).toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="mono">${ar>=0?'+':''}${ar.toFixed(1)}%</td><td>${best?best.name:'\u2014'}</td></tr>`;}).join('');}
    // Draw team bar chart
    setTimeout(()=>drawTeamBarChart(tl),50);
  }
}

// Assign consistent colors to entries
const CHART_COLORS = ['#22d3ee','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48','#a855f7','#eab308','#0ea5e9'];
window._lbChartVisible = {};
window._teamChartVisible = {};
window._teamRankChartVisible = {};

function genEquityCurve(balance, finalEquity, steps, seedVal) {
  const line = [balance];
  let seed = seedVal || 42;
  function sr(){seed=(seed*16807+0)%2147483647;return(seed/2147483647)-0.5;}
  for(let i=1;i<=steps;i++){
    const p=i/steps;
    line.push(balance+(finalEquity-balance)*p+sr()*balance*0.004);
  }
  line[line.length-1]=finalEquity;
  return line;
}

function drawMultiLineChart(canvasId, lines, steps) {
  const canvas=document.getElementById(canvasId);
  if(!canvas||!canvas.parentElement)return;
  const ctx=canvas.getContext('2d');if(!ctx)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  if(!rect||!rect.width)return;
  const dpr=window.devicePixelRatio||1;
  const H=280;canvas.width=rect.width*dpr;canvas.height=H*dpr;
  canvas.style.width=rect.width+'px';canvas.style.height=H+'px';
  ctx.scale(dpr,dpr);
  const W=rect.width;
  const isLight=document.documentElement.getAttribute('data-theme')==='light';
  ctx.fillStyle=isLight?'#ffffff':getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
  ctx.fillRect(0,0,W,H);
  const padL=75,padR=20,padT=20,padB=45,cW=W-padL-padR,cH=H-padT-padB;
  const activeLines=lines.filter(l=>l.active);
  if(!activeLines.length)return;
  const allVals=activeLines.flatMap(l=>l.data);
  const min=Math.min(...allVals)*0.999,max=Math.max(...allVals)*1.001,range=max-min||1;
  // Grid
  const gridColor=isLight?'rgba(0,0,0,0.06)':'rgba(255,255,255,0.06)';
  ctx.strokeStyle=gridColor;ctx.lineWidth=0.5;
  for(let i=0;i<=4;i++){const y=padT+(i/4)*cH;ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(padL+cW,y);ctx.stroke();}
  // Lines
  activeLines.forEach(l=>{
    ctx.beginPath();
    l.data.forEach((v,i)=>{const x=padL+(i/steps)*cW;const y=padT+(1-(v-min)/range)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.strokeStyle=l.color;ctx.lineWidth=l.bold?2.5:1.5;
    if(l.dashed)ctx.setLineDash([6,4]);else ctx.setLineDash([]);
    ctx.stroke();ctx.setLineDash([]);
  });
  // Y labels
  const tc=isLight?'#475569':'#94a3b8';
  ctx.fillStyle=tc;ctx.font='11px IBM Plex Mono';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const val=min+(range*i/4);const y=padT+(1-i/4)*cH;ctx.fillText('$'+(val/1000).toFixed(0)+'k',padL-8,y+4);}
  // X dates
  ctx.font='10px IBM Plex Mono';ctx.textAlign='center';
  const now=new Date();
  for(let i=0;i<6;i++){const idx=Math.floor(i*steps/5);const x=padL+(idx/steps)*cW;const d=new Date(now.getTime()-(steps-idx)*86400000);ctx.fillText(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}),x,H-padB+20);}
}

function renderChips(chipId, items, visibleMap, redrawFn) {
  const container=document.getElementById(chipId);
  if(!container)return;
  container.innerHTML=items.map((item,i)=>{
    const active=visibleMap[item.key]!==false;
    return `<span class="toggle-chip ${active?'active':'inactive'}" data-key="${item.key}" onclick="toggleChip('${chipId}','${item.key}')"><span class="chip-dot" style="background:${item.color}"></span>${item.label}</span>`;
  }).join('');
  window['_chipRedraw_'+chipId]=redrawFn;
}

function toggleChip(chipId, key) {
  const map=chipId==='lbChips'?window._lbChartVisible:chipId==='teamChips'?window._teamChartVisible:window._teamRankChartVisible;
  map[key]=map[key]===false?true:false;
  const chip=document.querySelector(`#${chipId} .toggle-chip[data-key="${key}"]`);
  if(chip){chip.classList.toggle('active');chip.classList.toggle('inactive');}
  const fn=window['_chipRedraw_'+chipId];
  if(fn)fn();
}

function drawLbEquityCurve(entries, myEntry) {
  const balance=STATE.settings.balance||1000000;
  const lbRangeMap={'1W':7,'1M':30,'3M':90,'ALL':90};
  const steps=lbRangeMap[STATE.lbRange]||30;
  // Build lines for each entry (limit to top 12 + you)
  let sorted=[...entries].sort((a,b)=>b.ret-a.ret);
  // Ensure "me" is always included
  const topN=sorted.filter(e=>!e.isMe).slice(0,11);
  if(myEntry&&!topN.find(e=>e.isMe))topN.push(myEntry);
  else if(!myEntry){}
  const displayed=myEntry?[...topN.filter(e=>!e.isMe),myEntry].sort((a,b)=>b.ret-a.ret):topN;
  // Init visibility
  displayed.forEach((e,i)=>{
    const key=e.traderName||e.name;
    if(window._lbChartVisible[key]===undefined){
      // Default: show top 5 + you
      window._lbChartVisible[key]=(i<5||e.isMe);
    }
  });
  const lines=displayed.map((e,i)=>{
    const key=e.traderName||e.name;
    const color=e.isMe?'#22d3ee':CHART_COLORS[(i+1)%CHART_COLORS.length];
    return {
      key,label:e.name,color,bold:e.isMe,dashed:false,
      data:genEquityCurve(balance,e.equity,steps,(i+1)*137),
      active:window._lbChartVisible[key]!==false
    };
  });
  drawMultiLineChart('lbEquityChart',lines,steps);
  renderChips('lbChips',lines.map(l=>({key:l.key,label:l.label,color:l.color})),window._lbChartVisible,()=>drawLbEquityCurve(entries,myEntry));
}

function drawTeamEquityChart(teamMembers) {
  const balance=STATE.settings.balance||1000000;
  const steps=30;
  if(!teamMembers||!teamMembers.length)return;
  teamMembers.forEach((e,i)=>{
    const key=e.traderName||e.name;
    if(window._teamChartVisible[key]===undefined)window._teamChartVisible[key]=true;
  });
  const avgEquity=teamMembers.reduce((s,e)=>s+e.equity,0)/teamMembers.length;
  const lines=teamMembers.map((e,i)=>{
    const key=e.traderName||e.name;
    const color=e.isMe?'#22d3ee':CHART_COLORS[(i+1)%CHART_COLORS.length];
    return {key,label:e.name,color,bold:e.isMe,dashed:false,data:genEquityCurve(balance,e.equity,steps,(i+1)*97),active:window._teamChartVisible[key]!==false};
  });
  // Add team average dashed line
  lines.push({key:'_teamavg',label:'Team Avg',color:'#94a3b8',bold:false,dashed:true,data:genEquityCurve(balance,avgEquity,steps,999),active:window._teamChartVisible['_teamavg']!==false});
  if(window._teamChartVisible['_teamavg']===undefined)window._teamChartVisible['_teamavg']=true;
  drawMultiLineChart('teamEquityChart',lines,steps);
  renderChips('teamChips',lines.map(l=>({key:l.key,label:l.label,color:l.color})),window._teamChartVisible,()=>drawTeamEquityChart(teamMembers));
}

function drawTeamBarChart(teams) {
  const canvas=document.getElementById('teamBarChart');
  if(!canvas||!canvas.parentElement||!teams.length)return;
  const ctx=canvas.getContext('2d');if(!ctx)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  if(!rect||!rect.width)return;
  teams.forEach((t,i)=>{
    const key=t.name;
    if(window._teamRankChartVisible[key]===undefined)window._teamRankChartVisible[key]=true;
  });
  const activeTeams=teams.filter(t=>window._teamRankChartVisible[t.name]!==false);
  const dpr=window.devicePixelRatio||1;
  const barH=32,gap=8,padL=120,padR=80,padT=10;
  const H=Math.max(150,activeTeams.length*(barH+gap)+padT+20);
  canvas.width=rect.width*dpr;canvas.height=H*dpr;
  canvas.style.width=rect.width+'px';canvas.style.height=H+'px';
  ctx.scale(dpr,dpr);
  const W=rect.width;
  const isLight=document.documentElement.getAttribute('data-theme')==='light';
  ctx.fillStyle=isLight?'#ffffff':getComputedStyle(document.documentElement).getPropertyValue('--surface').trim();
  ctx.fillRect(0,0,W,H);
  if(!activeTeams.length){ctx.fillStyle='#475569';ctx.font='13px IBM Plex Sans';ctx.textAlign='center';ctx.fillText('No teams visible',W/2,H/2);return;}
  const maxVal=Math.max(...activeTeams.map(t=>Math.abs(t.totalPnl)),1);
  const cW=W-padL-padR;
  const zeroX=padL+cW/2;
  // Zero line
  ctx.strokeStyle=isLight?'rgba(0,0,0,0.15)':'rgba(255,255,255,0.15)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(zeroX,padT);ctx.lineTo(zeroX,H-10);ctx.stroke();
  activeTeams.forEach((t,i)=>{
    const y=padT+i*(barH+gap);
    const barW=(t.totalPnl/maxVal)*(cW/2);
    const x=t.totalPnl>=0?zeroX:zeroX+barW;
    const w=Math.abs(barW);
    ctx.fillStyle=t.color||'var(--accent)';
    ctx.globalAlpha=0.85;
    ctx.fillRect(x,y,w,barH);
    ctx.globalAlpha=1;
    // Label left
    ctx.fillStyle=isLight?'#1e293b':'#e2e8f0';ctx.font='12px IBM Plex Sans';ctx.textAlign='right';
    ctx.fillText(t.name,padL-8,y+barH/2+4);
    // Value right
    const valColor=t.totalPnl>=0?'#10b981':'#ef4444';
    ctx.fillStyle=valColor;ctx.font='12px IBM Plex Mono';ctx.textAlign='left';
    const sign=t.totalPnl>=0?'+':'-';
    ctx.fillText(sign+'$'+Math.abs(t.totalPnl).toLocaleString(undefined,{maximumFractionDigits:0}),x+w+6,y+barH/2+4);
  });
  renderChips('teamRankChips',teams.map(t=>({key:t.name,label:t.name,color:t.color})),window._teamRankChartVisible,()=>drawTeamBarChart(teams));
}

function initLbCrosshair() {
  // Simplified — no crosshair for multi-line (too noisy)
}

function openMobileTicket() {
  const ticket = document.getElementById('mobileTicket');
  ticket.style.display = 'block';
  const sel = document.getElementById('mobType');
  if (!sel.options.length) {
    const types = ['PHYS_FIXED','PHYS_INDEX','BASIS_SWAP','FIXED_FLOAT','SPREAD','CRUDE_PHYS','CRUDE_SWAP','FREIGHT_FFA','FREIGHT_PHYS'];
    sel.innerHTML = types.map(t=>`<option value="${t}">${t}</option>`).join('');
    onMobTypeChange();
  }
}

function closeMobileTicket() { document.getElementById('mobileTicket').style.display='none'; }

function onMobTypeChange() {
  const type = document.getElementById('mobType').value;
  let hubs;
  if (type.startsWith('CRUDE')) hubs=CRUDE_HUBS;
  else if (type.startsWith('FREIGHT')) hubs=FREIGHT_HUBS;
  else hubs=NG_HUBS;
  document.getElementById('mobHub').innerHTML = hubs.map(h=>`<option value="${h.name}">${h.name}</option>`).join('');
  updateMobEntryPrice();
}
function updateMobEntryPrice() {
  const hub = document.getElementById('mobHub').value;
  if (hub) document.getElementById('mobEntry').value = getPrice(hub).toFixed(4);
}
document.getElementById('mobHub').addEventListener('change', updateMobEntryPrice);

function setMobDir(dir) {
  mobDir=dir;
  const b=document.getElementById('mobBuy'),s=document.getElementById('mobSell'),h=document.getElementById('mobPriceHint');
  if(dir==='BUY'){b.style.background='var(--green)';b.style.color='#fff';b.style.borderColor='var(--green)';s.style.background='var(--surface2)';s.style.color='var(--text-dim)';s.style.borderColor='var(--border)';if(h)h.textContent='(≥ spot for BUY)';}
  else{s.style.background='var(--red)';s.style.color='#fff';s.style.borderColor='var(--red)';b.style.background='var(--surface2)';b.style.color='var(--text-dim)';b.style.borderColor='var(--border)';if(h)h.textContent='(≤ spot for SELL)';}
}

function submitMobileTrade() {
  const type=document.getElementById('mobType').value;
  const hub=document.getElementById('mobHub').value;
  const vol=document.getElementById('mobVolume').value;
  if(!mobDir)return toast('Select BUY or SELL','error');
  if(!vol||parseFloat(vol)<=0)return toast('Enter volume','error');
  const spotPrice=getPrice(hub);
  if(!spotPrice||spotPrice<=0)return toast('No market price available','error');
  const entered=parseFloat(document.getElementById('mobEntry').value);
  const currentPrice=(entered&&entered>0)?entered:spotPrice;
  if(mobDir==='BUY'&&currentPrice<spotPrice)return toast('BUY price must be ≥ spot ($'+spotPrice.toFixed(4)+')','error');
  if(mobDir==='SELL'&&currentPrice>spotPrice)return toast('SELL price must be ≤ spot ($'+spotPrice.toFixed(4)+')','error');
  const trade={type,direction:mobDir,hub,volume:parseFloat(vol),entryPrice:currentPrice,spotRef:spotPrice,venue:'OTC',status:'OPEN',timestamp:new Date().toISOString(),id:Date.now()};
  STATE.trades.unshift(trade);
  localStorage.setItem('ng_trades',JSON.stringify(STATE.trades));
  playSound('trade');
  toast(mobDir+' '+vol+' '+hub+' @ '+currentPrice.toFixed(4),'success');
  closeMobileTicket();
  document.getElementById('mobVolume').value='';
  document.getElementById('mobEntry').value='';
  mobDir='';
}

/* =====================================================================
   ARM ENERGY LOGO
   ===================================================================== */
const ARM_LOGO = 'data:image/png;base64,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';

function initLogos() {
  document.querySelectorAll('.logo-img').forEach(img => img.src = ARM_LOGO);
  document.querySelectorAll('.logo-img-sm').forEach(img => img.src = ARM_LOGO);
}

/* =====================================================================
   PIPELINE MAP SYSTEM
   ===================================================================== */

function toggleInfo(id, e) {
  e.stopPropagation();
  const el = document.getElementById(id);
  if (!el) return;
  const isOpen = el.classList.contains('active');
  // Close all popovers first
  document.querySelectorAll('.info-popover.active').forEach(p => p.classList.remove('active'));
  if (!isOpen) {
    // Position relative to button
    const btn = e.currentTarget;
    const rect = btn.getBoundingClientRect();
    el.style.top = (rect.bottom + 6) + 'px';
    el.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - 420)) + 'px';
    el.classList.add('active');
  }
}
// Close popovers on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.info-popover') && !e.target.closest('.info-btn')) {
    document.querySelectorAll('.info-popover.active').forEach(p => p.classList.remove('active'));
  }
});

function toggleMap(sector) {
  MAP_STATE[sector] = !MAP_STATE[sector];
  const container = document.getElementById(sector + 'MapContainer');
  const label = document.getElementById(sector + 'MapLabel');
  if (MAP_STATE[sector]) {
    container.style.display = 'block';
    if (label) label.textContent = 'Hide Pipeline Map';
    renderPipelineMap(sector);
  } else {
    container.style.display = 'none';
    if (label) label.textContent = 'Show Pipeline Map';
  }
}

const STATE_PATHS = {
  'AB':'m322.38 313.63 53.3 11.3-17.7 114.1v.1l-.8-.1-16-2.8-10.1-1.9-3.2-6.8 1.2-1.9.2-5.9-4.5-6.2-4.4-11.1-1.8.5-1.2-5-1.9-.1-1.7-4.2-1.5.9.2-3.3-1.6-5.1-2.9-1.6-2.4-3-.2-4.9Z',
  'AL':'m519.57 632.6-.7-6.74-1.27-8.83.08-6.61.37-14.61-.07-7.83.07-3.02 20.54-1.71.03 1.04.08 1 .3 1.59 1.58 3.73 1.12 4.63.68 2.9.75 2.27.67 3.27.97 2.97 1.2 1.6.22 1.6.91.38.07.99-.82 2.28-.23 1.52-.07.91.74 2.07.16 2.5-.38 1.14.3.38.68.38.14 1.36-2.6-.16-3.15.3-11.84 1.37-4.83.66-.1 1.36.82.83 1.2.92.27 3.73-2.57 1.21-1.29-.15 1.29-.91v-.45l-1.43-2.81-1.05-.31-.67 2.05-.6 1.3-.3-.08h-1.27Z',
  'AR':'m502.19 577.38-1.86.33-2.37-.3.2-.76 1.39-1.2.42-1.72-.84-1.4-36.37 1.18.74 3.23v3.87l.64 5.16.1 17.8 1.07.93 1.37-.65 1.27.54.32 3.09 25.8-.53.53-.98-.13-1.68-.86-1.4.75-.7-.75-1.18.32-1.18.64-2.63 1.17-.98-.32-1.06 1.72-2.53 1.26-.65-.06-.7-.15-.86 1.32-2.64 1.11-.6.03-1.6v-1.17l-.98-1.5 1.56-.99.15-1.22.63-2.05z',
  'AZ':'m293.96 596-1.22 1.01-.15.69.23.45 8.76 5.02 5.63 3.57 6.82 4.03 7.81 4.72 5.7 1.14 11.57 1.27 8-56.05-38.84-5.61-1.43 7.73h-.75l-.8 1.24-1.17-.05-.58-1.29-1.27-.16-.43-.55h-.42l-.42.28-.9.48-.06 3.29-.1.79-.27 5.93-.7 1.01-.25 1.56 1.27 2.32.58 2.74.37.5.48.26-.05 1.07-.75.66-1.6.8-.9.91-.69 1.72-.27 2.31-1.31 1.3-.96.32.07.39-.21.8.2.38 1.7.27-.26 1.29-.7 1.02-1.74.43Z',
  'BC':'m230.68 358.43-1.8-1.7 1.7-1-2.2-2.2.4-2.8 2.2-3.7 3.7 2.5.1 2.2.4-.8 3.2-.3-2.6 3.1-1.9 4-2.1.9 2.3.4.3 2.5-1.5 3.3.1 4.7 1.5 2.6-1.3.5-3.3-12.2-.7-2.3Zm4.1-6.7-.3.6-2.7.6 1.6 1.2 1.1-1.8.3-.1Zm17.8 26.5-1.7 3.1-.4 1.2-.6-6Zm-10.6-18.5 1.1-1.4 2.6 3.7-.4 2.2-2.7-5.1Zm60.5-52 19.9 5.9-17 63 .2 4.9 2.4 3 2.9 1.6 1.6 5.1-.2 3.3 1.5-.9 1.7 4.2 1.9.1 1.2 5 1.8-.5 4.4 11.1 4.5 6.2-.2 5.9-1.2 1.9 3.2 6.8h-.1l-12.9-2.8-6.5-1.5-36.5-9.8-.6-.2-1-1.2-.8.7-.4-.1v-5.3l-1.8.5-2.4-3.4 1.8-1.8-5-1.1.6-3-2.2.2 1.5-2.6-2-3.3-2.1.4-5.7-3 2.3-2.1v-1.7l-3.8.2-2.5-2.9-.8-2.8 1.1-4.4 2.2-5-.5-3.7-1.5 1.5 2.7-5.6-3.4 4.8 1.7-7.7-2.6-3.1.9-3.1 2.1-.1 2.5-2.6-5 2.5-1.5 2.1-2.4-7.1-.7-4.3 2.1-3.7-.9-.3 5.5-4.3.4-3.4 1.7-3 .2-2.1-6.1-8.1-1.2-.4-.5-3.3 1.1-1.5-1.4-16.6-2.3-8.7-1.9-5.2 1-1-1.2-3.6h-5.3l-3.3 3.6-2.3.2-.4.1-2.5.2.6-3.7-3.4-11 .1.1Zm-54.6 62.6.9-3.7.7-2.2 2.6 2.7-1.7 7.3-1.8 1.3 1.9-6.4-3 3.9-.7-4.8Zm-4.8-13.8 1.3-5.8-.4 3.6 1.7.2 3.1 9.1-1.2.1-.5 3.3-1.1-5.8Zm20.6 55.7 4.5 3.7 2.2 4.3-1.1 3.4-2 1.5-6.4-4.9-2.6-3.3 2.8-1.4-3.5.1-4.4-5.5-.8-5.2-1.7.5-2.1-6.8-1.6-1.4-2.2-4.7v-1.7h3.7l1.8 2.8 5.5 4.4 7.7 3.6-1.6 4.4Z',
  'CA':'m293.86 595.8 1.82-.23.7-.95.25-1.39-1.65-.27-.24-.33.21-.95-.07-.26.9-.3 1.4-1.34.27-2.35.64-1.6.91-1.02 1.63-.75.77-.76.03-.98-.47-.27-.46-.51-.54-2.75-1.24-2.27.26-1.66-1.12-.48-32.04-49.02 8.77-31.8-31.12-7.39-.7 2.22-.08 3.5-2.4 5.57-1.41 1.21-.15.53-.83.38-.67 1.98-.38 1.52 1.28 1.98.75 1.98.52 1.66-.15 3.05-.82 1.45-.3 2.73-.45 1.74.83 1.84 1.27 2.12 1.06 2.29.6 1.9-.16 1.52-.14.22v1l2.62 2.96-.23 1.14-.3 1.06-.3.93.08 3.87.98 1.74.9 1.22 1.26.24.46 1.29-.52 1.67-.98.76h-.52l-.38 1.82.23 1.38 1.5 2.05.74 2.52.68 2.2.6 1.45 1.59 2.73.67 1.22.22 1.37.75.46v1.14l-.37.91-.83 3.35-.22.91 1.12 1.29 1.95.23 2.1.83 1.8.99h1.35l1.35 1.45 1.19 2.27.52 1.08 1.81.99 2.24.38.68.98.3 1.52-.66.3.15.46 1.5.38 1.28.07 1.46-.79 1.8 1.98.37 1.07 1.2 1.97.15 1.53v4.4l.22.84 4.65.7 9.15 1.28zm-40.88-20.57.6.73-.08.6-1.5-.04-.26-.57-.3-.69Zm.9 0 .57-.3 1.65.98 1.42.57-.4.31-2.1-.1-.76-.77zm9.6 9.32.83 1.1.37.46.72.27.27-.69-.46-.83-1.24-.95-.48.06zm-.68 4.07.83 1.48.57.91-.68.1-.6-.55s-.33-.69-.33-.87v-1.03Z',
  'CO':'m403.02 566.98 2.27-40.61-52.6-5.95-5.66 41.38Z',
  'CT':'m632.17 500.12-1.71-7-2.2.43-9.83 2.23.46 1.53.67 3.42.09 4.22-.56 1.02.88.9 1.98-1.83 1.65-1.52.9-1 .38.3 1.27-.68 2.4-.52z',
  'DC':'M603.3 533.99a2.79 2.83 0 0 1-5.57 0 2.78 2.83 0 0 1 5.56 0Z',
  'DE':'m609.7 523.38.17-1.02.16-.8-.75.19-.75.22-1.01.83.79 2.37 1.05 2.67.98 4.56.74 2.97 2.33-.08 2.85-.56-1.05-3.47-.45.22-1.66-1.13-.82-2.2-.89-1.68-1.46-1.36-.4-.98Z',
  'FL':'m579.17 622.59 1.06 3.44 1.72 4.59 2.48 4.41 1.73 2.96 2.24 2.6 1.88 1.74.74 1.36-.52.62-.37.6 1.34 3.5 1.36 1.38 1.2 2.5 1.66 2.74 2.1 3.88.6 3.57.2 5.63.31.84-.15 1.59-1.12.6.14.92-.3.91.16 1.15.22.91-1.27 1.52-1.43.7-1.8.06-.67.77-1.13.45-.6-.23-.52-.45-.16-1.38-.37-1.59-1.58-2.43-1.66-1.07-1.8-.16-.37.62-1.42-2.06-.3-1.67-1.2-1.9-.82-.53-.75.99-.83-.16-.97-2.36-1.35-1.82-1.35-2.52-1.2-1.45-1.65-1.74.98-1.14 1.5-2.6-.07-.75-2.1-.45-.75.3.15.3 1.2.46-.68 2.13-.37.23-.82-1.9-.6-2.28-.16-1.3.68-2.2v-4.49l-1.43-1.74-.6-1.45-2.4-.6-.9-.31-.74-1.22-1.58-.76-.52-1.59-1.28-.45-1.13-1.75-1.94-.69-1.36-.69h-1.2l-1.86.4-.08.9.37.46-.23.53-1.42-.07-1.73 1.66-1.66.92h-1.79l-1.49.61-.16-1.3-.75-.9-1.35-.53-.75-.7-3.74-1.81-3.53-.84-2.03.3-2.77.23-2.78 1-1.6.28-.11-3.79-1.2-.91-.83-.84.15-1.44 4.72-.61 11.85-1.37 3.16-.3 2.51.13 1.2 1.82.68.68 3.76.23 5.01-.3 9.98-.61 2.52-.32 2.37.1.2 1.36 1.04.38.1-2.17-.7-1.96.61-.74 2.57.28 2.41.15Zm5.82 62.28 1.12-.3.6-.1.68-1.11 1.1-.76.59.22.78.16.2.49-1.61.58-1.96.68-1.08.57Zm6.26-2.35.57.49 1.27-.98 2.48-1.97 1.72-1.83 1.16-3.12.45-.8.08-1.6-.33.22-.46 1.34-.67 2.17-1.5 2.47-2.03 1.97-1.57.91-1.16.73Z',
  'GA':'m538.56 583.24.02 1.04.07 1 .3 1.59 1.58 3.73 1.12 4.63.67 2.9.76 2.28.67 3.27.98 2.96 1.2 1.6.23 1.59.9.38.07 1-.82 2.28-.23 1.52-.08.91.75 2.05.16 2.5-.38 1.14.3.38.67.38-.07 1.32 1.2 1.82.68.68 3.76.23 9.92-.5 5.27-.3 2.32-.42 2.37.1.2 1.35 1.04.38.1-2.17-.7-1.96.61-.74 2.57.28 2.44.24-.36-2.96 1.05-4.71.69-1.98-.23-1.22 1.55-2.93-.24-.64-.88.32-1.2-.6-.3-1-.6-1.67-1.05-.99-1.2-.3-.75-2.28-1.35-2.98-1.96-.91-.97-.92-.6-1.22-.97-.9-1.05-.62-1.06-1.37-1.42-1.06-2.1-.84-.22-.68-1.13-1.37-.23-.68-1.58-2.34-1.63.04-1.75-1.1-.65-.6-.16-.85.41-.9 1.03-.53-.29-.98-19.45 2.22Z',
  'IA':'m490.75 509.87.13 1.32 1.03.26.45.58.23.87 1.77 1.59.31 1.13-.3 1.6-.75 1.52-.37 1.29-1 .76-.8.27-2.59.86-.64 1.82.34.65.85.79-.13 1.9-.82.72-.36.77.06 1.3-.87.22-.75.52-.14.64.14 1-.73.52-1.14-1.47-.6-1.16-30.48 1.19-.42.08-.96-2.12-.1-3.13-.74-1.93-.32-2.48-1.07-1.72-.43-2.26-1.27-3.55-.53-2.52-.63-1.02-.75-1.29.9-2.29.65-2.67-1.27-.98-.21-1.28.42-1.18h.8l38.32-.6.4 1.97 1.04.73.12.68-.95 1.59.1 1.51 1.16 1.79 1.18.6 1.42.24.3.38Z',
  'ID':'m311.44 430-6.17 29.12.71 2.06 1.59 1.24-.1 1.78-1.8 2.04-1.8 2.73-.62 1.36-.54.55-.84.5-1.4 1.72-.73 1.05-.17 1.45-.2.58.59.8 1.17.02.35.65-1.17 2.54-.63 2.24-3.96 16.12 22.12 4.73c3.24.71 21.66 4.17 21.66 4.17l4.06-25.1-.66-.58-.2-1.39-.58-.7-1.37.35-.22 1.43-1.28.15-1.84-.76-1.77.07-1.28.32-1.36-.62-1.33-.02-1.14 1.1-.5-.51-.32-1.58.16-1.66-.78-1.03-1.82-1.48-1.27-5.93.13-2.52-.72-.3-.32.5-2.27 1.43-.43.02-1.22-1.56.07-1.2 3.23-8.17-.17-1-1.55-.53-.23-.55-1.63-2.08-1.78-4.5-1.46-.6-.9-2.17.73-2.2-1.66-3.51 1.86-9.13-6.1-1.41Z',
  'IL':'m514.11 557.28.02-1.52.26-2.18 1.07-1.38.88-1.9 1.04-1.89-.18-2.47-.8-1.51-.15-1.52.38-2.59-.23-3.26-.6-7.54-.6-7.22-.44-5.5-.24-.36-.37-1.22-.6-1.74-.75-.84-.68-1.22-.1-2.58-21.25 1.22.1 1.11 1.07.33.42.53.22.87 1.8 1.6.32 1.08-.32 1.62-.76 1.4-.34 1.37-1.03.77-.73.26-2.66.95-.32.85-.32.97.32.65.85.75-.1 1.93-.86.75-.32.76v1.28l-.84.22-.74.54-.1.64.1.98-.8.62-.48 1.31.21 1.72 1.08 3.45 3.38 3.54 2.55 1.73-.1 2.04.42.66 2.97.2 1.27.65-.33 1.72-1.05 2.8-.32 1.5 1.06 1.83 2.97 2.47 2.13.33.95 2.36.96 1.5-.42 1.4.73 1.94.86.96.64-.4.43-.98 1.02-.82 1-.29 1.2.56 1.69.65.54-.14.1-1.06-.6-1.14.15-1.11.85-.64 1.4-.38.6-.22-.3-.65-.36-1.11.66-.46.54-1.5Z',
  'IN':'m514.13 557.1.02-1.34.23-2.13 1.04-1.36.84-1.83 1.2-1.98-.26-2.52-.8-1.51-.15-1.52.38-2.59-.23-3.26-.6-7.54-.6-7.22-.44-5.5 1.42.4.68.45.52-.16.98-.9 1.31-.76 2.37-.08 10.19-1.06 2.59-.25.69 7.51 1.97 17.34.28 2.7-.17 1.07.56.85.06.64-1.18.76-1.64.72-1.49.27-.28 2.3-2.12 1.55-1.3 1.88.15 1.12-.26.72h-1.56l-.73-.76-1.16.6-1.25.7.08 1.43-.55.13-.22-.47-1-.71-1.51.63-.72 1.41-.67-.38-.67-.75-2.07.23-2.6.46-1.35.72Z',
  'KS':'m462.32 568.59-5.86.1-21.37-.22-20.67-.96-11.42-.6 1.8-30.38 10.25.32 18.69.38 20.55.47h2.36l1.01 1.02.94-.01.76.48-.03 1.4-.86.82-.14 1.06.85 1.6 1.37 1.5 1.08.76.6 5.29z',
  'KY':'m563.49 554.9-1.07 1.12-1.66 1.89-2.28 2.57-.56.81-.03.98-2.03 1.02-2.62 1.6-3.36.85-24.05 2.3-7.32.84-2.15.24h-1.79l-.1 1.97-3.8.07-3.23.3-3.7-.02.56-.62 1.16-.72.1-1.51.42-.85-.74-1.2.37-.9 1.05-.84.98-.3 1.28.61 1.64.6.52-.14.08-1.07-.6-1.14.15-1.06.9-.69 1.2-.3.75-.3-.37-.84-.3-.9.7-.47c0-.03.56-1.66.56-1.72l1.42-.7 2.47-.46 2.08-.23.65.77.7.4.74-1.46 1.48-.6 1.03.7.19.47.55-.12-.08-1.39 1.46-.83.99-.5.7.77 1.55-.02.26-.74-.15-1.06 1.2-1.88 2.2-1.61.33-2.29 1.36-.21 1.75-.78 1.14-.8-.1-.74-.53-.68.27-1.41 1.94-.05 1.07-.36 1.55.67.95 2.05h2.38l.95 1.04.74-.07 1.21-.6 2.43.27 1.2.1.78-.97 1.22-.67.87-.33.3 1.33.95.5 1.23.98.05 2.66.38.75 1.2.73.36 1.09 1.93 1.6.84 1.71z',
  'LA':'m508.75 632-1.53-1.49.47-2.58-.31-.43-4.3.48-11.6.22-.32-1.13.43-3.98 1.53-2.8 2.33-4.09-.27-1.12.6-.33.2-.91-1.06-.97-.05-.91-.85-2.05-.08-2.98-25.73.43.02 4.5.32 4.42.32 1.82 1.16 1.94.43 2.37 2.01 2.58.1 1.5.33.33-.33 3.97-1.39 2.37.75.97-.32 1.19-.32 3.44-.63 1.5.06 1.7 2.17-.72 5.61.1 4.8 1.68 3 .53 1.73-.68 1.5.53 1.5.45.37-.98-1.5-.54-1.2.24-1.28-.77s.08-.6.39-.68c.3-.08 1.42-.46 1.42-.46l.82.69.83-.47 1.5.31.67 1.14.16 1.07 2.1.16.82.83-.37.77-.6.37.75.76 3.9 1.67 1.65-.6.44-1.15 1.2-.3.84-.7.6.46.37 1.37-1.05.39.3.3 1.58-.62 1.05-1.6.38-.23-.98-.15.38-.76-.08-.69.97-.23.53-.6.3.38s-.08 1.44.3 1.44 1.95.31 1.95.31l1.88.92.44.68h1.35l.52.46 1.05-1.45v-.69h-.58l-1.59-1.29-2.7-.38-1.5-1.07.53-1.3 1.04.16.08-.3-.83-.47v-.22h1.5l.83-1.44-.6-.91-.15-1.3-.68.08-.9.99-.29 1.22-1.42-.32-.45-.83.83-.91.89-1.63-.5-1.13-.53-1.87Z',
  'MA':'m644.02 497.49 1-.33.22-.8.48.05.47 1.08-.58.2-1.8.07Zm-4.35.38 1.07-1.25h.74l.86.7-1.13.49-1 .48-.53-.43Zm-16.14-10.35 8.19-2.2 1.05-.3.89-1.31 1.73-.78 1.33 2.08-1.12 2.43-.15.69.9 1.22.54-.39h.81l1.05 1.22 1.81 2.8 1.65.24 1.05-.46.83-.83-.38-1.3-.97-.75-.68.38-.45-.61.22-.23.98-.08.82.38.9 1.15.45 1.37.15 1.13-1.95.69-1.8.92-1.8 2.12-.9.69v-.46l1.13-.68.22-.84-.38-1.45-1.35.7-.37.68.23 1.05-.97.48-1.28-2.13-1.57-2.06-.96-.85-3.03.89-2.36.48-9.6 2.17-.3-2.25.3-4.97 1.99-.43Z',
  'MB':'m415.68 445.33.4-70.9 3-44.7 36.8 1h2.4l.5 7.1-.4 3.5 2.1 3.2 1.3-.9 5.9.5.2 2.3 2 4.8 2.5 7.6-1.5 4.3 9.6-3.7 2.5.2 4.6 2.4 5.2 1-13.3 17.1-13.7 17.8-8.7 9 .3 35.5-.1 3.9h-13.8l-1-.1Z',
  'MD':'m616.27 534.73-2.8.56-2.38.06-.85-3.26-.89-4.31-1.19-2.91-.6-2.07-3.47.77-6.91 1.32-17.37 3.56.53 2.35.45 2.66.14-.14.98-1.14 1.05-1.23 1.12-.3.68-.69.83-1.2.6.3 1.35-.16 1.2-.99.93-.68.86-.23.76.53 1.35.69.91.83.56.72 1.9.8v1.35l2.56.62.53.26.66-.96 1.33.93-.58 1.16-.36 1.88-.83 1.22v.98l.3.84 2.35.64 2-.03 1.43.46.98.15.45-.99-.68-.99v-.83l-1.12-.98-.98-2.6.6-2.5-.08-.98-.6-.62s.68-.76.68-1.05c0-.31.23-1 .23-1l.9-.6.9-.77.22.46-.67.76-.6 1.75.15.53.83.16.22 2.58-.97.46.15 1.67.22-.08.52-.91.75.84-.75.6-.14 1.6 1.2 1.6 1.8.21.75-.37 1.49 1.96.64.26 3.08-1.32.93-1.9-.2-2.31Zm-7.4 4.25.51 1.17.08.84.54.87s.4-.4.4-.56-.34-1.45-.34-1.45l-.34-1.1Z',
  'ME':'m640.16 433.9-.82.83-1.88 1.37v.46l-.37.38-1.28-.3-.3-.55-.23.24-1.49-.91-.75 1.52-1.36 4.18-.82 2.28.07 2.27.08.7-.3 1 .04 4.18.4.5-.38 1.1v.98l-1.5 2.1-.59 3.6-1.28-.18 2.1 6.6 3.37 11.03.15 1.29 1.8.54.22 1.44 1.14.54.52-2.94.08-2.05.66-.6-.45-1.53 1.43-1.67.75.69.6-.23 2.48-1.45.15-1.37 1.35-.23.75-1.2-.08-.77-.14-1.44.37-.61-.14-.53-.6-.69.98-.6.82 1.51.68-.15.15.61v.76l.9.07.22-1.29.22-.3-.74-.68.45-.69 1.12-.68.46-.7.82-.07s.15 1 .45 1h.6l2.25-2.6 1.58-1.44.9-.3.97-2.2v-.93l-1.04-1.75-.92-.97-1.28.08.23.53-.08.23h-.38l-1.34-1.07-.07-2.29-.38-.9h-2.78l-4.2-14.08-.89-.45-2.77-1.15Zm9.61 29.16-.93.34-.64 1.06v.01l.82.87s.6.04.6-.1c0-.17.1-.96.1-.96l.43-.39Zm-3.98 3.46-.7.72h-.02l.84 1.33.78-.42-.26-1.14Z',
  'MI':'m501.92 451.14-1.05.26-2.5 1.83-1 .38-.85.97.75.53.96-.43 1.53-.9 2.38-2.43-.2-.22Zm5.19 6.7-2.2.21-2.01 1.15-1.05 1.05-.6.85-.82.37-.9 1.37-.08.61-2.03.98-1.13.92-2.77.46-.3.3v.46l-1.66 1.07-1.26.38-.34.27 1.74 2.42 3.65.53 3.82 1.02 1.32.49 5.61 1.3.96 1.06 1.65.66.9 4.83.64.48.54.5 1.47-3.3.46-1.9.9-2.05.37-.07.52.76h.3l2.1-1.15.68.76.2.09.6-.55.54-1.44 1.13-.38 3.22-.32.9-1.2 2.4-.09 2.7.62h.82l1.5-.7 1.06.09.97-.3 1.73.21.37.17.6-.16-.6-.45-.6-.3-1.5-1.45v-3.27l-.68-.23-.52.54-2.85.76-.9.22-1.34-.37-.23-.16v-2.66l-.68-.07-1.2.6-2.1.92-3.07.14-1.57.54-1.87 1.68-.76.45h-.52l-.6.38-.75-.21-.75-.62-.68.45-1.81.08-1.27-1.3-.67-1.45-.67-.52-1.5-.45h-1.05l-.6-.61-1.66 1.37-.44.53-.38-.23.14-1.2 1.13-1.53.23-1.15 1.05-.38.67-1.45 1.73-.45.16-.45-.54-.53Zm30.85 10.9-1.02.1-.75.1-.15.53.45.22.3 1.2 1.5.06.6-.56s-.04-.7-.19-.77a6.77 6.88 0 0 1-.75-.87Zm-7.54 4.38-1.36.82-1.34 1.07.16 1.67.44.15.97.24.22.38-1.19.38-1.2.15-.68.83-.15.98.15.77.16 2.59-1.66.99-.3-.09v-1.98l.6-1.14.3-1.14-.37-.38-.9.38-.44 1.98-1.29.52-.82.93-.07.45.3.39-.3 1.22-1.05.22v.53l.38 1.15-.53 2.9-.74 1.9.3 2.2.22.52-.38 1.15-.14.38-.16 1.3 1.65 2.82 1.36 3.04.67 2.29-.37 2.2-.46 2.8-1.1 2.44-.17 1.3-1.5 1.44 2.02-.07 9.94-1.06 3.39-.47.05.78 3.18-.56 4.76-.72 1.8-.2.06-.3.08-.67.97-1.75.93-.82-.1-2.4.74-.73.5-.16.11-1.68.7-1.43.5.28.07.32.37.07.91-.45-.15-4.5-1.5-3.87-1.05-4.27-1.12-1.5-1.21-.86-.75.55-1.8.84-.9 2.35-1.27 1.75-.52.3-.7-.3s-1.19-.7-1.11-1 .22-2.35.22-2.35l1.58-.61.36-1.59.32-1.23 1.1-.75-.13-4.72-.76-1.06-.6-.39-.38-.99.38-.38.75.17.08-.77-1.12-1.07-.6-1.21h-1.21l-2.08-.69-2.55-1.59h-1.3l-.29.3-.45-.2Z',
  'MN':'m457.38 442.43-.1 3.9h-13.8l-.1-.01.4 1.22-.32 1.83v4.84l.74 2.37.85 1.62.21 4.62.86 6.34.85 3.44.2 3.98h.02l-.1 1.5-.64.66-.96.75v.76l.54.86 1.9 1.61.22 1.4.15 16.8 37.67-.56-.31-3.02-1-1.36-3.28-1.93-1.8-2.67-1.56-.24-.88-1.47h-1.55l-1.4-1.41-.17-3.17-.08-1.76.86-1.52-.32-1.52-1.33-1.06 1.03-2.81 2.36-1.76.64-.8-.05-3.78.1-1.5 1.15-1.5 2.02-1.31.59-.08 2.1-2.36.82-.37 1.05-1.83 1.12-1.67 1.43-1.22 2.2-.94 4.3-1.9 1.16-.56-3.69-.81-4.2.4-1-1.2-3.3 2.1-4.3-2.8-2.3 1.1-1.9-3-4.2-.9-3.3 1.3-6.5-2.9-.36-1.96-.45-1.93-.15-1.03Z',
  'MO':'m485.77 532.7-1.18-1.45-.52-1.07-29.85 1.12-1.06.06.58 1.18-.1 1.08 1.16 1.83 1.43 1.93 1.44 1.3 1 .1.7.44v1.39l-.85.76-.22 1.07.96 1.6 1.17 1.4 1.16.87.65 5.49.14 16.97.1 2.2.22 2.53 10.4-.4 10.76-.33 9.65-.37 5.4-.1 1.01 1.6-.32 1.56-1.43 1.13-.27.87 2.5.22 1.8-.33.8-2.59.3-2.76.98-1.2 1.2-.7.03-1.44.47-.9-.79-1.2-.62.47-.93-1.05-.58-2.24.36-1.18-.9-1.62-.85-2.14-2.23-.39-3.23-2.63-.8-1.93.37-1.5.97-2.86.2-1.35-.9-.48-3.18-.39-.48-.8-.05-1.99-2.54-1.61-3.24-3.64-1.07-3.46-.1-1.98.37-1.08Z',
  'MS':'m519.69 632.1-.13.59h-2.4l-.67-.38-.98-.16-3.15.92-.82-.38-1.2 1.97-.51.37-.52-1.18-.54-1.83-1.6-1.5.54-2.6-.32-.44-.86.1-3.66.42-11.39.17-.35-1.04.4-3.94 1.45-2.67 2.42-4.3-.2-1.15.57-.3.2-.9-1.07-.99-.05-1-.86-1.94-.05-2.8.62-1.17-.1-1.62-.83-1.45.7-.7-.72-1.17.21-.78.73-3.08 1.16-.96-.3-1.11 1.71-2.5 1.3-.64-.1-.78-.13-.79 1.34-2.62 1.08-.58.07-.42 17.32-1.82.09 2.96.07 7.82-.37 14.61-.07 6.62 1.28 8.82.67 6.3Z',
  'MT':'m317.7 431.44-1.88 9.12 1.59 3.55-.64 2.15.86 2.15 1.48.66 2.14 5.05 1.25 1.5.21.55 1.6.53.21.96-3.29 8.29v1.18l1.17 1.51h.42l2.23-1.4.32-.55.73.33-.1 2.48 1.27 5.93 1.38 1.17.43.33.85 1.07-.22 1.61.32 1.62.54.44 1.05-1.09h1.27l1.5.76 1.16-.44h1.9l1.7.77 1.28-.21.21-1.41 1.37-.33.65.65.2 1.5.67.4.87-5.2 49.5 6.32 3.98-39.44-.2-.02-39.7-4.8-.8-.1-16-2.8-10.1-1.9h-.1l-12.9-2.8Z',
  'NB':'M671.78 439.63h-2l-.5 3.2-6.4 6.7-6.1 3.6-2.4-.4-2.3-.4-.8-3.2h-1.9l-1.1-.7-3.9-12.3-3.5-2.1-4.3 2.9-1.3-.6 3.7-4-1.1-3.6 4.8-2.3 1.7.7 3.3-2.3 2.7-1.8.3.1 3.9.3 2 1.8 2.2-2.3 3.7-1-1 6.7-1.2 1.6 3.5-1.2.2 2.1 4.8 5.3 5.3-.7-1.3 1.9-.7.5Z',
  'NC':'m614.04 554.44.96 2.32 1.65 3.05 1.13 1.13.3 1.06-1.12.08.37.3-.15 1.98-1.2.61-.3 1-.6 1.36-1.72.77-1.13-.16-.67-.08-.75-.6.15.6v.46h.9l.37.6-.9 2.97h1.95l.3.76 1.05-1.06.59-.22-.9 1.67-1.42 2.28h-.6l-.52-.21-1.28.3-2.4 1.13-3 2.52-1.57 2.2-.9 3.04-.22 1.15-2.18.22-2.53.63-4.61-3.86-5.85-3.57-1.35-.38-5.85.69-1.98.35-.76-1.52-1.37-1-7.64.23-3.37.38-4.21 2.13-2.85 1.22-9.82 1.21.23-1.9.83-.68 1.28-.3.3-1.76 1.95-1.3 1.8-.68 1.94-1.68 2.04-.99.3-1.44 1.8-1.83.3-.07s0 .53.37.53.89.16.89.16l1.06-1.68.97-.3 1.04.15.76-1.67 1.35-1.22.22-.99.09-1.72h1.98l3.34-.41 7.3-1.06 7.02-.98 10.04-2.22 9.27-2.01 5.18-1.14Zm1.97 15.62 1.2-1.17 1.48-1.22.7-.3.08-.95-.3-2.9-.68-1.1-.3-.88.34-.1 1.27 2.57.19 2.1-.08 1.58-1.57.73-1.32 1.15-.52.57z',
  'ND':'m397.93 443.95-3.14 30.45 25.48 1.58 26.94.65-.29-3.97-.78-3.2-.87-6.14-.22-5.16-.8-1.45-.82-2.46.02-4.9.29-1.8-.41-1.24-.85-.08-26.8-.9-7.1-.5Z',
  'NE':'m452.22 529.22 1.5 3.3-.07 1.1 1.6 2.57 1.26 1.48h-2.34l-20.16-.43-18.93-.43-10.31-.37.52-10.07-14.94-1.74 1.94-20.3 7.22.48 9.33.54 8.27.53 11.03.55 4.98-.22.96 1.07 2.22 1.4.54.43 2-.65 1.81-.22 1.28-.1.84.65 1.88.75 1.38.75.21.75.43.97h.85l.37.02.41 2.2 1.36 3.98.26 1.77 1.18 1.78.26 2.4.74 2 .1 3.05Z',
  'NH':'m627.28 459.63-.54.2-.12.28-.2-.16-.74.28-.48 2.88.13 2.26.9 1.3v1.9l-1.72 2.38-1.2.53v.53l.51.84v4.04l-.37 4.33-.08 2.28.45.6-.07 2.13-.23.84.46.33 7.78-2.08 1.02-.28.86-1.3 1.65-.76.4-.5.5-1.55-1.17-.44-.23-1.44-1.8-.53-.15-1.3-3.36-11.03-2.05-6.54Z',
  'NJ':'m611.58 504.64-1.07 1.29v1.44l-.9 1.45-.09.77.6.6-.07 1.13-1.05.55.38 1.28.07.54 1.28.15.45 1.22 1.65 1.14 1.13.76v.38l-1.4 1.27-.74 1.06-.68 1.3-1.05.61-.2.76-.12.57-.29 1.22.51 1.06 1.51 1.37 2.24 1.06 1.87.3.08.69-.37.46.15 1.3h.37l.98-1.15.37-2.28 1.29-1.9 1.41-3.05.53-2.58-.3-.53-.08-4.42-.75-1.6-.52.39-1.27.15-.23-.23.52-.45.98-.92.03-.51-.18-1.62.27-1.3-.05-.92-1.31-.83-2.36-.55-1.93-.65Z',
  'NL':'M618.98 297.33v.5l-.2.2v-.5zm24.7 53.3-.9-3.3.5-2.3-2.4.6-.9-3.2-1.4-1.3 1.8-1.8-3.3.6-2.1-3.4 1.5-.7-2.3-1.8.7-2.5-1.9-8.1-2.3-.4-3.4-3.5 2-4.1-1.9-1.6 2.5-1.4-1.6-1.2-1.7 2.1-2.3-1.8-1.8-2.9-.2-2.7-2.6.5-.6-6.2h-.1l-1.7-1 1-.7.6.4 3 1.9 1.2 3 1.7.2 4.4 4.3 4.5 3.3-1.5 2.8 3.5-1.7.8 3.5 1.2-.4 3.4 2.5 1.3 2.1 2.2.3-1.1 3.3h4l.7 3.5 1.2 1.4-3.4-.7.4 2h4.7l-4.4 1.1-.3 1 3.8-.9-2.2 2.7 4.8-1.4 1.4 3.1 4.4-.8-.4 1.4 2.5 1.6-.9 5.1 1.8-3.9 1.8-1.3.8 2.2 4.1-2.3 1.9 2.7 6.4-1.5 4.2.8-1.7 2.2-2.8 1.5-1 3.9-4 4.3-3.2 2.1.7 5.2 1.6-3.1 3.9-4.2v-2.6l3.5-3.3-1.2-1.1 4.7-1.4 3.6 3.4-1.7 2.1 5.1-4.2-.2 1.3 5.6-.3 1.6 3.1-1.1 2.1 1.6.2 1.8 2.4-2.3 2.2 3.7-.6-.5 1.5 1.8 1.7-.6 2.4-4.6 7.9-2.5-5.4-39.2 16.1-1.4-3.1-2.3-.7 3.4-3.5-1.7-.6-2.8 1.7 2.5 10-1 1.9-2.1-1.1-2.5.8-3-2.5-2.8 1.4-2.7-1.6-3.2-7.1-1.4 4.5-3.3-1.1-1.2-2.2 2.4-.5-.5-3.5-3-.7-4.4-3.7.5-1.9-1.4-2.1.9-2.2 1.7.7.2-2.8-3-2.7 5.2 1.9-1.6-4.8 6 1.5 1.5 1.5 2.6-3.5 6.8 1.1 2.1-.9-1.2-.8-.3-.2zm-24.9-52.4 1 .3h-1.5zm-.5.3zm92.8 79.6-2.5 3.6 2 1.1 4.4-.6.6 1.8 2.4-2 1-3.5 1 2.3 1.7-2.9 4.7.4-1.5 3.7 1.8 3.8 2.5-.4 2.9-2.7v2.9l-1.7 2.1.6 5.8 2.6.6-.5-5.2 1.9-1.9v5.4l1.2 1.5.8-4.4 2.4 1.8-.1 2.9 1.5 4.7-3 3.6-2.6-4.9-1.4 4.7-1.2-.3-.4-5.5-2.7-3.4-1.3-.2.1 4.3-2.1 1.9-.4 5.8-4.3 2.3-.2-1.8 2.1-1.8.2-5.1-2-.7.6 2.6-2.9 1.6.5-1.7-2.8.7-3.9 3-8.1 1.8-6.2 4.3-3.1-2.2 3.7-8.5-2.1.3-3.1 2.2 1.2-2.5 1.9-.2-.5-5.8 2.7.6-2.6-4 1.6-1.7-1.2-1.5-.4-10.8 1.3-3.2-.5-4.4 3.9-5.3.2 1.4 2.4-2.1v3.2l-2.7.4 4.2 2.7-1.2-.6-1.3 12.5 1.4 4.6 1.6-7.5z',
  'NM':'m360.4 615.47-.36-2.23 4 .24 14 1.38 12.65.8 1.03-8.8 1.8-26.3.8-9.11.72.05.38-5.25-48.24-5-8.11 56.66 7.16.93.6-4.7z',
  'NS':'m671.78 439.63.3-1.5.7-.5 6.8-.6 4.9.2 2.6-4 .9 1.7 2.9-.9 1.1.5-2.9-3.7 1.3-5 1-6.8 1.4-.4 1.8 3.7-.7 8.6 1.8 1 1-3.7-2.3 1.4 1.8-4.8 3.7.2.8 1.4-2.6 5.1-3.1 2.8-2.6.4 2.9 1.3-.3 1.5-3.7 1.9-1.7 2.8-5.6 5.4-3.5 1.4.9 1.8-5.5 1 .8 2.6-1.9 5.7-2.7 3.7-2.3 1.5-2.3-2.6-1.2 1.3-1.8-3.1-.1-5.2 5.8-8 2.8-3 .6 2.1 4.2-4.7-8.8 2.9z',
  'NV':'m317.84 503.28-10.96 60.6-.86.18-.72 1.13h-1.1l-.68-1.29-1.22-.17-.36-.52-.48-.03-1.28.78-.15 3.2-.17 2.7-.16 4.05-.67.99-1.12-.5-32.05-49.04 8.8-31.8 43.2 9.72Z',
  'NY':'m613.17 466.54-.69.19-9.4 2.4h-.1l-3.5 2.14-.42.58-2.08 3.34-.35.71-.3.38-2.7 2.6.08 1.21.37.53.83.38h.82v.68l-.52 1 .15.68.67.99-.07 1.06-.9.53h-.97l-.75.93-.83 1.52-.96.83-2.4.23-1.22.54-.96.6-.75-.08-.9-.6-2.94.08-1.49.23-1.87.6-2.02.7-1.36.83.12.4.02-.02.04.19.58 1.88.4.46.56.05.6 1.45.08.45-.52.46-1 1.3-.2.76-.92.83-.82.54-.45.76-.6.53-.66.52.34 3.05 3.5-.58 19.94-4.1 8.98-2.07 1.15 1.27 1.6-.04.75 2.89 1.05.9 1.2.09.53.45v-.03l1.73.83 1.8.53 2.1.47 1.3.8.06.99-.2 1.28.1 1.75.54.24 1.87-.53 2.7-.91 1.2-.47 3.3-2.5 1.8-1.37 1.58-1.67-1.95-.76-.6.68-1.35 1.3-3.67 1.83-1.05-.08-.75-.3-.52.3-1.06 1.23-.68.6-.6.16-.15-.61.9-.83-.36-.8-.85-.94.52-1.06v-3.8l-.68-3.42-.38-1.68-.37-2.58.23-5.1.24-2.39-1.41-5.16-.31-.15-1.34-.6.37-1.38-.37-.99-1.2-2.13.44-1.82-.37-2.44-1.12-3.04Zm-10.19 2.6 1.28-1.26-.17.04-.01.01Z',
  'OH':'m567.82 506.94-2.83 1.9-1.8 1.06-1.58 1.75-1.87 1.83-1.5.38-1.35.23-2.55 1.21-.98.08-1.58-1.45-2.4.31-1.2-.69-1.1-.63-2.27.34-4.71.76-5.2 1.03.6 6.87.82 6.47 1.2 11.04.27 2.26 1.91-.05 1.12-.38 1.57.7.96 2.05h2.38l.87 1 .82-.03 1.18-.64 1.16.19 2.52.22.8-1 1.08-.61.97-.33.3 1.3.82.46 1.61 1.11 1.02-.04.61-.24.1-1.3.73-.68.05-2.25.47-1.93.6-.3.6.55.26.8.8-.5.2-.68-.52-.9.03-1.08.35-.5 1-1.57.49-.73.98.22 1.06-.76 1.42-1.6 1.28-1.91.15-2.38.22-2.35-.07-2.5-.46-1.36.16-.56.84-.82-1.05-4.27Z',
  'OK':'m403.16 566.91-7.73-.6-.42 5.16 9.5.54 14.86.62-1.08 11.49-.21 8.39.1.75 2.02 1.72.96.54.32-.1.32-.98.64.86h.94v-.65l1.28.65-.21 1.83 1.9.1 1.17.55 1.91.32 1.17.87 1.07-.98 1.58.32 1.17 1.62h.43V601l1.06.32 1.06-1.08.85.33h1.16l.43 1.18 2.91.98.65-.33.84-1.93h.54l.52.97 1.9.32 1.72.65 1.38.43.84-.43.32-1.19h2.02l.95.44 1.27-.98h.54l.31.76h1.9l.76-.97.84.22.96 1.18 1.48.86 1.49.43.9.52-.18-17.5-.64-5.16-.07-4.18-.67-3.07-.36-3.38-.03-1.8-5.64.16-21.52-.22-20.9-.97z',
  'ON':'m558.28 416.43-1.9-2.1 1-3 .2 1.1Zm46.7 49.9-.9 1.6-1.1 1.2-3.6 2.2-2.8 4.5-2.7 2.8-2.7 1.1-2.3 3.2-4.2.1-10.2 4.3-2.4 2.2-1.6 3.6 3.5.8 1.8-1.2.2 1v.7h.1l1.2 1.4h-.1l-8.8 3.2-2 2.6-6.3.2-3 4.3-5.4 3.3-3.7.2v-2.4h.1l4.5-1-1.8-2 .8-1 .2-3.8 4.4-4.4-1.2-7 2.5-5.7-1.1-3.7-2.9-2.4 2.8-.3.7 2.4h2.2l.8 3.7 1-1.5 5.1 1.7 2.1-3.7-3.3-2.9.2-2-2.2-.2-3.9-4.9-2.9.4-3.5-1.4-9.5.9-8.1-.6-.2-1.8-1.45-1.1-2.05-2.1-1.7-.9.9-3.3-3.4-2.9.2-3.6-5.5.9-2.5-1.9-3.1-5.9-5.8.5-6.7-1.6 4.6 2-2.5.3-3.9 3 1.6-2.2-1.2-1.5-1.2 4.9-.7-1.9-2.6 1.5-.6 3.3-1.6 1.4-4.1-.9-4.2.4-1-1.2-3.3 2.1-4.3-2.8-2.3 1.1-1.9-3-4.2-.9-3.3 1.3-6.5-2.9-.9-4.9-2.2-.8-.3-35.5 8.7-9 13.7-17.8 13.3-17.1 6 3.8 2.7 4 11.6 3.5 1.8 1.7 5.1 1.3 4-1.4 1.7.6 8.6.2.8 2.9-.5 6.4 2.5 4.1.9 5.5-.6 3.3 5.4 4.5 1.9 3.4 2.5.7 2.9 2.5 1.7 3.5 2.2.2 4.4 2.9 6.2 34 1.5 4.7 4.2 4.9 2.2 1.6 7.5.1 5.6 2.9 1-1.1 1.6 2.7 5.8.6 3.7-2.7 4.2-1.8 2 .4Zm-59.9 5.2 3.3-2.3h2.1l2.9 2-1.2 2.4-6.5-1.7-5.7-.1 4.6-1.7Z',
  'OR':'m295.73 498.56 4.1-16.37.48-2 1.1-2.65-.28-.54-1.18-.02-.58-.8.2-.68.24-1.52 2.06-2.6.84-.5.54-.55.69-1.67 1.87-2.68 1.65-1.81.1-1.64-1.5-1.15-.83-2.18-5.88-1.7-7-1.67-7.16.05-.2-.65-2.55.98-2.07-.27-1.12-.75-.59.32-2.16-.1-.8-.66-2.44-.97-.37.06-2.01-.7-.91.86-2.86-.16-2.76-1.94.32-.38.1-3.65-1.06-1.83-1.9-.28-.32-1.18-1.1-.21-2.68.96-1.04 3.04-1.5 4.71-1.51 3.05-2.32 6.62-3.01 6.4-3.75 5.92-.9 1.38-.38 4.03.18 5.69 52.23 12.39Z',
  'PA':'m609.47 521.7.6-.14 1.09-.58.55-1.18.75-1.06 1.5-1.44v-.38l-1.13-.76-1.64-1.14-.46-1.22-1.26-.16-.08-.53-.37-1.29 1.04-.53.07-1.15-.6-.6.08-.76.9-1.45v-1.44l1.25-1.25-.43-.32-1.16-.09-1.07-.91-.72-2.88-1.62.05-1.14-1.27-8.4 1.97-19.93 4.1-4.13.69-.29-3.07-2.49 2.38-.6.22-1.94 1.41 1.35 9.02 1.15 4.58 1.65 9.06 1.52-.3 5.54-.7 17.59-3.61 6.9-1.34 3.85-.76.12-.1.98-.77.98-.32Z',
  'PE':'m676.58 431.73 8.1-3.7-2.2 1.9.2 4.1-2 .7-1.4-1.7-4.6 1.4-1.3-1.4-2.6.8-.7-1.8-2.2-.1 1.4-4.7.4 3 3.7 2.1v-1.2z',
  'QC':'m638.58 341.13 2.3 4.5 2.4-.6-.5 2.3.9 3.3-1 2-.9 1.7-6.8-1.1-2.6 3.5-1.5-1.5-6-1.5 1.6 4.8-5.2-1.9 3 2.7-.2 2.8-1.7-.7-.9 2.2 1.4 2.1-.5 1.9 4.4 3.7 3 .7.5 3.5-2.4.5 1.2 2.2 3.3 1.1 1.4-4.5 3.2 7.1 2.7 1.6 2.8-1.4 3 2.5 2.5-.8 2.1 1.1 1-1.9-2.5-10 2.8-1.7 1.7.6-3.4 3.5 2.3.7 1.4 3.1 39.2-16.1 2.5 5.4-3.7 1-2.8 3-2.8 4.8.7 1.7-1.8 2.6-2.8 6.2-4.4 1.4-4.8 3.6-1.4-.9-12.3 3.8-2.5 1.4-6.5 1.7-4.7 3.1h-2.3l-3.1 5.7.1 5.3-4.2 1.8-.3 1.9-2.4 1.5-2.2 3.9-1.1 5.2-1.4 2.3-1.4 7.1-1.6 1-.6 3.6-3 4.6 4.5-3.9 2.1-5.5 4.2-9.3 4.2-5.7 8.7-8 6.2-3.7 7-.6 3.6 2.3v3.8l-5.5 6.4-3.8-1.1-.8 1.7-1.5.9-3 1.7-3.3 2.3-1.7-.7-4.8 2.3 1.1 3.6-3.7 4-1.8-1.1-2.8 8.6.1 10.3-1.5 2.1-.6 3.6-1.4-.2-1.6.6-.5 3-8.2 2.3-4.5 1.2-9.4 2.4h-.1l5.6-5.5-3.6 2.7-1.1-3.4-2-.4-4.2 1.8-3.7 2.7-5.8-.6-1.6-2.7-1 1.1-5.6-2.9-7.5-.1-2.2-1.6-4.2-4.9-1.5-4.7-6.2-34 1.4 1.3-1.5-1.5-.7-4-.2-1.1.7-2.2 2.6 1.7.9 2.2.1-4-1.8-1.3 2.1-4 .1-2.6-4.3-6.3-.5-3.7-1.3-1.1-.1-5.4-2.8-1.3-3.2-4.3 7.5-5.4 3.1-3.3 3.1-4.9 1.7-4.7-.7-7.5-1.6-5-4.3-6.6-3.5-2.7-2.7-.7-3.6-2.5-.3-2.4 3.2-4.9-.8-4.2 2.5-1.8-.2-2.2-3.6-4 .8-1.5-4-2.8 1.4-2.7-.7-4 1.2-.6-3.7-3.8-1.2-4.4 2.7-3.8 2.7-.1 7.6 1.5 1.3-.9 3.2 1.1 4.6-4.8 3.9 2.4 2.4.1.5 1.6 2.8.4-.1 1.5 3 .2-.6 2.6 3.5 2.3h5.1l.4-1 2.8 2.2 1.3-3.1 1.7 2.7-1.4 3.5 2.1 2.8-.1 2.9 1.4.8 1.4 5.9 2.3.1-1.3 1.6 1.2 2.3-2.2 2 1.3 1.6 1.9-4 2.5-1 2.7.8 1.7 2.1 3.8.3.1 3 2.9-4.9 1.3-1 .5-3.7 1.7.3 1.4-3.9-1.2-1.8 1.9-.8-2.5-4.3 1.6-3.4-.3-4.3h1.8v.3l.1.4.1 1.3.7 6.2 2.6-.5.2 2.7 1.8 2.9 2.3 1.8 1.7-2.1 1.6 1.2-2.5 1.4 1.9 1.6-2 4.1 3.4 3.5 2.3.4 1.9 8.1-.7 2.5 2.3 1.8-1.5.7 2.1 3.4 3.3-.6Zm-27.1 114.8 2.3-1.8 4.7-6.4 1 .1 1.9-1.6-3.2 1.3-3.9 5.2-2.4 1.5Zm6.8-157.4Zm0 0Zm54.9 105.4-9.5.2-3.1-2-3.6-.1 1.3-2.1 5.1-.6 6.1.2 5 .8 2 2Z',
  'RI':'m632.17 500.14-1.71-7.04 2.9-.86 1.02.9 1.53 2.03 1.25 2.07-1.39.76-.6-.07-.52.84-1.13.91z',
  'SC':'m581.56 608-.83.47-1.2-.6-.3-1-.6-1.68-1.05-.98-1.2-.3-.75-2.29-1.29-2.82-1.94-.9-.97-.92-.6-1.21-.97-.92-1.05-.6-1.05-1.38-1.42-1.06-2.1-.83-.23-.68-1.12-1.38-.23-.68-1.57-2.43-1.58.08-1.87-1.14-.6-.61-.15-.84.38-.91 1.04-.46-.23-1.07 2.67-1.1 4.22-2.16 3.62-.39 7.47-.2 1.22.89.78 1.57 2-.28 5.85-.68 1.35.38 5.85 3.58 4.69 3.82-2.51 2.56-1.2 2.88-.24 2.97-.74.38-.53 1.3-1.12.3-.98 1.7-1.27 1.27-1.05 1.6-.75.38-1.65 1.6-1.34.07.44 1.53-2.33 2.58-.97.61Z',
  'SD':'m447.74 511.96-.02-.27-1.34-2.28.86-2.22.69-2.77-1.3-.98-.17-1.28.38-1.2h1.46l-.05-2.35-.16-14.2-.28-1.77-1.89-1.58-.46-.78-.02-.76.93-.7.72-.8.1-1.25-27.02-.75-25.41-1.63-2.47 29.97 6.77.44 9.24.56 8.24.43 11.03.61 5.54-.2.91 1.06 2.42 1.52.35.35 2.11-.69 3.03-.28.78.63 1.96.75 1.36.77.18.7.49 1.05z',
  'SK':'m415.68 445.33-7.1-.5-10.9-.9-39.7-4.8v-.1l17.7-114.1 40.7 4.6 2.7.1v.1l-3 44.7Z',
  'TN':'m549.9 565.7-24.08 2.36-7.3.84-2.15.25-1.8-.01-.1 1.92-3.8.13-3.22.31-3.53-.1-.6.64-.36 2.74-.7 2.56-.25 1.3-.63 2.06-.15 1.22-1.56.98.99 1.52-.01 1.16.03 1.2 47.33-4.6.19-1.86.84-.7 1.32-.35.32-1.74 1.89-1.27 1.88-.71 1.9-1.68 2.06-.95.25-1.45 1.88-1.87.25-.05s.02.55.39.55.9.15.9.15l1.05-1.68.96-.31 1.06.13.74-1.66 1.37-1.24.19-.91.14-1.75-.99-.1-1.2.96h-3.26l-8.5 1.13-3.75.9Z',
  'TX':'m394.4 571.5 10.53.51 14.42.55-1.08 11.03-.14 8.54.03.97 2.02 1.8.92.69.54-.27.18-.86.53.85.98.03v-.68l.77.46.53.18-.16 1.87 1.9.05 1.34.56 1.84.25 1.1.98 1-.98 1.72.28 1.03 1.53.5.15-.07.92 1.03.37 1.07-.97.99.29 1.03.01.43 1.14 2.94 1 .73-.35.7-1.97h.15l.43.04.56.97 1.83.31 1.55.53 1.6.56.84-.46.33-1.18 2.06.02.84.43 1.3-.99.52.02.39.77h1.88l.7-.96.87.19.91 1.13 1.63.95 1.32.38.7.39 1.14.93 1.4-.62 1.26.54.26 2.87-.02 4.56.32 4.5.33 1.69 1.24 2.08.42 2.33 1.96 2.6.09 1.48.35.37-.35 3.94-1.33 2.37.7 1-.28 1.12-.31 3.48-.7 1.57.13 1.64-2.63.76-4.57 2.12-.45.92-1.2.9-.97.7-.6.37-2.62 2.52-1.28.98-2.48 1.52-2.63 1.14-2.92 1.6-.82.7-2.7 1.66-1.57.3-1.8 2.6-1.88.15-.45.9 1.06.92-.68 2.6-.6 2.12-.52 1.82-.38 2.13.37 1.14.83 3.26.45 2.9.83 1.3-.46.68-1.42.91-2.63-1.82-2.55-.54-.6.23-1.5-.3-1.95-1.45-2.4-.53-3.52-1.6-.97-1.83-.6-3.04-1.5-.91-.3-1.06.3-.3.14-1.6-.6-.3-.3-.47.6-2.05-.74-1.06-1.5-.61-1.57-2.06-1.67-3.11-1.94-1.22.08-.92-2.48-5.78-.37-1.98-.83-.91-.07-.69-2.78-2.5-1.2-1.45v-.53l-1.2-1-3.15-.52-3.44-.31-1.42-1.06-2.1.83-1.66.7-1.04 1.51-.46 1.75-2.03 2.9-1.12 1.13-1.2-.46-.82-.52-.9-.3-1.8-1.07v-.3l-.83-.92-2.4-.99-3.45-3.65-1.06-2.2v-3.82l-1.49-3.04-.22-1.29-.75-.45-.54-.99-2.31-.99-.6-.75-3.3-3.73-.6-1.52-2.17-1.07-.68-2.05-1.2-1.37-.9-.23-.3-2.2 3.7.33 13.48 1.28 13.46.76 1.04-9.16 1.8-26.14.75-8.82.63.01m45.94 108.06-.27-3.35-1.27-3.37-.26-3.32.71-3.87 1.53-3.24 1.62-2.54 1.45-1.67.31.1-2.2 3.13-2.04 3.08-.93 3.12-.15 2.43.42 2.89 1.18 3.38.23 2.43.08.7z',
  'UT':'m347.11 561.88-38.85-5.6 9.56-52.94 21.69 4.1-.69 5.01-1.06 6.2 3.6.43 7.62.85 3.8.4Z',
  'VA':'m612.48 541.15-.06-.92 3-1.2-.36 1.53-1.36 1.77-.2 2.16.22 1.59-.86 2.34-1 .9-.68-2.18.2-2.57.75-1.97zm1.56 13.32-26.99 5.91-17.35 2.5-3.1-.17-1.2.9-3.4.1-3.9.46-5.05.76 4.84-2.65v-.98l.7-1 4.9-5.42 1.83 2.12 1.76.45 1.17-.53 1.04-.63 1.18.64 1.82-.67.86-2.15 1.2.26 1.33-1.01.84.23 1.32-1.73.16-.98-.45-.6.47-.87 2.44-5.78.28-2.7.58-.24 1.02 1.14 1.82-.14.9-3.56 1.3-.27.47-1.3 1.2-1.1 1.29-2.67.04-2.39 4.56 1.8c.32.16.39-2.38.39-2.38l1.69.76.03 1.37 2.69.62.98.54.77.98-.3 1.71-.91 1.22.05.97.27.88 2.32.6h2.06l1.42.45.91.15.32 1.44 1.49.2.4.57-.2 2.2.64.53-.22.9.57.37-.1.66-1.26-.04.05.75 1.06.73.05.66.82.84.24 1.18-1.19.65.73.71 2.7-.8 1.66 2.83Z',
  'VT':'m625.2 463.06-.02.17-8.2 2.3-3.94 1.05.27 1.68 1.12 3.04.38 2.44-.46 1.83 1.25 2.17.38.99-.38 1.38 1.35.6.3.15 1.34 5.08-.14 2.51h.01l2.08-.35 3.46-.7-.48-.35.23-.8.07-2.15-.45-.6.1-2.62.29-4.35.14-3.8-.6-.72v-.53l1.2-.53 1.72-2.38v-1.9l-.89-1.3Z',
  'WA':'m274.1 419.57-.53.38-.14.38 1.12 2.29.52 1.22-.82 1.66v1.06l.3.69-.38.83.23 1.52.45.6-.08.62-.68.08-.3-.92-.53-1.14-.82-.69.15-.99 1.04-.23-.14-.84-.16-.53-.97.6-.6.55v1.12l-1.05.08-1.57-.45-1.35-.69-1.42-.3-2.1-.99-1.5-.91-1.28-1.21-1.12-1.38-.98-.22-1.04 4.4.8 1.52v3.71l-.3 1.38.68 3.35 1.27 1.29-2.02.3-.08 1.75 1.2.53-.75 1.9-1.27.15-.15 1.38 1.05 1.5 1.65-.56 1.05.2.32 1.2 1.91.28 1.06 1.82-.06 3.61-.35.43 2.75 1.94 2.9.14.88-.85 2.04.72.33-.07 2.45 1 .8.63 2.18.06.61-.3 1 .74 2.13.35 2.6-1.03.2.63 7.08-.01 7.19 1.69 5.77 1.65 6.18-29.2-36.37-9.76-.6-.2Zm-2.52 2.61-.72.76-.22-.65-.93.07h-.01l.22 1.2.71 1.06.33-.3.17-.7.78.27s-.67 1.06-.67 1.22.41.11.41.11l.64-.2.34-.95-.3-.38.7-.8-.37-.71Z',
  'WI':'m512.04 508.84-.04-1.5-.55-2.12-.3-2.9-.51-1.14.44-1.44.37-1.37.68-1.22-.3-1.58-.3-1.68.23-.85.9-1.14.08-1.29-.38-.6.3-1.22-.21-1.96 1.28-2.66 1.33-3.2.09-1.07-.15-.46-.38.23-1.94 2.97-1.28 1.9-.9.85-.37 1.06-.91.38-.52.91-.67-.15-.08-.83.6-1.14.98-2.2.82-.77.46-1.1-1.19-.9-.91-4.87-1.66-.63-.9-1.09-5.61-1.3-1.35-.47-3.8-1.01-3.67-.55-1.75-2.41-.36.26-.55-.08-.3-.53-.63.14-.52.07-.82.46-.45-.31.3-.91.9-1.45.52-.53-.9-.69-.97.38-1.35.92-3.44 1.52-1.35.3-1.35-.23-.45-.4-.99 1.33-.1 1.3v3.97l-.54.76-2.43 1.82-1.06 2.8.21.11 1.17.97.32 1.5-.86 1.5v1.83l.21 3.13 1.38 1.4h1.6l.84 1.5 1.6.22 1.8 2.69 3.29 1.94.96 1.3.43 3.49.31 1.56 1.07.75.1.65-.96 1.6.1 1.5 1.17 1.83 1.17.55 1.38.21.63.65 21-1.25Z',
  'WV':'m579.81 528.4.51 2.33.5 2.84 1-1.22 1.05-1.44 1.17-.28.68-.7.83-1.2.67.3 1.35-.16 1.2-.99.93-.68.86-.23.6.48 1.69.86.9.84.64.6-.36 2.62-2.7-1.2-1.99-.76-.03 2.43-1.28 2.61-1.17 1.15-.56 1.29-1.22.23-.42 1.7-.47 1.85-1.85.16-1.08-1.14-.5.25-.3 2.58-.62 1.67-2.3 5.15.41.54-.09.9-1.3 1.84-.84-.26-1.37 1.02-1.18-.27-.93 2.14s-1.51.67-1.82.65c-.08 0-1.14-.59-1.14-.59l-1.1.65-1.12.5-1.73-.43-.52-.54-1.01-1.43-1.46-.94-.79-1.7-1.98-1.63-.3-1.07-1.2-.68-.38-.77-.11-2.47 1.01-.04.9-.38.08-1.3.74-.68.08-2.36.45-1.83.6-.3.59.52.23.85.82-.45.23-.77-.54-.83v-1.14l.46-.61 1.05-1.6.6-.68.97.23 1.06-.76 1.42-1.59 1.04-1.83.15-2.66.23-2.36v-2.21l-.54-1.44.46-.68.6-.61 1.62 9.33 2.15-.35 5.77-.85Z',
  'WY':'m393.9 483.38-49.5-6.33-6.55 41.62 52.54 6.38z',
};

// Hub positions (SVG coordinates matching mapchart.net projection)
const HUB_POSITIONS = {
  // NG hubs
  'Henry Hub':      { x:492, y:645 },
  'Waha':           { x:405, y:632 },
  'SoCal Gas':      { x:293, y:604 },
  'Chicago':        { x:518, y:509 },
  'Algonquin':      { x:630, y:501 },
  'Transco Zone 6': { x:621, y:520 },
  'Dominion South': { x:575, y:534 },
  'Dawn':           { x:562, y:499 },
  'Sumas':          { x:272, y:430 },
  'Malin':          { x:263, y:516 },
  'Opal':           { x:349, y:515 },
  'Tetco M3':       { x:606, y:524 },
  'Kern River':     { x:286, y:590 },
  // Crude hubs
  'WTI Cushing':    { x:453, y:578 },
  'Brent Dated':    { x:728, y:365 },
  'WTI Midland':    { x:416, y:625 },
  'Mars Sour':      { x:515, y:653 },
  'LLS':            { x:502, y:645 },
  'ANS':            { x:210, y:350 },
  'Bakken':         { x:396, y:445 },
  'WCS':            { x:332, y:396 }
};

// Pipeline routes (SVG polyline coords)
const PIPELINES = [
  // === NG PIPELINES ===
  { name:'Transco', points:'492,645 520,610 548,578 570,555 595,538 610,528 621,520', color:'#22d3ee', sector:'ng' },
  { name:'Tennessee Gas', points:'492,645 515,610 540,575 565,545 590,518 610,505 630,501', color:'#ef4444', sector:'ng' },
  { name:'Kern River', points:'349,515 330,530 310,555 295,575 286,590', color:'#0ea5e9', sector:'ng' },
  { name:'Rockies Express', points:'349,515 385,513 420,511 460,510 490,509 518,509', color:'#10b981', sector:'ng' },
  { name:'Alliance', points:'332,396 360,418 395,445 440,470 480,492 518,509', color:'#06b6d4', sector:'ng' },
  { name:'Texas Eastern', points:'492,645 515,612 538,578 560,548 580,535 606,524', color:'#e11d48', sector:'ng' },
  { name:'Northwest', points:'349,515 325,495 300,470 280,452 272,430', color:'#f97316', sector:'ng' },
  { name:'El Paso', points:'405,632 380,625 350,615 320,610 293,604', color:'#a78bfa', sector:'ng' },
  { name:'Algonquin Lateral', points:'621,520 625,510 630,501', color:'#ec4899', sector:'ng' },
  { name:'Dawn-Chicago', points:'562,499 540,504 518,509', color:'#84cc16', sector:'ng' },
  // === CRUDE PIPELINES (from GEM Global Oil Infrastructure Tracker GeoJSON) ===
  { name:'Keystone', points:'332,393 339,412 406,418 433,421 436,452 441,491 447,529 464,535 480,538 494,543 448,547 449,566 454,580 458,596 466,611 469,627 472,643', color:'#22d3ee', sector:'crude' },
  { name:'DAPL', points:'401,440 391,442 399,447 406,453 418,462 429,474 438,482 446,493 457,500 468,507 475,512 483,519 491,526 499,536 509,545', color:'#84cc16', sector:'crude' },
  { name:'Seaway', points:'452,578 453,587 455,594 458,619 459,625 476,647', color:'#f59e0b', sector:'crude' },
  { name:'Permian Express', points:'416,624 425,618 430,619 444,618 451,621 455,619 462,627 467,635 474,643 477,645', color:'#a78bfa', sector:'crude' },
  { name:'Alberta Clipper', points:'332,392 379,414 434,429 450,443 480,456', color:'#ec4899', sector:'crude' },
  { name:'Capline', points:'509,543 501,544 503,623 506,598 512,563 525,555 557,547', color:'#f97316', sector:'crude' },
  { name:'Longhorn', points:'414,631 465,648', color:'#10b981', sector:'crude' },
  { name:'TAPS', points:'205,345 210,350', color:'#ef4444', sector:'crude' },
  { name:'Trans Mountain', points:'246,433 261,429 265,408 272,405 271,390 280,392 287,384 314,383', color:'#06b6d4', sector:'crude' }
];

// Pipe legend names per sector
const PIPE_LEGENDS = {
  ng: [
    { name:'Transco', color:'#22d3ee' }, { name:'Tennessee Gas', color:'#ef4444' },
    { name:'Texas Eastern', color:'#e11d48' }, { name:'Kern River', color:'#0ea5e9' },
    { name:'Rockies Express', color:'#10b981' }, { name:'Alliance', color:'#06b6d4' },
    { name:'Northwest', color:'#f97316' }, { name:'El Paso', color:'#a78bfa' }
  ],
  crude: [
    { name:'Keystone', color:'#22d3ee' }, { name:'DAPL', color:'#84cc16' },
    { name:'Seaway', color:'#f59e0b' }, { name:'Permian Express', color:'#a78bfa' },
    { name:'Alberta Clipper', color:'#ec4899' }, { name:'Capline', color:'#f97316' },
    { name:'Longhorn', color:'#10b981' }, { name:'Trans Mountain', color:'#06b6d4' }
  ]
};

// Map zoom state per sector
const MAP_ZOOM = {
  ng:    { vx: 190, vy: 320, vw: 560, vh: 375, baseVx: 190, baseVy: 320, baseVw: 560, baseVh: 375, zoom: 1 },
  crude: { vx: 190, vy: 320, vw: 560, vh: 375, baseVx: 190, baseVy: 320, baseVw: 560, baseVh: 375, zoom: 1 }
};

function renderPipelineMap(sector) {
  const container = document.getElementById(sector + 'MapContainer');
  if (!container) return;

  const hubs = ALL_HUB_SETS[sector] || [];
  const thm = document.documentElement.getAttribute('data-theme');
  const isLight = thm === 'light';
  const isMed = thm === 'medium';
  const landFill = isLight ? '#e8ecf0' : (isMed ? '#2d3344' : '#141e2e');
  const landStroke = isLight ? '#cbd5e1' : (isMed ? '#3d4455' : '#1e2d3d');
  const waterFill = isLight ? '#dce5f0' : (isMed ? '#1a1f2e' : '#0a0e14');
  const stateBorder = isLight ? '#b0bec5' : (isMed ? '#353d50' : '#1a2738');
  const textFill = isLight ? '#475569' : '#94a3b8';
  const brightText = isLight ? '#1e293b' : '#e2e8f0';

  const sectorPipes = PIPELINES.filter(p => p.sector === sector);
  const legends = PIPE_LEGENDS[sector] || [];
  const sectorTitle = sector === 'ng' ? 'Natural Gas Pipeline Network' : 'Crude Oil Pipeline Network';

  // Canadian province codes and US state codes
  const canadaCodes = ['BC','AB','SK','MB','ON','QC','NB','NS','PE','NL'];
  const usCodes = Object.keys(STATE_PATHS).filter(k => !canadaCodes.includes(k));

  // Build SVG with viewBox cropped to continental US + southern Canada
  const z = MAP_ZOOM[sector];
  let svg = `<svg viewBox="${z.vx} ${z.vy} ${z.vw} ${z.vh}" width="100%" style="max-width:850px;min-width:450px" xmlns="http://www.w3.org/2000/svg" data-sector="${sector}">`;
  // Ocean background
  svg += `<rect x="140" y="280" width="650" height="430" fill="${waterFill}" rx="6"/>`;

  // Draw Canadian provinces (slightly transparent)
  canadaCodes.forEach(code => {
    if (STATE_PATHS[code]) {
      svg += `<path d="${STATE_PATHS[code]}" fill="${landFill}" stroke="${stateBorder}" stroke-width="0.3" opacity="0.7"/>`;
    }
  });

  // Draw US states
  usCodes.forEach(code => {
    if (STATE_PATHS[code]) {
      svg += `<path d="${STATE_PATHS[code]}" fill="${landFill}" stroke="${stateBorder}" stroke-width="0.35"/>`;
    }
  });

  // Alaska inset box (for crude only)
  if (sector === 'crude') {
    svg += `<rect x="195" y="332" width="40" height="28" fill="${landFill}" stroke="${stateBorder}" stroke-width="0.5" rx="3"/>`;
    svg += `<text x="215" y="342" text-anchor="middle" fill="${textFill}" style="font-size:5px;font-family:var(--font-sans)">Alaska</text>`;
  }
  // Brent label (for crude, Atlantic area)
  if (sector === 'crude') {
    svg += `<text x="728" y="360" text-anchor="middle" fill="${textFill}" style="font-size:5px;font-family:var(--font-sans)">North Sea</text>`;
  }

  // Pipelines
  sectorPipes.forEach(pipe => {
    svg += `<polyline class="pipe" points="${pipe.points}" stroke="${pipe.color}" data-name="${pipe.name}"/>`;
    const pts = pipe.points.split(' ').map(p => p.split(',').map(Number));
    const mid = pts[Math.floor(pts.length / 2)];
    if (mid) {
      svg += `<text class="pipe-label" x="${mid[0]}" y="${mid[1] - 5}" text-anchor="middle" fill="${pipe.color}" opacity="0.7">${pipe.name}</text>`;
    }
  });

  // Hub dots and labels
  hubs.forEach(h => {
    const pos = HUB_POSITIONS[h.name];
    if (!pos) return;
    const price = getPrice(h.name);
    const isSelected = STATE.selectedHubs[sector] === h.name;
    const r = isSelected ? 6 : 4.5;
    const strokeW = isSelected ? 2 : 1.2;

    svg += `<circle class="hub-dot" cx="${pos.x}" cy="${pos.y}" r="${r}" fill="${h.color}" stroke="${isSelected ? '#fff' : h.color}" stroke-width="${strokeW}" opacity="${isSelected ? 1 : 0.85}" onclick="mapHubClick('${sector}','${h.name}')"/>`;

    const anchor = pos.x > 650 ? 'end' : 'start';
    const lx = pos.x > 650 ? pos.x - 8 : pos.x + 8;
    const ly = pos.y - 2;

    svg += `<text class="hub-label" x="${lx}" y="${ly}" text-anchor="${anchor}" fill="${textFill}" style="font-size:7px">${h.name}</text>`;
    const isLargeNum = h.name.includes('Baltic') || h.name.includes('Index') || h.base > 100;
    const priceStr = isLargeNum ? '$' + price.toFixed(0) : '$' + price.toFixed(2);
    svg += `<text class="hub-price-label" x="${lx}" y="${ly + 9}" text-anchor="${anchor}" fill="${brightText}" style="font-size:8px;font-weight:600">${priceStr}</text>`;
  });

  // Title
  svg += `<text x="470" y="688" text-anchor="middle" fill="${textFill}" style="font-size:9px;font-family:var(--font-sans);font-weight:600">${sectorTitle}</text>`;
  svg += `</svg>`;

  // Legend
  let legend = '<div class="map-legend">';
  legends.forEach(l => {
    legend += `<div class="map-legend-item"><div class="map-legend-line" style="background:${l.color}"></div>${l.name}</div>`;
  });
  legend += '</div>';

  const zoomPct = Math.round(z.zoom * 100);
  container.innerHTML = `<div class="pipeline-map-card"><div class="card-header"><span>${sectorTitle}</span><div style="display:flex;align-items:center;gap:4px"><div class="map-zoom-controls"><button class="map-zoom-btn" onclick="mapZoom('${sector}',-1)" title="Zoom out">−</button><span class="map-zoom-level" id="${sector}ZoomLvl">${zoomPct}%</span><button class="map-zoom-btn" onclick="mapZoom('${sector}',1)" title="Zoom in">+</button><button class="map-zoom-btn" onclick="mapZoomReset('${sector}')" title="Reset" style="font-size:12px">⌂</button></div><button class="btn btn-ghost btn-sm" onclick="toggleMap('${sector}')">Hide</button></div></div><div class="pipeline-map-wrap" id="${sector}MapWrap">${svg}</div>${legend}</div>`;

  // Attach wheel zoom + drag pan
  initMapZoom(sector);
}

function initMapZoom(sector) {
  const wrap = document.getElementById(sector + 'MapWrap');
  if (!wrap) return;
  const svgEl = wrap.querySelector('svg');
  if (!svgEl) return;

  // Wheel zoom
  wrap.addEventListener('wheel', e => {
    e.preventDefault();
    const dir = e.deltaY < 0 ? 1 : -1;
    mapZoomAt(sector, dir, e);
  }, { passive: false });

  // Drag pan
  let dragging = false, startX = 0, startY = 0, startVx = 0, startVy = 0;
  wrap.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    dragging = true; wrap.classList.add('dragging');
    startX = e.clientX; startY = e.clientY;
    const z = MAP_ZOOM[sector];
    startVx = z.vx; startVy = z.vy;
    e.preventDefault();
  });
  window.addEventListener('mousemove', e => {
    if (!dragging) return;
    const z = MAP_ZOOM[sector];
    const rect = svgEl.getBoundingClientRect();
    const scaleX = z.vw / rect.width;
    const scaleY = z.vh / rect.height;
    z.vx = startVx - (e.clientX - startX) * scaleX;
    z.vy = startVy - (e.clientY - startY) * scaleY;
    svgEl.setAttribute('viewBox', `${z.vx} ${z.vy} ${z.vw} ${z.vh}`);
  });
  window.addEventListener('mouseup', () => {
    if (dragging) { dragging = false; wrap.classList.remove('dragging'); }
  });

  // Touch support
  let lastTouchDist = 0;
  wrap.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      dragging = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY;
      const z = MAP_ZOOM[sector]; startVx = z.vx; startVy = z.vy;
    } else if (e.touches.length === 2) {
      lastTouchDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
    }
    e.preventDefault();
  }, { passive: false });
  wrap.addEventListener('touchmove', e => {
    if (e.touches.length === 1 && dragging) {
      const z = MAP_ZOOM[sector]; const rect = svgEl.getBoundingClientRect();
      z.vx = startVx - (e.touches[0].clientX - startX) * (z.vw / rect.width);
      z.vy = startVy - (e.touches[0].clientY - startY) * (z.vh / rect.height);
      svgEl.setAttribute('viewBox', `${z.vx} ${z.vy} ${z.vw} ${z.vh}`);
    } else if (e.touches.length === 2) {
      const dist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
      if (lastTouchDist > 0) {
        const dir = dist > lastTouchDist ? 1 : -1;
        mapZoom(sector, dir * 0.5);
      }
      lastTouchDist = dist;
    }
    e.preventDefault();
  }, { passive: false });
  wrap.addEventListener('touchend', () => { dragging = false; lastTouchDist = 0; });
}

function mapZoomAt(sector, dir, e) {
  const z = MAP_ZOOM[sector];
  const wrap = document.getElementById(sector + 'MapWrap');
  const svgEl = wrap && wrap.querySelector('svg');
  if (!svgEl) return;

  const factor = dir > 0 ? 0.8 : 1.25;
  const newW = z.vw * factor;
  const newH = z.vh * factor;

  // Zoom toward mouse position
  if (e) {
    const rect = svgEl.getBoundingClientRect();
    const mx = (e.clientX - rect.left) / rect.width;
    const my = (e.clientY - rect.top) / rect.height;
    z.vx += (z.vw - newW) * mx;
    z.vy += (z.vh - newH) * my;
  } else {
    z.vx += (z.vw - newW) / 2;
    z.vy += (z.vh - newH) / 2;
  }

  z.vw = newW; z.vh = newH;
  z.zoom = z.baseVw / z.vw;

  // Clamp zoom 0.5x – 5x
  if (z.zoom < 0.5) { mapZoomReset(sector); return; }
  if (z.zoom > 5) { z.zoom = 5; z.vw = z.baseVw / 5; z.vh = z.baseVh / 5; }

  svgEl.setAttribute('viewBox', `${z.vx} ${z.vy} ${z.vw} ${z.vh}`);
  const lbl = document.getElementById(sector + 'ZoomLvl');
  if (lbl) lbl.textContent = Math.round(z.zoom * 100) + '%';
}

function mapZoom(sector, dir) {
  mapZoomAt(sector, dir, null);
}

function mapZoomReset(sector) {
  const z = MAP_ZOOM[sector];
  z.vx = z.baseVx; z.vy = z.baseVy; z.vw = z.baseVw; z.vh = z.baseVh; z.zoom = 1;
  const wrap = document.getElementById(sector + 'MapWrap');
  const svgEl = wrap && wrap.querySelector('svg');
  if (svgEl) svgEl.setAttribute('viewBox', `${z.vx} ${z.vy} ${z.vw} ${z.vh}`);
  const lbl = document.getElementById(sector + 'ZoomLvl');
  if (lbl) lbl.textContent = '100%';
}

function mapHubClick(sector, hubName) {
  setSelectedHub(sector, hubName);
  // Re-render the map to update selected state
  if (MAP_STATE[sector]) renderPipelineMap(sector);
}



/* =====================================================================
   CLOCK, MARKET STATUS & CALENDAR
   ===================================================================== */
let MARKET_HOLIDAYS = new Set();
let MARKET_OPEN = true;
let MARKET_REASON = 'Open';

function updateClock() {
  // Show Central Time
  const now = new Date();
  const ct = new Date(now.toLocaleString('en-US', {timeZone: 'America/Chicago'}));
  const h = ct.getHours().toString().padStart(2,'0');
  const m = ct.getMinutes().toString().padStart(2,'0');
  const s = ct.getSeconds().toString().padStart(2,'0');
  const el = document.getElementById('clockTime');
  if(el) el.textContent = h+':'+m+':'+s;
}

async function fetchMarketStatus() {
  try {
    const r = await fetch(API_BASE+'/api/market-status');
    const d = await r.json();
    MARKET_OPEN = d.open;
    MARKET_REASON = d.reason;
    if(d.holidays) MARKET_HOLIDAYS = new Set(d.holidays);
    const badge = document.getElementById('mktBadge');
    if(badge) {
      if(MARKET_OPEN) {
        badge.className='mkt-badge mkt-open';
        badge.textContent='MARKET OPEN';
      } else {
        badge.className='mkt-badge mkt-closed';
        badge.textContent=MARKET_REASON==='Holiday'?'HOLIDAY':'MKT CLOSED';
      }
    }
  } catch(e) { console.warn('Market status fetch failed', e); }
}

function initClock() {
  try {
    document.getElementById('clockWrap').style.display = 'flex';
    updateClock();
    setInterval(updateClock, 1000);
    fetchMarketStatus();
    setInterval(fetchMarketStatus, 60000);
  } catch(e) { console.warn('initClock error:', e); }
}

// Calendar
let calYear, calMonth;
function openCalendar() {
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();
  renderCalendar();
  document.getElementById('calModal').classList.add('show');
}
function closeCalendar() { document.getElementById('calModal').classList.remove('show'); }
function calNav(dir) { calMonth+=dir; if(calMonth<0){calMonth=11;calYear--;}if(calMonth>11){calMonth=0;calYear++;} renderCalendar(); }
function renderCalendar() {
  const title = new Date(calYear, calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  document.getElementById('calTitle').textContent = title;
  const grid = document.getElementById('calGrid');
  const today = new Date();
  const todayStr = today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
  let html = ['Su','Mo','Tu','We','Th','Fr','Sa'].map(d=>`<div class="cal-day-hdr">${d}</div>`).join('');
  const first = new Date(calYear, calMonth, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  for(let i=0;i<startDay;i++) html+='<div class="cal-day"></div>';
  for(let d=1;d<=daysInMonth;d++) {
    const ds = calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const dow = new Date(calYear,calMonth,d).getDay();
    const isToday = ds===todayStr;
    const isHoliday = MARKET_HOLIDAYS.has(ds);
    const isWeekend = dow===0||dow===6;
    let cls = 'cal-day';
    if(isToday) cls+=' today';
    else if(isHoliday) cls+=' holiday';
    else if(isWeekend) cls+=' weekend';
    html+=`<div class="${cls}" title="${isHoliday?'Market Holiday':isWeekend?'Weekend':''}">${d}</div>`;
  }
  grid.innerHTML = html;
}


/* =====================================================================
   TRADE FEED
   ===================================================================== */
async function fetchTradeFeed() {
  try {
    const r = await fetch(API_BASE+'/api/trade-feed');
    const data = await r.json();
    if(data && data.length) {
      const inner = document.getElementById('feedScrollInner');
      inner.innerHTML = data.map(f => `<span class="feed-item">${f.summary} <span style="color:var(--text-muted);font-size:10px">${new Date(f.created_at+'Z').toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span></span>`).join('');
      document.getElementById('tradeFeedBar').style.display = 'flex';
    }
  } catch(e) {}
}


/* =====================================================================
   OTC SYSTEM
   ===================================================================== */
let OTC_COUNTERPARTIES = [];

async function loadOtcCounterparties() {
  if(!STATE.trader) return;
  try {
    const r = await fetch(API_BASE+'/api/traders/otc-counterparties/'+encodeURIComponent(STATE.trader.trader_name));
    const d = await r.json();
    if(d.success) OTC_COUNTERPARTIES = d.counterparties;
    refreshCptyDropdown();
  } catch(e) {}
}

function refreshCptyDropdown() {
  const sel = document.getElementById('tradeCpty');
  if(!sel) return;
  sel.innerHTML = '<option value="">None (Exchange)</option>';
  OTC_COUNTERPARTIES.forEach(c => {
    const avail = c.otc_available;
    const label = c.display_name + ' (' + c.team_name + ')' + (avail?'':' — unavailable');
    const opt = document.createElement('option');
    opt.value = c.trader_name;
    opt.textContent = label;
    opt.disabled = !avail;
    opt.style.color = avail ? '' : 'var(--text-muted)';
    sel.appendChild(opt);
  });
}

async function toggleOtcAvailable(val) {
  if(!STATE.trader) return;
  try {
    await fetch(API_BASE+'/api/traders/otc-status/'+encodeURIComponent(STATE.trader.trader_name),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({otc_available:val})
    });
    toast(val?'Now accepting OTC trades':'OTC trades disabled','success');
  } catch(e) { toast('Failed to update OTC status','error'); }
}

async function loadOtcStatus() {
  if(!STATE.trader) return;
  try {
    const r = await fetch(API_BASE+'/api/traders/otc-status/'+encodeURIComponent(STATE.trader.trader_name));
    const d = await r.json();
    const el = document.getElementById('setOtcAvailable');
    if(el && d.success) el.checked = d.otc_available;
  } catch(e) {}
}

// Venue change handler — block exchange when market closed, auto-set OTC when counterparty selected
try {
  document.getElementById('tradeVenue').addEventListener('change', function() {
    const venue = this.value;
    if(!MARKET_OPEN && venue !== 'OTC') {
      toast('Exchange is closed (' + MARKET_REASON + '). Switch to OTC or wait for market open.', 'error');
      this.value = 'OTC';
    }
  });

  document.getElementById('tradeCpty').addEventListener('change', function() {
    if(this.value) {
      document.getElementById('tradeVenue').value = 'OTC';
      document.getElementById('cptyHint').textContent = '(OTC bilateral)';
    } else {
      document.getElementById('cptyHint').textContent = '';
    }
  });
} catch(e) { console.warn('OTC listener init:', e); }


/* =====================================================================
   CHAT SYSTEM
   ===================================================================== */
let CHAT_STATE = {
  open: false,
  conversations: [],
  activeConvo: null,
  pollTimer: null
};

function toggleChat() {
  CHAT_STATE.open = !CHAT_STATE.open;
  const panel = document.getElementById('chatPanel');
  if(CHAT_STATE.open) {
    panel.classList.add('open');
    loadConversations();
    if(!CHAT_STATE.pollTimer) CHAT_STATE.pollTimer = setInterval(pollChat, 5000);
  } else {
    panel.classList.remove('open');
    if(CHAT_STATE.pollTimer) { clearInterval(CHAT_STATE.pollTimer); CHAT_STATE.pollTimer = null; }
  }
}

async function loadConversations() {
  if(!STATE.trader) return;
  try {
    // Ensure team conversation exists
    await fetch(API_BASE+'/api/chat/team-conversation/'+encodeURIComponent(STATE.trader.trader_name),{method:'POST'}).catch(()=>{});
    const r = await fetch(API_BASE+'/api/chat/conversations/'+encodeURIComponent(STATE.trader.trader_name));
    const d = await r.json();
    if(d.success) CHAT_STATE.conversations = d.conversations;
    renderConvoList();
    updateUnreadBadge();
  } catch(e) {}
}

function renderConvoList() {
  const list = document.getElementById('chatConvoList');
  if(!list) return;
  if(!CHAT_STATE.conversations.length) {
    list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;font-size:13px">No conversations yet.<br>Click + New to start one.</p>';
    return;
  }
  list.innerHTML = CHAT_STATE.conversations.map(c => {
    const isActive = CHAT_STATE.activeConvo && CHAT_STATE.activeConvo.id === c.id;
    const unread = c.unread > 0;
    let name = c.name || '';
    if(c.type === 'dm') {
      const other = c.members.find(m => m.trader_name !== STATE.trader.trader_name);
      name = other ? other.display_name : 'DM';
    }
    if(c.type === 'team') name = '🏢 ' + (c.name || 'Team');
    const icon = c.type === 'team' ? '🏢' : c.type === 'group' ? '👥' : '';
    const preview = c.last_msg ? (c.last_sender === STATE.trader.trader_name ? 'You: ' : '') + c.last_msg.substring(0,40) : 'No messages yet';
    const time = c.last_msg_time ? new Date(c.last_msg_time+'Z').toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) : '';
    return `<div class="chat-convo-item ${isActive?'active':''} ${unread?'unread':''}" onclick="openConvo(${c.id})">
      <div class="convo-avatar">${icon || name.charAt(0).toUpperCase()}</div>
      <div class="convo-info"><div class="convo-name">${name}</div><div class="convo-preview">${preview}</div></div>
      <div class="convo-meta"><span>${time}</span>${unread?`<span class="convo-unread">${c.unread}</span>`:''}</div>
    </div>`;
  }).join('');
}

function updateUnreadBadge() {
  const total = CHAT_STATE.conversations.reduce((s,c)=>s+(c.unread||0),0);
  const dot = document.getElementById('chatUnreadDot');
  if(dot) dot.style.display = total > 0 ? 'block' : 'none';
}

async function openConvo(convId) {
  const convo = CHAT_STATE.conversations.find(c=>c.id===convId);
  if(!convo) return;
  CHAT_STATE.activeConvo = convo;
  document.getElementById('chatConvoList').style.display = 'none';
  const msgView = document.getElementById('chatMsgView');
  msgView.style.display = 'flex';
  document.getElementById('chatBackBtn').style.display = 'block';
  document.getElementById('chatNewBtn').style.display = 'none';
  document.getElementById('chatRenameBtn').style.display = convo.type === 'group' ? 'block' : 'none';
  let name = convo.name;
  if(convo.type==='dm') {
    const other = convo.members.find(m=>m.trader_name!==STATE.trader.trader_name);
    name = other?other.display_name:'DM';
  }
  if(convo.type==='team') name = convo.name || 'Team Chat';
  document.getElementById('chatTitle').textContent = name;
  await loadMessages(convId);
  document.getElementById('chatInput').focus();
}

async function loadMessages(convId) {
  try {
    const r = await fetch(API_BASE+'/api/chat/messages/'+convId+'?trader='+encodeURIComponent(STATE.trader.trader_name));
    const d = await r.json();
    if(d.success) renderMessages(d.messages);
    // Mark as read
    fetch(API_BASE+'/api/chat/mark-read/'+convId+'/'+encodeURIComponent(STATE.trader.trader_name),{method:'POST'}).catch(()=>{});
    const c = CHAT_STATE.conversations.find(c=>c.id===convId);
    if(c) c.unread = 0;
    updateUnreadBadge();
  } catch(e) {}
}

function renderMessages(msgs) {
  const container = document.getElementById('chatMessages');
  container.innerHTML = msgs.map(m => {
    const isMe = m.sender === STATE.trader.trader_name;
    const time = new Date(m.created_at+'Z').toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const teamDot = m.team_color ? `<span style="width:6px;height:6px;border-radius:50%;background:${m.team_color};display:inline-block"></span>` : '';
    return `<div class="chat-msg ${isMe?'me':'other'}">
      ${!isMe?`<div class="msg-sender">${teamDot}${m.display_name}</div>`:''}
      <div class="msg-bubble">${escapeHtml(m.text)}</div>
      <div class="msg-time" style="text-align:${isMe?'right':'left'}">${time}</div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function chatSend() {
  if(!CHAT_STATE.activeConvo||!STATE.trader) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  try {
    await fetch(API_BASE+'/api/chat/send/'+CHAT_STATE.activeConvo.id,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({sender:STATE.trader.trader_name,text})
    });
    await loadMessages(CHAT_STATE.activeConvo.id);
  } catch(e) { toast('Failed to send message','error'); }
}

function chatShowList() {
  CHAT_STATE.activeConvo = null;
  document.getElementById('chatConvoList').style.display = 'block';
  document.getElementById('chatMsgView').style.display = 'none';
  document.getElementById('chatBackBtn').style.display = 'none';
  document.getElementById('chatNewBtn').style.display = 'block';
  document.getElementById('chatRenameBtn').style.display = 'none';
  document.getElementById('chatTitle').textContent = 'Messages';
  loadConversations();
}

async function chatRenameConvo() {
  if(!CHAT_STATE.activeConvo||CHAT_STATE.activeConvo.type!=='group') return;
  const current = CHAT_STATE.activeConvo.name || '';
  const newName = prompt('Rename group chat:', current);
  if(!newName || newName.trim() === current) return;
  try {
    const r = await fetch(API_BASE+'/api/chat/conversations/'+CHAT_STATE.activeConvo.id+'/rename', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({trader:STATE.trader.trader_name, name:newName.trim()})
    });
    const d = await r.json();
    if(d.success) {
      CHAT_STATE.activeConvo.name = d.name;
      document.getElementById('chatTitle').textContent = d.name;
      toast('Group renamed to "'+d.name+'"', 'success');
    } else { toast(d.error||'Rename failed','error'); }
  } catch(e) { toast('Failed to rename','error'); }
}

async function chatNewConvo() {
  if(!STATE.trader) return;
  // Make sure we're showing the list view, not the message view
  document.getElementById('chatMsgView').style.display = 'none';
  document.getElementById('chatConvoList').style.display = 'block';
  document.getElementById('chatBackBtn').style.display = 'none';
  document.getElementById('chatRenameBtn').style.display = 'none';
  CHAT_STATE.activeConvo = null;

  // Show picker: list all traders you can message
  let traders = [];
  try {
    const r = await fetch(API_BASE+'/api/leaderboard');
    const d = await r.json();
    // Leaderboard returns array of objects — handle both formats
    if(Array.isArray(d)) {
      traders = d.filter(t=>t.trader_name!==STATE.trader.trader_name);
    } else if(d.traders) {
      traders = d.traders.filter(t=>t.trader_name!==STATE.trader.trader_name);
    }
  } catch(e) { console.warn('chatNewConvo fetch error:', e); toast('Failed to load traders','error'); return; }
  if(!traders.length) { toast('No other traders to message','error'); return; }

  const list = document.getElementById('chatConvoList');
  list.innerHTML = `<div style="padding:8px"><h4 style="margin:0 0 8px;font-size:13px;color:var(--text-dim)">Start a conversation</h4>
    <div style="margin-bottom:12px"><input id="chatSearchTrader" placeholder="Search traders..." style="width:100%;padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px" oninput="filterChatTraders()"></div>
    <div id="chatTraderPicker">${traders.map(t=>{
      const teamDot = t.team?`<span style="width:8px;height:8px;border-radius:50%;background:${t.team.color||'var(--accent)'};display:inline-block"></span>`:'';
      return `<div class="chat-convo-item" onclick="startDm('${t.trader_name}')"><div class="convo-avatar">${(t.display_name||'?')[0].toUpperCase()}</div><div class="convo-info"><div class="convo-name">${teamDot} ${t.display_name}</div><div class="convo-preview">${t.firm||''}</div></div></div>`;
    }).join('')}</div>
    <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
      <h4 style="margin:0 0 8px;font-size:13px;color:var(--text-dim)">Or create a group</h4>
      <input id="chatGroupName" placeholder="Group name" style="width:100%;padding:8px;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">
      <button class="btn btn-primary btn-sm" onclick="createGroup()" style="width:100%">Create Group Chat</button>
    </div>
  </div>`;
  window._chatTraders = traders;
}

function filterChatTraders() {
  const q = (document.getElementById('chatSearchTrader').value||'').toLowerCase();
  const picker = document.getElementById('chatTraderPicker');
  if(!picker) return;
  const traders = window._chatTraders || [];
  picker.innerHTML = traders.filter(t=>(t.display_name||'').toLowerCase().includes(q)).map(t=>{
    const teamDot = t.team?`<span style="width:8px;height:8px;border-radius:50%;background:${t.team.color||'var(--accent)'};display:inline-block"></span>`:'';
    return `<div class="chat-convo-item" onclick="startDm('${t.trader_name}')"><div class="convo-avatar">${(t.display_name||'?')[0].toUpperCase()}</div><div class="convo-info"><div class="convo-name">${teamDot} ${t.display_name}</div><div class="convo-preview">${t.firm||''}</div></div></div>`;
  }).join('');
}

async function startDm(traderName) {
  try {
    const r = await fetch(API_BASE+'/api/chat/conversations',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({type:'dm',members:[traderName],creator:STATE.trader.trader_name})
    });
    const d = await r.json();
    if(d.success) {
      await loadConversations();
      openConvo(d.conversation_id);
    }
  } catch(e) { toast('Failed to create DM','error'); }
}

async function createGroup() {
  const name = (document.getElementById('chatGroupName').value||'').trim();
  if(!name) { toast('Enter a group name','error'); return; }
  // For now create with just yourself — others can be added later
  try {
    const r = await fetch(API_BASE+'/api/chat/conversations',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({type:'group',name:name,members:[],creator:STATE.trader.trader_name})
    });
    const d = await r.json();
    if(d.success) { await loadConversations(); openConvo(d.conversation_id); }
  } catch(e) { toast('Failed to create group','error'); }
}

async function pollChat() {
  if(!STATE.trader||!CHAT_STATE.open) return;
  if(CHAT_STATE.activeConvo) {
    await loadMessages(CHAT_STATE.activeConvo.id);
  }
  // Refresh unread counts
  try {
    const r = await fetch(API_BASE+'/api/chat/conversations/'+encodeURIComponent(STATE.trader.trader_name));
    const d = await r.json();
    if(d.success) {
      CHAT_STATE.conversations = d.conversations;
      updateUnreadBadge();
      if(!CHAT_STATE.activeConvo) renderConvoList();
    }
  } catch(e) {}
}

// Listen for real-time messages via socketio
if(typeof io !== 'undefined') {
  try {
    const sock = io ? io() : null;
    if(sock) {
      sock.on('new_message', function(data) {
        // If chat is open and viewing this conversation, refresh
        if(CHAT_STATE.activeConvo && CHAT_STATE.activeConvo.id === data.conversation_id) {
          loadMessages(data.conversation_id);
        } else {
          // Increment unread
          const c = CHAT_STATE.conversations.find(c=>c.id===data.conversation_id);
          if(c) { c.unread = (c.unread||0)+1; updateUnreadBadge(); renderConvoList(); }
          else { loadConversations(); }
        }
      });
      sock.on('trade_feed_update', function() { fetchTradeFeed(); });
      sock.on('trade_submitted', function(data) {
        if(data.otc && data.trader_name === (STATE.trader||{}).trader_name) {
          toast('OTC trade assigned to your book — check blotter','info');
        }
      });
    }
  } catch(e) {}
}

function initChat() {
  try {
    document.getElementById('chatTab').style.display = STATE.trader ? 'flex' : 'none';
  } catch(e) {}
  // Background unread polling even when chat is closed
  setInterval(async ()=>{
    if(!STATE.trader||CHAT_STATE.open) return;
    try {
      const r = await fetch(API_BASE+'/api/chat/conversations/'+encodeURIComponent(STATE.trader.trader_name));
      const d = await r.json();
      if(d.success) { CHAT_STATE.conversations = d.conversations; updateUnreadBadge(); }
    } catch(e){}
  }, 15000);
}


/* =====================================================================
   INIT — STARTUP
   ===================================================================== */
try {
  console.log('Energy Desk v3.5 — initializing...');
  initPrices();
  initLogos();
  checkRegistration();
  initClock();
  setInterval(tickPrices, 8000);
  setInterval(fetchLiveNews, 900000);
  setInterval(fetchTradeFeed, 60000);
  fetchTradeFeed();
  setInterval(()=>{
    if(STATE.trader&&STATE.trader.trader_name){
      fetch(API_BASE+'/api/traders/heartbeat/'+encodeURIComponent(STATE.trader.trader_name),{method:'POST'}).catch(()=>{});
    }
  }, 60000);
  renderCurrentPage();
} catch(e) { console.error('INIT error:', e); }

function postLoginInit() {
  try {
    loadOtcCounterparties();
    loadOtcStatus();
    initChat();
    document.getElementById('chatTab').style.display = 'flex';
    document.getElementById('tradeFeedBar').style.display = 'flex';
  } catch(e) { console.warn('postLoginInit error:', e); }
}

</script>
<!-- END OF MESSAGE 1 — Crude, Power, Freight, Blotter, Risk, Leaderboard pages will be appended in subsequent messages -->
</body>
</html>
